<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Artjom Kurapov blog</title>
<meta name="keywords" content="">
<meta name="description" content="понедельник, 19 января 2015 г. в 16:37:51
Vagrant это программка управляющая виртуальными машинами, бегающих на VirtualBox. В веб-разработке виртуалки очень полезны тем что среду разработки и весь стэк необходимых системных сервисов можно изолировать для каждого проекта.
Это позволяет избегать проблем с конфликтом версий какой-нибудь OpenSSL библиотеки между разными приложениями. Разработчикам психологически становиться понятней, что именно проект требует. Записывать процесс установки становиться обязательным, зато запуск проекта автоматизируется и сделав раз, новому человеку настроить работу проекта становиться очень легко. Если в среде что-то добавляется или обновляется, то devopsы могут отследить это, ведь файл настроек (Vagrantfile) и файл установки (т.н. provisioning ) хранятся вместе с проектом в системе версионирования">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/rus/tech/server/vagrant/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/rus/tech/server/vagrant/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Artjom Kurapov blog (Alt + H)">Artjom Kurapov blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      
    </h1>
    <div class="post-meta">

</div>
  </header> 
  <div class="post-content"><p>понедельник, 19 января 2015 г. в 16:37:51</p>
<p><a href="https://docs.vagrantup.com/v2/getting-started/index.html">Vagrant</a> это программка управляющая виртуальными машинами, бегающих на VirtualBox. В веб-разработке виртуалки очень полезны тем что среду разработки и весь стэк необходимых системных сервисов можно изолировать для каждого проекта.</p>
<p>Это позволяет избегать проблем с конфликтом версий какой-нибудь OpenSSL библиотеки между разными приложениями. Разработчикам психологически становиться понятней, что именно проект требует. Записывать процесс установки становиться обязательным, зато запуск проекта автоматизируется и сделав раз, новому человеку настроить работу проекта становиться очень легко. Если в среде что-то добавляется или обновляется, то devopsы могут отследить это, ведь файл настроек (Vagrantfile) и файл установки (т.н. <a href="https://docs.vagrantup.com/v2/provisioning/shell.html">provisioning</a> ) хранятся вместе с проектом в системе версионирования</p>
<h3 id="комманды">Комманды<a hidden class="anchor" aria-hidden="true" href="#комманды">#</a></h3>
<p><strong>vagrant box add</strong> MyCentOS <a href="http://puppet-vagrant-boxes.puppetlabs.com/centos-65-x64-virtualbox-puppet.box">http://puppet-vagrant-boxes.puppetlabs.com/centos-65-x64-virtualbox-puppet.box</a> — скачивает <a href="http://www.vagrantbox.es/">основу виртуальной машинки</a>, кеширует и обзывает её как вы скажете<br>
<strong>vagrant init</strong> MyCentOS — генерит файл настроек для проекта, где указываются порты, путь к скрипту установки, общие папки…<br>
<strong>vagrant up</strong> — стартует виртуальную машину и применяет настройки<br>
<strong>vagrant ssh</strong> — логинится в работающую ОСь<br>
vagrant halt — останавливает, полезно если хочется сберечь ресурсы и надо проектом не работаете<br>
vagrant destroy — удаляет ОСь, но скачанная основа остаётся. Полезно когда вы пишете пишете скрипт для установки и что-то сделали не так, а откатиться не получается</p>
<h3 id="vagrantfile">Vagrantfile<a hidden class="anchor" aria-hidden="true" href="#vagrantfile">#</a></h3>
<p>Для поднятия LAMP-проекта я использовал CentOS как вы видите выше</p>
<p>В конфиге самое главное это</p>
<ul>
<li>путь к скрипту установки</li>
<li>перенаправление портов для nginx и mysql</li>
<li>шаринг папок из самого проекта для nginx с предоставлением возможности записи</li>
</ul>
<pre tabindex="0"><code>config.vm.provision &#34;shell&#34;, path: &#34;scripts/vagrant_provision.sh&#34; 
config.vm.synced_folder &#34;.&#34;, &#34;/var/www/html/&#34;, :mount_options =&gt; [&#34;dmode=777&#34;,&#34;fmode=666&#34;]

config.vm.network :forwarded_port, guest: 80, host: 8080
config.vm.network :forwarded_port, guest: 443, host: 8443
config.vm.network :forwarded_port, guest: 3306, host: 3306

config.vm.provider &#34;virtualbox&#34; do |v|
  v.memory = 1024
  v.cpus = 2
end
</code></pre><h3 id="provisioning">Provisioning<a hidden class="anchor" aria-hidden="true" href="#provisioning">#</a></h3>
<p>Shell-скрипт установки использует специальный репозиторий для php-билдов под centos - webtactic. Mysql приходится заменять на более новую версию. Кроме того я перезаписываю конфиг для nginx. Заметьте флаг yum -y, который позволяет избежать интерактивного режима в установке. Мне также пришлось вручную генерировать SSL сертификаты и их устанавливать (но это я опустил тут), т.к. там интерактивного режима избежать не удалось.</p>
<p>Заметьте также что host-ОСь не любит перезаписывать порты меньше 1024, поэтому форвардинг приходится делать через 8k порты + ipfw правила.</p>
<p>Также, скрипт установки имеет смысл группировать по сервисам. Точечную настройку конфиг-файлов имеет смысл заменять с помощью sed&rsquo;а, либо заготавливать целиком и заменять.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo rpm -Uvh https://mirror.webtatic.com/yum/el6/latest.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#php, extensions</span>
</span></span><span style="display:flex;"><span>sudo rpm -Uvh https://mirror.webtatic.com/yum/el6/latest.rpm
</span></span><span style="display:flex;"><span>yum install -y php55w php55w-cli php55w-opcache php55w-fpm php55w-gd php55w-mbstring php55w-mysql php-memcached php55w-pdo php55w-pecl-xdebug php55w-pecl-memcache php55w-xml php55w-pecl-imagick
</span></span><span style="display:flex;"><span>sudo sed -i <span style="color:#e6db74">&#39;s/upload_max_filesize = 2M/upload_max_filesize = 8M/g&#39;</span> /etc/php.ini
</span></span><span style="display:flex;"><span>sudo service php-fpm start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#php - mongo extension</span>
</span></span><span style="display:flex;"><span>sudo yum install -y php55w-devel
</span></span><span style="display:flex;"><span>sudo pecl channel-update pecl.php.net
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;\n&#34;</span> | pecl install mongo
</span></span><span style="display:flex;"><span>sudo touch /etc/php.d/mongo.ini
</span></span><span style="display:flex;"><span>sudo chown vagrant /etc/php.d/mongo.ini
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;extension=mongo.so&#34;</span> &gt; /etc/php.d/mongo.ini
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#php - composer</span>
</span></span><span style="display:flex;"><span>curl -sS https://getcomposer.org/installer | php
</span></span><span style="display:flex;"><span>sudo ln -s /home/vagrant/composer.phar /usr/bin/composer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#php - phpunit</span>
</span></span><span style="display:flex;"><span>wget https://phar.phpunit.de/phpunit.phar
</span></span><span style="display:flex;"><span>chmod +x phpunit.phar
</span></span><span style="display:flex;"><span>sudo mv phpunit.phar /usr/bin/phpunit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Nginx</span>
</span></span><span style="display:flex;"><span>sudo cp /var/www/html/scripts/vagrant/nginx.conf /etc/nginx/nginx.conf
</span></span><span style="display:flex;"><span>sudo service nginx start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#MySQL</span>
</span></span><span style="display:flex;"><span>yum install -y yum-plugin-replace
</span></span><span style="display:flex;"><span>yum replace -y mysql-libs --replace-with mysql55w-libs
</span></span><span style="display:flex;"><span>yum install -y nginx mysql55w-server
</span></span><span style="display:flex;"><span>sudo service mysqld start
</span></span><span style="display:flex;"><span>mysql -u root -e <span style="color:#e6db74">&#34;GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;%&#39; IDENTIFIED BY &#39;root&#39; WITH GRANT OPTION; FLUSH PRIVILEGES;&#34;</span>
</span></span><span style="display:flex;"><span>sudo service mysqld restart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#MongoDB</span>
</span></span><span style="display:flex;"><span>sudo yum-config-manager --add-repo<span style="color:#f92672">=</span>http://downloads-distro.mongodb.org/repo/redhat/os/x86_64
</span></span><span style="display:flex;"><span>yum install --nogpgcheck -y mongo-10gen mongo-10gen-server mongo-10gen-shell
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;db.createCollection(&#34;myCustomCollection&#34;);&#39;</span> &gt; mongoInit.js
</span></span><span style="display:flex;"><span>mongo MyMongoDB mongoInit.js
</span></span><span style="display:flex;"><span>sudo mkdir /data
</span></span><span style="display:flex;"><span>sudo mkdir /data/db
</span></span><span style="display:flex;"><span>sudo mongod --profile<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> --slowms<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> --smallfiles &amp; &amp; sleep <span style="color:#ae81ff">3</span> <span style="color:#f92672">&amp;&amp;</span> mongo MyMongoDB mongoInit.js
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Nodejs, java required for some packages</span>
</span></span><span style="display:flex;"><span>sudo yum install -y java-1.7.0-openjdk
</span></span><span style="display:flex;"><span>curl https://raw.githubusercontent.com/creationix/nvm/v0.23.3/install.sh | bash
</span></span><span style="display:flex;"><span>export NVM_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$HOME<span style="color:#e6db74">/.nvm&#34;</span>
</span></span><span style="display:flex;"><span>source $HOME/.nvm/nvm.sh
</span></span><span style="display:flex;"><span>nvm install 0.10
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;. ~/.nvm/nvm.sh&#34;</span> &gt;&gt; .bash_profile
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;nvm use 0.10&#34;</span> &gt;&gt; ~/.bash_profile
</span></span><span style="display:flex;"><span>npm install forever -g
</span></span><span style="display:flex;"><span>npm install phantomjs -g
</span></span><span style="display:flex;"><span>npm install grunt-cli -g
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ffmpeg 0.6.5</span>
</span></span><span style="display:flex;"><span>rpm --import http://packages.atrpms.net/RPM-GPG-KEY.atrpms
</span></span><span style="display:flex;"><span>sudo rpm -ivh http://dl.atrpms.net/all/atrpms-repo-6-7.el6.x86_64.rpm
</span></span><span style="display:flex;"><span>sudo yum install -y epel-release ffmpeg ffmpeg-devel
</span></span><span style="display:flex;"><span>sudo chown vagrant /etc/ld.so.conf
</span></span><span style="display:flex;"><span>sudo echo <span style="color:#e6db74">&#34;/usr/lib&#34;</span> &gt;&gt; /etc/ld.so.conf
</span></span><span style="display:flex;"><span>sudo echo <span style="color:#e6db74">&#34;/usr/local/lib&#34;</span> &gt;&gt; /etc/ld.so.conf
</span></span><span style="display:flex;"><span>sudo ldconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>php -f /var/www/html/install.php
</span></span><span style="display:flex;"><span>grunt build
</span></span><span style="display:flex;"><span>phpunit -c phpunit.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ON HOST MACHINE - CONNECT PORTS (optional)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#sudo ipfw add 100 fwd 127.0.0.1,8080 tcp from any to me 80</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#sudo ipfw add 101 fwd 127.0.0.1,8443 tcp from any to me 443</span>
</span></span></code></pre></div><p>Установку с bash можно заменить на puppet или chef.</p>
<h3 id="снапшоты">Снапшоты<a hidden class="anchor" aria-hidden="true" href="#снапшоты">#</a></h3>
<p>С помощью <a href="https://github.com/dergachev/vagrant-vbox-snapshot">плагина</a>, можно зафиксировать установленную версию, что-бы каждый раз не качать нужные зависимости.</p>
<pre tabindex="0"><code>vagrant plugin install vagrant-vbox-snapshot
vagrant snapshot take MyCentOS freshInstallation
vagrant snapshot go MyCentOS freshInstallation
</code></pre><p>Если вы часто обновляете виртуалку, тогда имеет смысл файл установки структурировать так, что-бы часто меняющиеся области были внизу, а снапшоты соответсвовали бы глубине изменения этого файла. Например если nginx/mysql/mongo вы не меняете, а расширения для php и его версии меняете часто, то у вас будут снапшоты без пхп и с ним, потому что установка некоторых пакетов может достигать 15 минут и выше.</p>
<p>Второй вариант - первыми ставить наиболее критичные сервисы и запускать проект как можно быстрее, а потом доустанавливать остальное. В моём случае например, приложение может работать без mongodb куда складируются логи и без ffmpeg, который используется в редких случаях</p>
<p>Если вам понравился <a href="https://www.vagrantup.com/">Vagrant</a>, гляньте на <a href="https://www.docker.com/">Docker</a> — он изолирует сервисы ещё лучше.</p>
<p><a href="https://puphpet.com/">PuPHPet</a> — интересный сервис по упрощению настройки вашей виртуалки</p>
<p>См. также</p>
<ul>
<li><a href="http://www.todaysoftmag.com/article/749/getting-started-with-vagrant">Getting started with Vagrant</a></li>
<li><a href="http://freetonik.com/blog/all/vagrant/">Настройка Vagrant для удобной разработки</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Artjom Kurapov blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
