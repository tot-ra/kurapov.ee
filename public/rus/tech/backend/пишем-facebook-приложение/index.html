<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Artjom Kurapov blog</title>
<meta name="keywords" content="">
<meta name="description" content="вторник, 14 июля 2009 г. в 10:31:19
Facebook - популярная социальная сеть где можно написать своё приложение. Не люблю толочь воду в ступе, поэтому сразу к делу. Встраивать можно двумя направлениями: внешнее приложение в Facebook или Facebook-данные во внешнее приложение (aka Facebook Connect). Тут я буду говорить о первом, что в принципе более трудоёмко и интересно. Как правило смысл facebook-приложение несёт две функциональности - взаимодействие с друзьями и информативное интегрирование в профиль пользователя.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/rus/tech/backend/%D0%BF%D0%B8%D1%88%D0%B5%D0%BC-facebook-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/rus/tech/backend/%D0%BF%D0%B8%D1%88%D0%B5%D0%BC-facebook-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Artjom Kurapov blog (Alt + H)">Artjom Kurapov blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      
    </h1>
    <div class="post-meta">

</div>
  </header> 
  <div class="post-content"><p>вторник, 14 июля 2009 г. в 10:31:19</p>
<p>Facebook - популярная социальная сеть где можно написать своё приложение. Не люблю толочь воду в ступе, поэтому сразу к делу. Встраивать можно двумя <em>направлениями</em>: внешнее приложение в Facebook или Facebook-данные во внешнее приложение (aka <a href="http://wiki.developers.facebook.com/index.php/Anatomy_of_a_Facebook_Connect_Site">Facebook Connect</a>). Тут я буду говорить о первом, что в принципе более трудоёмко и интересно. Как правило смысл facebook-приложение несёт две функциональности - взаимодействие с друзьями и информативное интегрирование в профиль пользователя.</p>
<h3 id="основы">Основы<a hidden class="anchor" aria-hidden="true" href="#основы">#</a></h3>
<p>Встраивать приложение можно в следующие <strong>места</strong>..</p>
<ul>
<li>Canvas - собственно страница с приложением. Доступна по ссылке <a href="http://apps.facebook.com/">http://apps.facebook.com/</a>НАЗВАНИЕ_ПРОГРАММЫ/</li>
<li>Profile box - маленький бокс внутри самого профиля пользователя</li>
<li>Profile tab - новый таб в профиле</li>
<li>Boxes tab - небольшой блок в табе boxes</li>
<li>News feed - доступ к потоку обновлений</li>
<li>Requests box - интерактивные сообщения другим пользователям</li>
</ul>
<p>Интеграция производится смешанными <strong>возможностями</strong>..</p>
<ul>
<li>REST API (<a href="http://api.new.facebook.com/restserver.php">http://api.new.facebook.com/restserver.php</a>) который даёт &ldquo;тяжёлый&rdquo; доступ для backend-а с возможностями загрузки фото, видео, получении списков друзей, событий, комментариев и тп.</li>
<li><a href="http://wiki.developers.facebook.com/index.php/FQL">FQL</a> - способ запрашивать данные по REST не просто через параметры метода, а уже через SQL-подобный синтаксис</li>
<li><a href="http://wiki.developers.facebook.com/index.php/FBML">FBML</a> - урезанный HTML + свои тэги которые Facebook интерпретирует в окне в своём стиле и дизайне и кэширует при инлайновом показе. Куча заморочек с встроенным валидатором тэгов</li>
<li>xFBML - FBML-тэги используемые в своём приложении</li>
<li>FBJS - урезанный JS</li>
</ul>
<h3 id="два-пути">Два пути<a hidden class="anchor" aria-hidden="true" href="#два-пути">#</a></h3>
<p>Теперь когда основные термины понятны перейдём к самому приложению которое размещается в Canvas. После создания нового приложения через <a href="http://www.facebook.com/developers/">developer app</a>, скачивания <a href="http://svn.facebook.com/svnroot/platform/clients/packages/facebook-platform.tar.gz">REST-библиотеки</a> для php, выкладывании приложения на свой сайт и установки в настройках URL для Canvas становится видно что доступно два способа запуска - через <strong>iframe</strong> (+XFBML) либо <strong>чистый FBML</strong> который будет храниться на facebook. Понятное дело первый вариант самый простой. После создания программы и добавления/подтверждения в своём профиле, показ Canvas&rsquo;а будет сопровождаться обычным iframe + GET-параметрами с префиксом fb_sig_, из которых самый важный это fb_sig_canvas_user. Второй вариант более муторный, но более тесно связан с FB.</p>
<p><img loading="lazy" src="img/Pasted%20image%2020241019195732.png" alt=""  />
</p>
<h3 id="права">Права<a hidden class="anchor" aria-hidden="true" href="#права">#</a></h3>
<p>Теперь надо подумать о том что приложение делает в принципе. В моём случае это quiz-тест - пользователь отвечает на вопросы и в конце статус ставится на стенку в профиль (profile wall).</p>
<p>Первым делом оказывается что очень полезно иметь подтверждение пользователя для получения данных (<a href="http://wiki.developers.facebook.com/index.php/Authorizing_Applications">Authorization</a>) которое вызывается методом Facebook::require_login и для пользователя выглядит просто как окошко передачи прав. Покопавшись в документации для публикации данных в Wall (News feed), есть метод <a href="http://wiki.developers.facebook.com/index.php/Feed.publishTemplatizedAction">Feed.publishTemplatizedAction</a>, но оказалось что он устаревший (deprecated). Альтернатива - <a href="http://wiki.developers.facebook.com/index.php/Stream.publish">Stream.publish</a>, и теперь переходим ко второй важной теме - расширенные права (<a href="http://wiki.developers.facebook.com/index.php/Extended_permissions">Extended permissions</a>).</p>
<p><img loading="lazy" src="img/Pasted%20image%2020241019195746.png" alt=""  />
</p>
<p>Без прав запрос получит просто фатальную ошибку. Для того что-бы программа получала более глубокий доступ над профилем пользователя, последний должен подтвердить это отдельно в диалоговом окне. А вызвать этот диалог что-бы запостить на стенку сообщение или изменить статус пользователя - не так то просто.</p>
<pre tabindex="0"><code>$facebook-&gt;api_client-&gt;stream_publish(&#34;My new status&#34;);
Uncaught exception &#39;FacebookRestClientException&#39; with message &#39;The user hasn&#39;t authorized the application to perform this action&#39; i
</code></pre><p>Теперь немного тонкостей - документацию в wiki и на форумах надо читать с большим подозрением, потому что часто встречается устаревший код (к примеру названия привилегий/методов stream_publish вместо publish_stream). Методы на проверку привилегий выдают либо фатальную ошибку либо невразумительную отписку на параметры, в том числе и тестовая <a href="http://developers.facebook.com/tools.php?api">API console</a></p>
<pre tabindex="0"><code>if($facebook-&gt;api_client-&gt;users_hasAppPermission(&#34;publish_stream&#34;)){
//обновить статус тут
}
</code></pre><h4 id="fbml-соблазн">FBML-соблазн<a hidden class="anchor" aria-hidden="true" href="#fbml-соблазн">#</a></h4>
<p>К этому времени становятся понятными плюсы FBML-режима (принуждение к похожему интерфейсу и поддерживаемые FBML-тэги). У меня таки сработали</p>
<ul>
<li>FBML mode + onclick + тэг<code>&lt;fb:prompt-permission perms=&quot;stream_publish&quot;&gt;Heelp&lt;/fb:prompt-permission&gt;</code></li>
<li>FBML mode + <!-- raw HTML omitted --> + onclick
<img loading="lazy" src="img/Pasted%20image%2020241019195805.png" alt=""  />
</li>
</ul>
<p>Iframe + редирект на <a href="http://www.facebook.com/authorize.php?api_key=">http://www.facebook.com/authorize.php?api_key=</a>МОЙ_API_KEY&amp;v=1.0&amp;ext_perm=publish_stream&amp;next=http://google.com</p>
<p>Хотя и очень глючно выглядит:</p>
<p><img loading="lazy" src="img/Pasted%20image%2020241019195819.png" alt=""  />
</p>
<ul>
<li>FBML mode + redirect выдали &ldquo;Error while loading page&rdquo; сообщение</li>
</ul>
<h3 id="xfbml">xFBML<a hidden class="anchor" aria-hidden="true" href="#xfbml">#</a></h3>
<p>Понятно что права получать через iframe таким образом глючно, хочется одновременно и вместе и порознь с фейсбуком жить. Для этого есть xFBML-тэги которые интерпретируются фейсбуковским яваскриптом. Итого надо в своём приложении надо:</p>
<ol>
<li>Подключить яваскрипт <a href="http://static.ak.connect.facebook.com/js/api_lib/v0.4/FeatureLoader.js.php">http://static.ak.connect.facebook.com/js/api_lib/v0.4/FeatureLoader.js.php</a></li>
<li>Сделать <a href="http://wiki.developers.facebook.com/index.php/XFBML">xd_receiver.htm</a></li>
<li>Инициализировать своим апи-ключём</li>
<li>Указать путь к корню в настройках Connect-приложения в фейсбуке</li>
</ol>
<p>Теперь уже права можно спрашивать</p>
<pre tabindex="0"><code>FB.Connect.showPermissionDialog(&#39;publish_stream&#39;);
</code></pre><p><img loading="lazy" src="img/Pasted%20image%2020241019195840.png" alt=""  />
</p>
<h3 id="затерянное-печенько-ослика">Затерянное печенько ослика<a hidden class="anchor" aria-hidden="true" href="#затерянное-печенько-ослика">#</a></h3>
<p>Нельзя обойти не упомянув об IE 6/7 и тут. Дело в том что по умолчанию iframe в этих браузерах теряет переменные сессии. Проще говоря - печеньки (cookies) не доходят до сервера, потому что iframe считается &ldquo;неблагонадёжным&rdquo; содержанием и он даже показывает глазик в своём статус-баре. Если <a href="http://stackoverflow.com/questions/389456/cookie-blocked-not-saved-in-iframe-in-internet-explorer">подробно</a> в этом разбираться то для этого есть обоснование в виде <a href="http://www.w3.org/TR/P3P/#guiding_principles">W3C platform for privacy preferences</a>. Для этого проще добавить заголовок</p>
<pre tabindex="0"><code>header(&#39;P3P: CP=&#34;IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT&#34;&#39;);  //for IE6/7
</code></pre><p>В конце концов приложение успешно обновило профиль (куда удалось впихнуть и картинку через аттачмент)</p>
<p><img loading="lazy" src="img/Pasted%20image%2020241019195852.png" alt=""  />
</p>
<h3 id="редирект-хаоса">Редирект хаоса<a hidden class="anchor" aria-hidden="true" href="#редирект-хаоса">#</a></h3>
<p>Любой тестер свихнулся бы увидя странный мандельбаг с отсутсвием прав на постинг в wall. Вторая меньшая проблема проявлялась в хаотичном выпрыгивании приложения из iframe в большое окно. Как <a href="http://stackoverflow.com/questions/595059/facebook-app-iframe-worries-url-problem">оказалось</a>, фейсбук в разных браузерах странным образом интерпретирует переход по ссылкам и внутренним редиректам. Для этого специально нашёлся метод facebook-&gt;require_frame до логина, который привязал в обязательном порядке страницу с фреймом фейсбука. Впрочем внутри между переходами страниц всё-равно засел login.php</p>
<p>По теме:</p>
<ul>
<li>Более <a href="http://blog.cmsdevelopment.com/0000414/">тягучее введение</a> от Димы Шейко</li>
<li>Некоторые заметки от <a href="http://cr-it.livejournal.com/6764.html">cr_it</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Artjom Kurapov blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
