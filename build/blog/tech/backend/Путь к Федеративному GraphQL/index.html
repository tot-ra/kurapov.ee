<!doctype html><html lang=ru dir=ltr class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>Путь к Федеративному GraphQL | Артём Курапов</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:image content=https://kurapov.ee/img/docusaurus-social-card.jpg><meta data-rh=true name=twitter:image content=https://kurapov.ee/img/docusaurus-social-card.jpg><meta data-rh=true property=og:url content="https://kurapov.ee/blog/tech/backend/Путь к Федеративному GraphQL"><meta data-rh=true property=og:locale content=ru><meta data-rh=true name=docusaurus_locale content=ru><meta data-rh=true name=docusaurus_tag content=default><meta data-rh=true name=docsearch:language content=ru><meta data-rh=true name=docsearch:docusaurus_tag content=default><meta data-rh=true property=og:title content="Путь к Федеративному GraphQL | Артём Курапов"><meta data-rh=true name=description content="Картинка с dgraph.io"><meta data-rh=true property=og:description content="Картинка с dgraph.io"><meta data-rh=true property=og:type content=article><meta data-rh=true property=article:published_time content=2020-09-09T10:00:00.000Z><meta data-rh=true property=article:tag content=backend><link data-rh=true rel=icon href=/img/favicon/favicon.ico><link data-rh=true rel=canonical href="https://kurapov.ee/blog/tech/backend/Путь к Федеративному GraphQL"><link data-rh=true rel=alternate href="https://kurapov.ee/blog/tech/backend/Путь к Федеративному GraphQL" hreflang=ru><link data-rh=true rel=alternate href="https://kurapov.ee/blog/tech/backend/Путь к Федеративному GraphQL" hreflang=x-default><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@id":"https://kurapov.ee/blog/tech/backend/Путь к Федеративному GraphQL","@type":"BlogPosting","author":[],"datePublished":"2020-09-09T10:00:00.000Z","description":"Картинка с dgraph.io","headline":"Путь к Федеративному GraphQL","isPartOf":{"@id":"https://kurapov.ee/blog","@type":"Blog","name":"Blog"},"keywords":[],"mainEntityOfPage":"https://kurapov.ee/blog/tech/backend/Путь к Федеративному GraphQL","name":"Путь к Федеративному GraphQL","url":"https://kurapov.ee/blog/tech/backend/Путь к Федеративному GraphQL"}</script><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="Артём Курапов RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="Артём Курапов Atom Feed"><link rel=stylesheet href=/assets/css/styles.d5d08b3f.css><script src=/assets/js/runtime~main.609835b6.js defer></script><script src=/assets/js/main.973485c9.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Перейти к основному содержимому"><a class=skipToContent_aCxL href=#__docusaurus_skipToContent_fallback>Перейти к основному содержимому</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Переключить навигационную панель" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/artjom.jpg alt="Artjom Kurapov" class="themedComponent_cfDz themedComponent--light_Kj2W"><img src=/img/artjom.jpg alt="Artjom Kurapov" class="themedComponent_cfDz themedComponent--dark__Nfe"></div><b class="navbar__title text--truncate">Артём Курапов</b></a><a class="navbar__item navbar__link" href="/docs/Об авторе">Об авторе</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/blog>Блог</a></div><div class="navbar__items navbar__items--right"><a href=https://github.com/tot-ra/kurapov.ee target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><div class="toggle_LxwK colorModeToggle_c2rS"><button class="clean-btn toggleButton_gSiH toggleButtonDisabled_GY0v" type=button disabled title="Переключение между темным и светлым режимом (сейчас используется Светлый режим)" aria-label="Переключение между темным и светлым режимом (сейчас используется Светлый режим)" aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_WH3Q><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_OWtW><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_vXry></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_jkFy"><div class="container margin-vert--lg"><div class=row><aside class="col col--3"><nav class="sidebar_aM6_ thin-scrollbar" aria-label="Навигация по последним постам в блоге"><div class="sidebarItemTitle_Dvxs margin-bottom--md">Последние заметки</div><div role=group><h3 class=yearGroupHeading_ZKt1>2025</h3><ul class="sidebarItemList_X9hj clean-list"><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/вера/От чего спасает Христос">вера/От чего спасает Христос</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2025/05/07/события/ AWS Gen AI meetup"> AWS Gen AI meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2025/04/29/события/ AGI - Beyond the Hype Before the Storm">AGI: Beyond the Hype, Before the Storm</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2025/04/28/события/ Decentralized AI event"> Decentralized AI event</a></ul></div><div role=group><h3 class=yearGroupHeading_ZKt1>2024</h3><ul class="sidebarItemList_X9hj clean-list"><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/12/13/события/ Tallinn AI meetup"> Tallinn AI meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/11/26/события/ AI meetup notes"> AI meetup notes</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href=/blog/2024/11/14/события/AI-ED-Webinar>Andmete ja tehisintellekti olulisusest personaliseerituma õppe poole liikumisel by Innar Liiv</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/кино/The Wild Robot">кино/The Wild Robot</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href='/blog/управление/Product team models - project based, "feature factory" and product operating model'>Product team models - project based, feature factory and product operating model</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/tech/devices/Моя коллекция часов в 2024">Моя коллекция часов в 2024</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/tech/soft/Как записывать экран с круглой камерой">Как записывать экран с круглой камерой</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href=/blog/2024/10/18/события/AsuurKeraamika>Asuur Keraamika</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href=/blog/tech/backend/gpu/CUDA>CUDA</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/10/12/события/Katana meetup">Katana meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/10/04/события/Pipedrive meetup">Pipedrive meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/10/01/события/Digit 2024 Tartu">Digit Tartu conference 2024</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/09/25/события/TallinnJS meetup">Tallinn JS meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/05/24/события/Latitude 59">Latitude 59</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/управление/hiring/Homework sandboxes">Sandboxes for homework assignments</a></ul></div><div role=group><h3 class=yearGroupHeading_ZKt1>2022</h3><ul class="sidebarItemList_X9hj clean-list"><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/психология/Об этике пчеловодства">Об этике пчеловодства</a></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class=title_Y5lg>Путь к Федеративному GraphQL</h1><div class="container__LhH margin-vert--md"><time datetime=2020-09-09T10:00:00.000Z>9 сентября 2020 г.</time> · <!-- -->14 мин. чтения</div></header><div id=__blog-post-container class=markdown><p><img decoding=async loading=lazy src=/assets/images/e28dc66e8bb64f31576418ef1b102685-d28033219b614b9e24f66c8824864013.png width=1400 height=767 class=img_sJtY></p>
<p>Картинка с dgraph.io</p>
<p>Программисты любят хорошие истории, поэтому надеюсь что пятилетний путь к композитному API с помощью GraphQL в боевой среде (на пике выдающей 110 запросов в секунду при 100мс задержке) будет интересен.</p>
<p>[Если вы спешите, проскрольте ниже к <em>урокам</em> и гляньте на открытый код <a href=https://github.com/pipedrive/graphql-schema-registry target=_blank rel="noopener noreferrer">graphql-schema-registry</a>]</p>
<p><img decoding=async loading=lazy src=/assets/images/c0651522464466d29683331192513234-0d6725afcb058e05cf879c4af95bb1dc.png width=1400 height=726 class=img_sJtY></p>
<p>schema registry с примером тестовой схемы</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=задача>Задача<a href=#задача class=hash-link aria-label="Прямая ссылка на Задача" title="Прямая ссылка на Задача">​</a></h2>
<p>Годами, <a href=https://www.pipedrive.com/ target=_blank rel="noopener noreferrer">Pipedrive</a> (которому в начале 2020 стукнуло уже 10 лет), давал публичный <a href=https://developers.pipedrive.com/docs/api/v1/ target=_blank rel="noopener noreferrer">REST API</a> где были и недокументированные пути для нашего веб приложения. Один из них /users/self, который изначально задумывался для загрузки информации о пользователе, нормально с течением времени стал грузить все что надо для первой загрузки страницы, доходя до 30 разных типов сущностей. Сам он выдавался PHP монолитом, который по натуре синхронный. Мы <a href=https://medium.com/pipedrive-engineering/how-two-developers-accelerated-php-monolith-in-pipedrive-df8a18bc2d8a target=_blank rel="noopener noreferrer">пытались его распараллелить</a>, но неудачно.
<img decoding=async loading=lazy src=/assets/images/2f8932407cb9eab3eed55e354353c688-c614b3189765bdaf3f9679fef3bcd6f7.png width=1000 height=273 class=img_sJtY>
/users/self распределение задержки для оставшегося траффика</p>
<p>С точки зрения поддержки, каждое новое изменение все больше усложняло код и никто не хотел владеть этой огромной функцией.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=прототип-с-прямым-доступом-к-бд>Прототип с прямым доступом к БД<a href=#прототип-с-прямым-доступом-к-бд class=hash-link aria-label="Прямая ссылка на Прототип с прямым доступом к БД" title="Прямая ссылка на Прототип с прямым доступом к БД">​</a></h2>
<p>Давайте вернемся назад в прошлое, когда наши разработчики стали экспериментировать с graphql.</p>
<p>Года 3-4 назад, в команде разработки <a href=https://marketplace.pipedrive.com/ target=_blank rel="noopener noreferrer">рынка приложений</a>, я услышал от <a href=https://twitter.com/bashmach target=_blank rel="noopener noreferrer">Паши</a>, нашего фулл-стек разработчика новенькие для меня термины - <a href=https://elixir-lang.org/ target=_blank rel="noopener noreferrer">elixir</a> и graphql. Он участвовал в тестовом проекте в котором напрямую работал с MySQL и выдавал основные сущности Pipedrive по /graphql.</p>
<p>На локальной машине работало прекрасно, но это не масштабировалось на весь код, потому что функционал - не обычный CRUD, а весь монолит переписывать никто не хотел.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=прототип-со-склейкой>Прототип со склейкой<a href=#прототип-со-склейкой class=hash-link aria-label="Прямая ссылка на Прототип со склейкой" title="Прямая ссылка на Прототип со склейкой">​</a></h2>
<p>Переносимся в 2019, когда я заметил еще один тестовый репозиторий от другого коллеги, который стал использовать GraphQL stitching с определением сущностей с помощью <a href=https://github.com/graphql-compose/graphql-compose target=_blank rel="noopener noreferrer">graphql-compose</a> и резолверами которые делали запрос уже к нашему REST API. Как можете представить, это уже было значительным улучшением, потому что нам не надо было переопределять всю бизнес-логику и graphql становился просто приятной оберткой.</p>
<p>Из недостатков этого решения:</p>
<ul>
<li>
<p><strong>Производительность</strong>. Небыло <a href=https://github.com/graphql/dataloader target=_blank rel="noopener noreferrer">dataloader</a>'а, поэтому был риск N+1 сетевых запросов. Небыло ограничения сложности запроса и какого-либо промежуточного кеширования.</p>
</li>
<li>
<p><strong>Управление схемой</strong>. При склейке типов, мы определяли все сущности в одном репозитории, отдельно от самих сервисов которые этими даннами владеют. Это усложняло деплой - приходилось бы писать обратно-совместимые изменения, что-бы избегать несовпадения схемы и функций.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=подготовка>Подготовка<a href=#подготовка class=hash-link aria-label="Прямая ссылка на Подготовка" title="Прямая ссылка на Подготовка">​</a></h2>
<p>В Октябре 2019, я стал готовиться к <a href="https://www.youtube.com/watch?v=ekKp-tA0A9k" target=_blank rel="noopener noreferrer">миссии</a>, которая превратила бы прошлое решение в рабочее с помощью Apollo федерации, которая <a href=https://www.apollographql.com/blog/apollo-federation-f260cf525d21/ target=_blank rel="noopener noreferrer">вышла чуть ранее</a> в этом же году. Кроме того, результат приземлился бы в команде <em>Core</em>, которая стала бы поддерживать его в долгосрочной перспективе.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=сбор-ожиданий-разработчиков>Сбор ожиданий разработчиков<a href=#сбор-ожиданий-разработчиков class=hash-link aria-label="Прямая ссылка на Сбор ожиданий разработчиков" title="Прямая ссылка на Сбор ожиданий разработчиков">​</a></h2>
<p>В компании некоторые разработчики были довольно скептичны и предлагали построить свое решение просто склеивая запросы воедино, отправляя по POST и надеясь на свой gateway который будет распараллеливать обработку.</p>
<p>Другие считали что graphql еще слишком сырой что-бы использовать в жизни и лучше подождать. Третьи предлагали рассмотреть альтернативы, типа Protobuf и Thrift, а в качестве транспорта рассмотреть <a href=https://grpc.io/ target=_blank rel="noopener noreferrer">GRPC</a>, <a href=https://www.odata.org/ target=_blank rel="noopener noreferrer">OData</a>.</p>
<p>Четвертые напротив, на полном ходу писали graphql под одиночные сервисы (insights, teams) и выкатывали в лайв, однако не могли повторно использовать сущности (например User). В <a href=https://www.pipedrive.com/en/jobs/czech-republic target=_blank rel="noopener noreferrer">Праге</a> ребята написали все на typescript + <a href=https://relay.dev/ target=_blank rel="noopener noreferrer">relay</a> на фронтенде, который нам еще предстоит <a href=https://github.com/apollographql/apollo-server/issues/3159 target=_blank rel="noopener noreferrer">перенести в федерацию</a>.</p>
<p>Изучать новую технологию было круто.</p>
<p>Строгий, само-документирующийся API для фронтендеров? Глобально определяемые сущности уменьшающие дублирование и улучшающие прозрачность и владение среди всех команд? Gateway который автоматом делает под-запросы и между сервисами без избыточной выборки? Ухх.</p>
<p>Впрочем, я знал что нам понадобится управлять схемой как-то динамически, что-бы не полагаться на захардкоженые значения и видеть что происходит. Нечно типа <a href=https://docs.confluent.io/current/schema-registry/index.html target=_blank rel="noopener noreferrer">Confluent’s schema-registry</a> или <a href=https://bitbucket.org/atlassian/graphql-braid/src/master/ target=_blank rel="noopener noreferrer">Atlassian’s Braid</a>, но они либо под Кафку делались, либо на Java, которую мы не хотели поддерживать.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=план>План<a href=#план class=hash-link aria-label="Прямая ссылка на План" title="Прямая ссылка на План">​</a></h2>
<p>Я выступил с инженерной миссией у которой было 3 цели:</p>
<ul>
<li>
<p>Уменьшение первичной загрузки страницы (<em>воронка продаж</em>) на 15%. Достижимо если заменить некоторые REST запросы в один /graphql</p>
</li>
<li>
<p>Уменьшение траффика на 30%. Достижимо если перенести загрузку всех <em>сделок для воронки продаж</em> в graphql и спрашивать меньше свойств.</p>
</li>
<li>
<p>Использовать строгую типизацию (что-бы фронтендерам надо было писать меньше кода в <a href=https://en.wikipedia.org/wiki/Defensive_programming target=_blank rel="noopener noreferrer">защитном стиля</a>)</p>
</li>
</ul>
<p>Мне повезло, <a href=https://github.com/pipedrive/graphql-schema-registry#honorable-mentions target=_blank rel="noopener noreferrer">трое разработчиков</a> присоединились к миссии, в т.ч. автор прототипа.</p>
<p><img decoding=async loading=lazy src=/assets/images/55e6e4675e2b2ad39f82f66a62e4d05f-b70655d5cee90146aec68a775ece72e5.png width=946 height=477 class=img_sJtY></p>
<p>Сетевые запросы по мере загрузки веб-приложения</p>
<p>Изначальный план по сервисам выглядел так:
<img decoding=async loading=lazy src=/assets/images/e21b54c336353f713dfb5e6cd8a353f2-22c6ebd4a113c37e872623e90991f19f.png width=1400 height=606 class=img_sJtY></p>
<p>Сервисы над которыми предстояло бы работать</p>
<p>Тут schema-registry был бы общим сервисом, который мог бы хранить схему любого типа, получая на входе что вы в него кинете (swagger, typescript, graphql, avro, proto). На выходе он мог бы так же выдавать что вы хотите.</p>
<p>Gateway периодически опрашивал бы schema-registry и вызывал бы уже сервисы которые владеют данными согласно запросу и схеме. В свою очередь frontend компоненты могли бы скачивать актуальную схему для autocomplete и самих запросов.</p>
<p>На деле впрочем, мы сделали только поддержку graphql формата, потому что для федерации его было достаточно, а время как обычно быстро закончилось.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=итоги>Итоги<a href=#итоги class=hash-link aria-label="Прямая ссылка на Итоги" title="Прямая ссылка на Итоги">​</a></h2>
<p>Главную цель по замене /users/self в веб-приложении мы сделали в течение первых двух недель ? (ничоси!). А вот полировка всего решения что-бы оно быстро и надежно работало, заняло все оставшееся время.</p>
<p>К концу миссии (в феврале 2020), мы каким-то чудом достигли 13% ускорения первой загрузки страницы и 25% ускорения при повторной загрузке (из-за добавленного кеширования), согласно синтетическому UI тесту который мы гоняли на <a href=https://www.datadoghq.com/ target=_blank rel="noopener noreferrer">Datadog</a>.</p>
<p>Уменьшить трафик нам не удалось, потому что мы не достигли рефакторинга вида воронки продаж - там все еще REST.</p>
<p>Что-бы ускорить добавление сервисов в федерацию другими командами (у нас 600+ человек), мы записали обучающие видео что-бы все были в курсе как оно все работает вместе. После окончания миссии IOS- и Android- клиенты тоже мигрировали на graphql и в целом были рады.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=выученные-уроки>Выученные уроки<a href=#выученные-уроки class=hash-link aria-label="Прямая ссылка на Выученные уроки" title="Прямая ссылка на Выученные уроки">​</a></h2>
<p>Глядя на дневник миссии из этих 60 дней, могу выделить наибольшие трудности что-бы вам было бы попроще</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=управляйте-своей-схемой>Управляйте своей схемой<a href=#управляйте-своей-схемой class=hash-link aria-label="Прямая ссылка на Управляйте своей схемой" title="Прямая ссылка на Управляйте своей схемой">​</a></h2>
<blockquote>
<p>_Могли бы мы построить это сами? Возможно, но это не было бы так отполировано.<br>
<!-- -->_<a href=https://medium.com/paypal-engineering/scaling-graphql-at-paypal-b5b5ac098810 target=_blank rel="noopener noreferrer"><em>Mark Stuart, Paypal Engineering</em></a></p>
</blockquote>
<p>В течение первых пары дней я попробовал <a href=https://studio.apollographql.com/ target=_blank rel="noopener noreferrer">Apollo studio</a> и их <a href=https://www.apollographql.com/docs/studio/schema-checks/#the-check-process target=_blank rel="noopener noreferrer">инструментарий</a> для терминала по проверке схемы. Сервис прекрасный и работает из коробки с минимальными настройками gateway.</p>
<p><img decoding=async loading=lazy src=https://habrastorage.org/r/w1560/getpro/habr/upload_files/166/7a4/d4f/1667a4d4f5851f4095d94a7bdf8ab8d7.png alt="Написанный нами инструментарий для валидации схемы" title="Написанный нами инструментарий для валидации схемы" class=img_sJtY></p>
<p>Написанный нами инструментарий для валидации схемы</p>
<p>Однако несмотря на все фишки этого облачного сервиса, я посчитал что для такого важного дела как маршрутизация траффика было бы опрометчиво полагаться на сторонний сервис из-за рисков для жизнеспособности нашего дела, несмотря на богатый функционал и сколько-то выгодные расценки. Поэтому мы написали свой сервис с минимально нужным функционалом и теперь отправили его в opensource -  <a href=https://github.com/pipedrive/graphql-schema-registry target=_blank rel="noopener noreferrer"><strong>graphql-schema-registry</strong></a> .</p>
<p>Вторая причина была в том что-бы следовать модели <a href=https://medium.com/pipedrive-engineering/tanker-the-story-of-multi-dc-customer-data-migration-framework-ad842c2c6b9c target=_blank rel="noopener noreferrer">распределенной архитектруры датацентров</a> Pipedrive. У нас нет центрального датацентра, каждый DC самодостаточен. Это дает нам как более высокую надежность, так и способность открывать новые датацентры в Китае, России, Иране или на Марсе ?</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=версионируйте-свою-схему>Версионируйте свою схему<a href=#версионируйте-свою-схему class=hash-link aria-label="Прямая ссылка на Версионируйте свою схему" title="Прямая ссылка на Версионируйте свою схему">​</a></h2>
<p>Федеративная схема и graphql gateway очень хрупкие. Если у вас появится конфликт имен у типов или неверная ссылка между типами в одном из сервисов, то gateway может этого не пережить.</p>
<p>По умолчанию, gateway напрямую <a href=https://www.apollographql.com/docs/apollo-server/federation/introduction/#gateway-example target=_blank rel="noopener noreferrer">опрашивает все сервисы</a> касательно их схемы, поэтому достаточно одного из сервисов с ошибкой что-бы поломать всем трафик. Apollo studio решает это посредством проверки схемы еще до деплоя и отказе если видит какой-то конфликт.</p>
<p>Проверка совместимости схем правильный подход, но конкретное решение у Apollo зависит от их внутреннего состояния, т.к. они хранят правильную склеенную схему на данный момент. Это делает <a href=https://www.apollographql.com/docs/studio/schema/schema-reporting-protocol/#protocol-sequence target=_blank rel="noopener noreferrer">протокол регистрации</a> сложным и <a href=https://www.apollographql.com/docs/studio/schema/schema-reporting/#rolling-deploys-with-schema-reporting target=_blank rel="noopener noreferrer">зависящим от времени</a>.</p>
<p>Мы же напротив, связали версии микросервисов (генерируемые на основе хешей докер-образов) со схемой. Микросервисы регистрируют уже в ходе своей работы и делают это один раз без <a href=https://www.apollographql.com/docs/studio/schema/schema-reporting/#rolling-deploys-with-schema-reporting target=_blank rel="noopener noreferrer">последующих повторений</a>. Gateway делает выборку всех федерированных сервисов из <a href=https://www.consul.io/ target=_blank rel="noopener noreferrer">консула</a> и спрашивает schema-registry составить схему /schema/compose , предоставляя их версии.</p>
<p>Если schema-registry видит что предоставленные версии несовместимы, она откатывается на прошлые версии
<img decoding=async loading=lazy src=/assets/images/ac6951a7e0a2933369f74b934e035e80-0a00afabffc98cc17c18fc5e4823e352.png width=1400 height=580 class=img_sJtY>
<img decoding=async loading=lazy src=/assets/images/3feed981ef1fc75944a76cf3754056b5-a5f59d03438a4c3e8abc7ab59701340e.png width=1304 height=616 class=img_sJtY></p>
<p>Регистрация схемы при старте сервиса</p>
<p>Микросервисы могут выдавать как REST так и Graphql API, поэтому мы используем оповещения тревоги при неудачной регистрации схемы, оставляя при этом работу REST.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=определение-схемы-на-основе-rest-не-просто>Определение схемы на основе REST не просто<a href=#определение-схемы-на-основе-rest-не-просто class=hash-link aria-label="Прямая ссылка на Определение схемы на основе REST не просто" title="Прямая ссылка на Определение схемы на основе REST не просто">​</a></h2>
<p>Поскольку я не знал как лучше перенести схему из нашего REST в graphql, я сначала попробовал <a href=https://github.com/IBM/openapi-to-graphql target=_blank rel="noopener noreferrer">openapi-to-graphql</a>, нормально наша документация на тот момент не имела детального описания запросов и ответов.</p>
<p><img decoding=async loading=lazy src=/assets/images/2fc46dbba5892bd114758c2604b48e46-8096847fb11461df9769b79d501d3dec.png width=772 height=518 class=img_sJtY>
Спрашивать у каждой команды что-бы они написали бы ее, очевидно заняло бы уйму времени, поэтому мы определили основные сущности сами ? просто глядя на ответ при разных REST запросах.</p>
<p>В дальнейшем это нам аукнулось, так как оказалось что REST API иногда зависит от того кто делает запрос, либо зависит от внутреннего состояния и логики.
<img decoding=async loading=lazy src=/assets/images/b30de9ea845324d1f49bb1a79e5b4acb-b6a0e7a1508a3f9340be13c7ab8f3e58.png width=1230 height=517 class=img_sJtY></p>
<p>Например после настраиваемые <em>поля данных</em> меняют REST API в зависимости от пользователя. Если его добавить к сделке, то он оно будет выдаваться с ключем-хешем на уровне deal.pipeline_id. С федеративным graphql, динамическая схема невозможно, поэтому нам пришлось передвигать эти настраиваемые поля в отдельный список</p>
<p>Другая проблема это стиль наименований в json-ответе. Мы хотели поддерживать верблюжийСтиль, но почти весь REST отвечал нам в змеином_стиле, пришлось пока остаться на смешанном.</p>
<p><img decoding=async loading=lazy src=/assets/images/617cbdac0101669627746edf3b773e48-d3ee145f2aa36b7633c43cb755c1dbc2.png width=1560 height=675 class=img_sJtY></p>
<p>федеративный граф данных Pipedrive (слева) с 2 сервисами (из 539) и еще-не-федеративный граф сервиса leads (справа)</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=cqrs-и-кеш>CQRS и кеш<a href=#cqrs-и-кеш class=hash-link aria-label="Прямая ссылка на CQRS и кеш" title="Прямая ссылка на CQRS и кеш">​</a></h2>
<p>Модель данных в Pipedrive не может полагаться на простой TTL-кеш.</p>
<p>Например, когда инженер поддержки создает глобальное оповещение о предстоящем техническом обслуживании приложения из нашей админки, он ожидает что сообщение будет сразу же видно пользователям. Эти глобальные оповещения могут быть адресованы как всем пользователям, так и конкретным компаниям и индивидуальным людям. Чистить такой кеш приходится используя 3 разных ключа.</p>
<p>Что-бы делать параллельные запросы к PHP-монолиту, мы написали сервис на nodejs (назвали его monograph), который кеширует все что отвечает монолит в memcached. Этот кеш надо чистить из монолита в зависимости от бизнес-логики. Это немного антипаттерн, потому что кеш получается общим для разных сервисов и сильно их связывает.</p>
<p><img decoding=async loading=lazy src=/assets/images/a8837cc6450f909abee25a30a2e28981-0cbef379ca0aa9b002bc14f91050f1fd.png width=1232 height=382 class=img_sJtY></p>
<p>Тут можно заметить <a href=https://martinfowler.com/bliki/CQRS.html target=_blank rel="noopener noreferrer">CQRS pattern</a>. Впрочем, такой кеш позволяет ускорять 80% запросов и дает итоговую среднюю задержку такую же как и у монолита.</p>
<p><img decoding=async loading=lazy src=/assets/images/64d0d5bf393aa6ba6bf232332db1d3eb-eddbe86fce681cdb0355bc3cee8535d3.png width=1560 height=401 class=img_sJtY></p>
<p>Время средней задержки ответа монолита (слева) и graphql gateway (справа) в регионе US на основе NewRelic</p>
<p>Еще одна сложность - язык пользователя. Как только он меняется, нам надо чистить уйму разных сущностей - от типов активности до того какие настройки должны быть при показе гугл карт. И что еще хуже - язык уже управляется не в монолите, а был вынесен в отдельный сервис <em>identity</em>. Связывать его с общим кешем очень не хотелось.</p>
<p>Identity владеет данными пользователей, поэтому мы сделали так что он кидает событие через kafka, которое ловит monograph и чистит все нужные кеши. Тут есть недостаток, что событие приходит с задержкой (может максимум 1 сек), поэтому чистка кеша происходит не мгновенно. Нормально это не критично, потому что пользователь не так быстро уходит со страницы что-бы сделать повторный запрос к бекенду и заметить что в кешах еще старый язык.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=следите-за-производительностью>Следите за производительностью<a href=#следите-за-производительностью class=hash-link aria-label="Прямая ссылка на Следите за производительностью" title="Прямая ссылка на Следите за производительностью">​</a></h2>
<p>Производительность была главной целью и для этого нам пришлось хорошо прокачаться в знании APM и выслеживании распределенных запросов между микросервисами что-бы определить самые медленные места. Мы на тот момент использовали Datadog и он хорошо себя зарекомендовал.</p>
<p>Для ускорения, мы кешировали все 30 параллельных запросов в memcached. Но по ходу дела возникали проблемы. Например на картинке слева видно что некоторые резолверы делают запрос в memcached и получают ответ за 10мс, а другие тупят, словно жду своей очереди выростая до 220мс. Как оказалось, это было из-за того что я использовал один и тот же хост <a href=https://github.com/facebook/mcrouter target=_blank rel="noopener noreferrer">mcrouter</a>. Как только я стал их ротировать, мемкеш стал отдавать все за 20мс максимум.</p>
<p>Что-бы уменьшить количество этих сетевых запросов к мемкешу, мы склеили его в один используя <a href=https://github.com/3rd-Eden/memcached#public-methods target=_blank rel="noopener noreferrer">getMulti</a> функцию. Получается что несмотря на то что все resolver'ы выполняются независимо, они блочатся на 5мс с помощью debounce и склеиваются воедино.</p>
<p><img decoding=async loading=lazy src=/assets/images/1dc6beb1bfea7bfe18afdd32f3fbefa6-92e0ffd5c4629b52815bf1b5292bcaca.png width=1560 height=564 class=img_sJtY></p>
<p>На картинке справа видна другая проблема. Эти желтые линии это налог graphql gateway на приведение данных к строгому типу. Причем чем больше данных вы гоняете через сервис, тем дольше будет эта фаза выполнятся.</p>
<p><img decoding=async loading=lazy src=/assets/images/65652f1707e2c00f50b1cae39c4c04b8-2148bc2a79105bb3de31d98d9d45eb77.png width=1000 height=561 class=img_sJtY></p>
<p>Вобщем по ходу миссии постоянно приходилось мониторить какие же запросы нам надо еще закешировать и под конец стало бесить что скажем 28 из 30 запросов прекрасно кешируются, а оставшиеся два мало того что отвечают целых 500мс, так их еще и невозможно легко закешировать.</p>
<p>Нам пришлось вынести их в отдельный graphql запрос, который делается после первого /graphql запроса на инициализацю страницы. Так что сейчас мы на деле делаем уже порядка 3-5 независимых запросов, в зависимости от тайминга фронтенда (там тоже debounce зависящий от параллельной подгрузки FE компонентов)</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=не-следите-за-производительностью>Не следите за производительностью<a href=#не-следите-за-производительностью class=hash-link aria-label="Прямая ссылка на Не следите за производительностью" title="Прямая ссылка на Не следите за производительностью">​</a></h2>
<p>Казалось бы полностью противоположный урок, но на деле это значит что в лайв-среде вам лучше отключить мониторинг приложения (APM) и <a href=https://www.apollographql.com/docs/apollo-server/api/apollo-server/#apolloserver target=_blank rel="noopener noreferrer">tracing<!-- -->:true</a>, если вы используете их.</p>
<p><img decoding=async loading=lazy src=/assets/images/7ed98ffd99435aa8f49204f198739783-feb27d1f66a9bc17778ab082878f60fc.png width=1000 height=550 class=img_sJtY></p>
<p>Отключение отслеживания у нас ускорило среднюю задержку в два раза с 700мс до 300мс для нашей тестовой компании. Насколько я понимаю, причина крылась в функциях которые замеряют время (типа performance.now()), которые необходимы для замера каждого резолвера.</p>
<p>Мы делали профайлинг graphql gateway с помощью  <a href=https://medium.com/@paul_irish/debugging-node-js-nightlies-with-chrome-devtools-7c4a1b95ae27 target=_blank rel="noopener noreferrer">Chrome DevTools</a>, но так просто вызов этих мелких функций, раскиданных повсюду не заметишь.</p>
<p><a href="https://www.youtube.com/watch?v=VnG7ej56lWw" target=_blank rel="noopener noreferrer">Бен тут</a> делал замеры и тоже пришел к этому.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=попробуйте-ранний-запрос>Попробуйте ранний запрос<a href=#попробуйте-ранний-запрос class=hash-link aria-label="Прямая ссылка на Попробуйте ранний запрос" title="Прямая ссылка на Попробуйте ранний запрос">​</a></h2>
<p>На фронтенде, время создания graphql запроса для нас оказалось сложновато. Я хотел передвинуть первый /graphql как можно раньше (даже до загрузки всего кода в vendors.js) в графике сетевых запросов. Мы смогли это сделать, но веб-приложение из-за этого стало значительно сложней.</p>
<p>Что-бы делать запрос вам понадобится <a href=https://github.com/apollographql/apollo-client target=_blank rel="noopener noreferrer">graphql клиент</a> и парсинг <a href=https://github.com/apollographql/graphql-tag target=_blank rel="noopener noreferrer">gql литералов</a> для определения самого запроса. Дальше его надо либо выдавать в отдельном bundle, либо отказываться от всех удобств и использовтать сырой <a href=https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch target=_blank rel="noopener noreferrer">fetch</a>. Даже если делать сырой запрос, дальше надо что-то делать с ответом - распределять данные по моделям либо сохранять в глобальную переменную. Вобщем мы решили отказаться от этого и надеяться на server-side-rendering и <a href=https://medium.com/samsung-internet-dev/a-beginners-guide-to-service-workers-f76abf1960f6 target=_blank rel="noopener noreferrer">service workers</a> в будущем.
<img decoding=async loading=lazy src=/assets/images/45a6bc6fa90a4b4d4f92170543daa475-7e0b3c2aac26da753727ff6a62d44712.png width=1400 height=682 class=img_sJtY></p>
<p>Перенос /graphql запроса левей</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=оценивайте-сложность-запроса>Оценивайте сложность запроса<a href=#оценивайте-сложность-запроса class=hash-link aria-label="Прямая ссылка на Оценивайте сложность запроса" title="Прямая ссылка на Оценивайте сложность запроса">​</a></h2>
<p>Чем graphql примечателен, так это то что тут можно оценивать насколько больно запрос клиента будет бить по инфраструктуре не делая при этом еще никакой работы. Для оценки сложности надо указывать цену внутри самой схемы с помощью директив, а дальше делать саму проверку при получении запроса и отклонять его если сложность слишком велика, подобно нашему <a href=https://pipedrive.readme.io/docs/core-api-concepts-rate-limiting target=_blank rel="noopener noreferrer">rate limit</a> на частоту запросов.</p>
<p>Сначала мы попробовали <a href=https://github.com/pa-bru/graphql-cost-analysis target=_blank rel="noopener noreferrer">graphql-cost-analysis</a> библиотеку, но в итоге написали свою, поскольку захотели больше фич - множителях при выдаче списков данных, вложенности и рекурсии, а так же определении типов влияния на инфраструктуру (сетевой запрос, БД, CPU, работа с файлами). Тут сложней всего оказалось внедрять поддержку своей директивы в gateway и schema-registry. Надеюсь мы нашу библиотеку тоже опубликуем.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=у-схемы-много-лиц>У схемы много лиц<a href=#у-схемы-много-лиц class=hash-link aria-label="Прямая ссылка на У с�хемы много лиц" title="Прямая ссылка на У схемы много лиц">​</a></h2>
<p>Работать со схемой в js/typescript на низком уровне порой мучительно. Это начинаешь понимать когда пробуешь интегрировать существующий graphql сервис в федерацию.</p>
<p>Например настройки <a href=https://github.com/graphql-community/koa-graphql#options target=_blank rel="noopener noreferrer">koa-graphql</a> и <a href=https://www.apollographql.com/docs/apollo-server/v1/servers/koa/ target=_blank rel="noopener noreferrer">apollo-server-koa</a> ожидают что вы создадите вложенный объект  <a href=https://github.com/graphql/graphql-js#using-graphqljs target=_blank rel="noopener noreferrer"><strong>GraphQLSchema</strong></a>  который включает и сами резолверы. Но федеративный apollo/server <a href=https://www.apollographql.com/docs/apollo-server/federation/implementing-services/#generating-a-federated-schema target=_blank rel="noopener noreferrer">хочет схему и резолверы отдельно</a>:</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">buildFederatedSchema([{typeDefs, resolvers}])</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>В другом случае, как я уже писал, вам захочется определить схему с помощью <a href=https://github.com/apollographql/graphql-tag target=_blank rel="noopener noreferrer">gql литерала</a>, или сохранить схему в schema.graphql файл, а когда вам надо будетделать проход по всей схеме для оценки сложности, понадобится <a href=https://github.com/graphql/graphql-js/blob/master/src/language/ast.js target=_blank rel="noopener noreferrer">ASTNode</a> (и функции <a href=https://github.com/graphql/graphql-js/blob/d4c82e0849318d045107321c6655c1a5da37b798/src/language/parser.d.ts#L58 target=_blank rel="noopener noreferrer">parse</a> / <a href=https://github.com/graphql/graphql-js/blob/dd0297302800347a20a192624ba6373ee86836a3/src/utilities/buildASTSchema.js#L121 target=_blank rel="noopener noreferrer">buildASTSchema</a>)</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=плавная-canary-деплой>Плавная canary деплой<a href=#плавная-canary-деплой class=hash-link aria-label="Прямая ссылка на Плавная canary деплой" title="Прямая ссылка на Плавная canary деплой">​</a></h2>
<p>Во время миссии мы выкатывали изменения сначала всем разработчикам что-бы отследить очевидные ошибки.</p>
<p>Под конец миссии в феврале, мы выкатили graphql только на 100 компаний-"везунчиков". Дальше мы медленно выкатывали их до 1000 компаний, потом 1%, 10%, 30%, 50% и наконец в июне выкатили всем.</p>
<p>Деплоили мы просто используя логику деления company ID без остатка. В дополнение, у нас было несколько настроек - кому еще включать, кому не включить никогда и рубильник выключающий graphql сразу у всех на фронтенде. Было очень полезно во время инцидентов сразу избавиться от подозрений что это все из-за нового graphql и упростить дебаг.</p>
<p>Учитывая насколько большие изменения мы делали, это был хороший опыт быстро получить обратную связь, найти баги (с кешированием), при этом снизив риски для большинства пользователей.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=надежды-и-мечты>Надежды и мечты<a href=#надежды-и-мечты class=hash-link aria-label="Прямая ссылка на Надежды и мечты" title="Прямая ссылка на Надежды и мечты">​</a></h2>
<p>Что-бы достичь всех плюшек от того что graphql может нам дать, надо еще много что поменять - добавить мутации, подписки, массовые операции на уровне федерации. Все это требует работы с командами и евангелизм что-бы увеличить количество федерируемых сервисов.</p>
<p>Как только наш graphql API станет стабильным и достаточным для использования любыми пользователями, его можно выкатить в качестве второй версии нашего API. Для публикации впрочем понадобятся еще директивы для ограничения доступа к сущностям согласно <a href=https://oauth.net/2/scope/ target=_blank rel="noopener noreferrer">OAuth видимости</a> (для приложений из рынка) и согласно нашим <a href=https://www.pipedrive.com/en/pricing target=_blank rel="noopener noreferrer">продуктам</a>.</p>
<p>В самой schema-registry надо добавить отслеживание клиентов, связать ее gateway для получения аналитики трафика что-бы проще было понять какие поля можно удалять, надо добавить фильтрацию и подсветку сущностей в зависимости от директив цены и видимости, валидировать именование, хранить постоянные запросы (persisted query), публиковать историю изменений итоговой схемы для сторонних разработчиков.</p>
<p>Кроме того, поскольку у нас есть сервисы на go, еще непонятно как стоит делать внутренний трафик - стоит ли использовать GRPC из-за скорости и надежности, либо использовать независимые graphql эндпоинты, либо ставить централизованный внутренний gateway. Если GRPC лучше только из-за его бинарности, может мы можем написать библиотечку которая тоже упакует graphql данные с помощью <a href=https://msgpack.org/ target=_blank rel="noopener noreferrer">msgpack</a>?</p>
<p>Что касается внешнего мира, надеюсь Apollo со своим <a href="https://www.youtube.com/watch?v=MvHzOwdLb_o" target=_blank rel="noopener noreferrer">проектом Constellation</a> ускорят обработку запроса на Rust что-бы небыло этих 10% налога на производительность и смогут федерировать graphql сервисы без серьезных изменений последних.</p>
<p>Вобщем прекрасное время что-бы наслаждаться разработкой где уйма сложности!</div><footer class=docusaurus-mt-lg><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><a href="https://github.com/tot-ra/kurapov.ee/tree/main/blog/tech/backend/Путь к Федеративному GraphQL.md" target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_wrwg aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Отредактировать эту страницу</a></div><div class="col lastUpdated_VnXK"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Навигация по странице поста блога"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/tech/Journey to a Federated GraphQL"><div class=pagination-nav__sublabel>Следующий пост</div><div class=pagination-nav__label>Journey to a Federated GraphQL</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/управление/hiring/Техническое интервью как нейрон"><div class=pagination-nav__sublabel>Предыдущий пост</div><div class=pagination-nav__label>Техническое интервью как нейрон</div></a></nav></main><div class="col col--2"><div class="tableOfContents_m6jX thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#задача class="table-of-contents__link toc-highlight">Задача</a><li><a href=#прототип-с-прямым-доступом-к-бд class="table-of-contents__link toc-highlight">Прототип с прямым доступом к БД</a><li><a href=#прототип-со-склейкой class="table-of-contents__link toc-highlight">Прототип со склейкой</a><li><a href=#подготовка class="table-of-contents__link toc-highlight">Подготовка</a><li><a href=#сбор-ожиданий-разработчиков class="table-of-contents__link toc-highlight">Сбор ожиданий разработчиков</a><li><a href=#план class="table-of-contents__link toc-highlight">План</a><li><a href=#итоги class="table-of-contents__link toc-highlight">Итоги</a><li><a href=#выученные-уроки class="table-of-contents__link toc-highlight">Выученные уроки</a><li><a href=#управляйте-своей-схемой class="table-of-contents__link toc-highlight">Управляйте своей схемой</a><li><a href=#версионируйте-свою-схему class="table-of-contents__link toc-highlight">Версионируйте свою схему</a><li><a href=#определение-схемы-на-основе-rest-не-просто class="table-of-contents__link toc-highlight">Определение схемы на основе REST не просто</a><li><a href=#cqrs-и-кеш class="table-of-contents__link toc-highlight">CQRS и кеш</a><li><a href=#следите-за-производительностью class="table-of-contents__link toc-highlight">Следите за производительностью</a><li><a href=#не-следите-за-производительностью class="table-of-contents__link toc-highlight">Не следите за производительностью</a><li><a href=#попробуйте-ранний-запрос class="table-of-contents__link toc-highlight">Попробуйте ранний запрос</a><li><a href=#оценивайте-сложность-запроса class="table-of-contents__link toc-highlight">Оценивайте сложность запроса</a><li><a href=#у-схемы-много-лиц class="table-of-contents__link toc-highlight">У схемы много лиц</a><li><a href=#плавная-canary-деплой class="table-of-contents__link toc-highlight">Плавная canary деплой</a><li><a href=#надежды-и-мечты class="table-of-contents__link toc-highlight">Надежды и мечты</a></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title>Media</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://twitter.com/tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Мысли в Twitter<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://t.me/+4kDpExZlraQ0NGZk target=_blank rel="noopener noreferrer" class=footer__link-item>Мысли в Telegram<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.threads.com/@tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Мысли в Threads<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://bsky.app/profile/tot-ra.bsky.social target=_blank rel="noopener noreferrer" class=footer__link-item>Мысли в Bluesky<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.youtube.com/user/artkurapov/ target=_blank rel="noopener noreferrer" class=footer__link-item>Long videos on Youtube<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.twitch.tv/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Streams on Twitch<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.instagram.com/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Природа в Instagram<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.tiktok.com/@artkurapov target=_blank rel="noopener noreferrer" class=footer__link-item>Видео-мысли в TikTok<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div><div class="col footer__col"><div class=footer__title>Business</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://www.linkedin.com/in/kurapov/ target=_blank rel="noopener noreferrer" class=footer__link-item>LinkedIn<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://github.com/tot-ra target=_blank rel="noopener noreferrer" class=footer__link-item>GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href="https://stackoverflow.com/users/158448/artjom-kurapov?tab=profile" target=_blank rel="noopener noreferrer" class=footer__link-item>Stack Overflow<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.slideshare.net/totra/presentations target=_blank rel="noopener noreferrer" class=footer__link-item>Slideshare<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://habr.com/ru/users/tot_ra/posts/ target=_blank rel="noopener noreferrer" class=footer__link-item>Habr<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div><div class="col footer__col"><div class=footer__title>Community</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://www.facebook.com/artkurapov target=_blank rel="noopener noreferrer" class=footer__link-item>Facebook<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://vk.com/artkurapov target=_blank rel="noopener noreferrer" class=footer__link-item>ВКонтакте<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.reddit.com/user/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Reddit<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://tot-ra.livejournal.com/ target=_blank rel="noopener noreferrer" class=footer__link-item>ЖЖ<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div><div class="col footer__col"><div class=footer__title>Media</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://suno.com/@tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Music on Suno<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://goodreads.com/tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Books on Goodreads<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://steamcommunity.com/id/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Games on Steam<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://open.spotify.com/user/1176479585 target=_blank rel="noopener noreferrer" class=footer__link-item>Music on Spotify<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://soundcloud.com/tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Music on Soundcloud<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.thingiverse.com/tot_ra/designs target=_blank rel="noopener noreferrer" class=footer__link-item>3D models on Thingiverse<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.pinterest.com/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Interests<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright © 2025</div></div></div></footer></div>