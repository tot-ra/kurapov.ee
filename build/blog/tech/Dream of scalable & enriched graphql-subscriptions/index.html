<!doctype html><html lang=ru dir=ltr class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>Dream of scalable & enriched graphql-subscriptions | Артём Курапов</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:image content=https://kurapov.ee/img/docusaurus-social-card.jpg><meta data-rh=true name=twitter:image content=https://kurapov.ee/img/docusaurus-social-card.jpg><meta data-rh=true property=og:url content="https://kurapov.ee/blog/tech/Dream of scalable & enriched graphql-subscriptions"><meta data-rh=true property=og:locale content=ru><meta data-rh=true name=docusaurus_locale content=ru><meta data-rh=true name=docusaurus_tag content=default><meta data-rh=true name=docsearch:language content=ru><meta data-rh=true name=docsearch:docusaurus_tag content=default><meta data-rh=true property=og:title content="Dream of scalable & enriched graphql-subscriptions | Артём Курапов"><meta data-rh=true name=description content="Originally posted in Medium"><meta data-rh=true property=og:description content="Originally posted in Medium"><meta data-rh=true property=og:type content=article><meta data-rh=true property=article:published_time content=2022-11-23T15:22:00.000Z><link data-rh=true rel=icon href=/img/favicon/favicon.ico><link data-rh=true rel=canonical href="https://kurapov.ee/blog/tech/Dream of scalable & enriched graphql-subscriptions"><link data-rh=true rel=alternate href="https://kurapov.ee/blog/tech/Dream of scalable & enriched graphql-subscriptions" hreflang=ru><link data-rh=true rel=alternate href="https://kurapov.ee/blog/tech/Dream of scalable & enriched graphql-subscriptions" hreflang=x-default><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@id":"https://kurapov.ee/blog/tech/Dream of scalable & enriched graphql-subscriptions","@type":"BlogPosting","author":[],"datePublished":"2022-11-23T15:22:00.000Z","description":"Originally posted in Medium","headline":"Dream of scalable & enriched graphql-subscriptions","isPartOf":{"@id":"https://kurapov.ee/blog","@type":"Blog","name":"Blog"},"keywords":[],"mainEntityOfPage":"https://kurapov.ee/blog/tech/Dream of scalable & enriched graphql-subscriptions","name":"Dream of scalable & enriched graphql-subscriptions","url":"https://kurapov.ee/blog/tech/Dream of scalable & enriched graphql-subscriptions"}</script><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="Артём Курапов RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="Артём Курапов Atom Feed"><link rel=stylesheet href=/assets/css/styles.d5d08b3f.css><script src=/assets/js/runtime~main.7f020619.js defer></script><script src=/assets/js/main.2732c1e0.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Перейти к основному содержимому"><a class=skipToContent_aCxL href=#__docusaurus_skipToContent_fallback>Перейти к основному содержимому</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Переключить навигационную панель" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/artjom.jpg alt="Artjom Kurapov" class="themedComponent_cfDz themedComponent--light_Kj2W"><img src=/img/artjom.jpg alt="Artjom Kurapov" class="themedComponent_cfDz themedComponent--dark__Nfe"></div><b class="navbar__title text--truncate">Артём Курапов</b></a><a class="navbar__item navbar__link" href="/docs/Об авторе">Об авторе</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/blog>Блог</a></div><div class="navbar__items navbar__items--right"><a href=https://github.com/tot-ra/kurapov.ee target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><div class="toggle_LxwK colorModeToggle_c2rS"><button class="clean-btn toggleButton_gSiH toggleButtonDisabled_GY0v" type=button disabled title="Переключение между темным и светлым режимом (сейчас используется Светлый режим)" aria-label="Переключение между темным и светлым режимом (сейчас используется Светлый режим)" aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_WH3Q><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_OWtW><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_vXry></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_jkFy"><div class="container margin-vert--lg"><div class=row><aside class="col col--3"><nav class="sidebar_aM6_ thin-scrollbar" aria-label="Навигация по последним постам в блоге"><div class="sidebarItemTitle_Dvxs margin-bottom--md">Последние заметки</div><div role=group><h3 class=yearGroupHeading_ZKt1>2025</h3><ul class="sidebarItemList_X9hj clean-list"><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/вера/От чего спасает Христос">вера/От чего спасает Христос</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2025/05/07/события/ AWS Gen AI meetup"> AWS Gen AI meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2025/04/29/события/ AGI - Beyond the Hype Before the Storm">AGI: Beyond the Hype, Before the Storm</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2025/04/28/события/ Decentralized AI event"> Decentralized AI event</a></ul></div><div role=group><h3 class=yearGroupHeading_ZKt1>2024</h3><ul class="sidebarItemList_X9hj clean-list"><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/12/13/события/ Tallinn AI meetup"> Tallinn AI meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/11/26/события/ AI meetup notes"> AI meetup notes</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href=/blog/2024/11/14/события/AI-ED-Webinar>Andmete ja tehisintellekti olulisusest personaliseerituma õppe poole liikumisel by Innar Liiv</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/кино/The Wild Robot">кино/The Wild Robot</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href='/blog/управление/Product team models - project based, "feature factory" and product operating model'>Product team models - project based, feature factory and product operating model</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/tech/devices/Моя коллекция часов в 2024">Моя коллекция часов в 2024</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/tech/soft/Как записывать экран с круглой камерой">Как записывать экран с круглой камерой</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href=/blog/2024/10/18/события/AsuurKeraamika>Asuur Keraamika</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href=/blog/tech/backend/gpu/CUDA>CUDA</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/10/12/события/Katana meetup">Katana meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/10/04/события/Pipedrive meetup">Pipedrive meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/10/01/события/Digit 2024 Tartu">Digit Tartu conference 2024</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/09/25/события/TallinnJS meetup">Tallinn JS meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/05/24/события/Latitude 59">Latitude 59</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/управление/hiring/Homework sandboxes">Sandboxes for homework assignments</a></ul></div><div role=group><h3 class=yearGroupHeading_ZKt1>2022</h3><ul class="sidebarItemList_X9hj clean-list"><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/психология/Об этике пчеловодства">Об этике пчеловодства</a></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class=title_Y5lg>Dream of scalable & enriched graphql-subscriptions</h1><div class="container__LhH margin-vert--md"><time datetime=2022-11-23T15:22:00.000Z>23 ноября 2022 г.</time> · <!-- -->12 мин. чтения</div></header><div id=__blog-post-container class=markdown><p>Originally posted in <a href=https://medium.com/pipedrive-engineering/a-dream-of-scalable-and-enriched-graphql-subscriptions-724284448e65 target=_blank rel="noopener noreferrer">Medium</a></p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/1400/1*Rvb94EOQA-BzsmYJ4TklGg.jpeg alt=https://miro.medium.com/max/1400/1*Rvb94EOQA-BzsmYJ4TklGg.jpeg class=img_sJtY></p>
<p>Stylized photo of Jagala juga (Estonia), original photo by Aleksandr Abrosimov, Wikimedia Commons</p>
<p><a href=https://medium.com/pipedrive-engineering/journey-to-federated-graphql-2a6f2eecc6a4 target=_blank rel="noopener noreferrer">Last time</a>, I wrote about 5-year long journey of having GraphQL in Pipedrive. Now, let me tell you about a 10-year long journey of delivering websocket events to frontend.. and maybe help you out with it too.</p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/1400/1*xffiu2fshUMbBFm-JlSAGw.gif alt=https://miro.medium.com/max/1400/1*xffiu2fshUMbBFm-JlSAGw.gif class=img_sJtY></p>
<p>The <strong>product need</strong> of asynchronous events comes up any time user needs to be notified about something by the server.</p>
<ul>
<li>you’ve got an instant message</li>
<li>uploaded image has finished resizing</li>
<li>your colleague has changed an avatar</li>
<li>your bulk change of 10k deals has progressed to 99%</li>
</ul>
<p>So, async events <strong>enrich UX with details & interactivity</strong></p>
<p>But most importantly, they solve a problem of having <strong>inconsistent data</strong> displayed or stored on the browser side. Without such updates, other user won’t see <em>Pipedrive deals renames</em>; another browser tab won’t receive <em>activities deleted</em>. Even in the same browser tab, your views may not talk well with each other, lacking single storage and be out-of sync.</p>
<h1><strong>Historical dive</strong></h1>
<p>Luckily, Pipedrive has “solved” this issue 10 years ago. In 2012 <a href=https://www.linkedin.com/in/andris-reinman/ target=_blank rel="noopener noreferrer">Andris</a>, <a href=https://www.linkedin.com/in/martinkapp/ target=_blank rel="noopener noreferrer">Kapp</a> & <a href=https://www.linkedin.com/in/martintajur/ target=_blank rel="noopener noreferrer">Tajur</a> have developed a <strong>socketqueue</strong> service, which to this day transports API events to the front-end leveraging <a href=https://www.npmjs.com/package/sockjs target=_blank rel="noopener noreferrer">sockjs</a> library.</p>
<p>Tajur’s talk in 2016 was one of the reasons I’ve re-created similar setup, got puzzled how I should manage user connections with <a href=https://socket.io/ target=_blank rel="noopener noreferrer">socket.io</a> & scale it beyond one server and ultimately joined Pipedrive to find out. I was fascinated by event streaming and the possibilities it brings.</p>
<p>As you can see, his talk is more about <a href=https://www.rabbitmq.com/ target=_blank rel="noopener noreferrer">RabbitMQ</a> — a message broker that stands between php monolith and socketqueue.</p>
<h1><strong>Pros and cons</strong></h1>
<p>In-memory queues have allowed Pipedrive to withstand bursts of events, triggered by external integrations or in-house things like deal import from xls file or a bulk edit.</p>
<p>Api event that is pushed to the RabbitMQ and to the frontend is <strong>denormalized</strong>, having different entities. That’s good, because you have a <strong>consistent snapshot</strong> of multiple things at the same time and you recipients <strong>don’t need to re-query</strong> anything…</p>
<p>But it is also hugely <strong>inefficient</strong>, as all browser tabs receive all possible changes, wether they want it or not, sometimes having reached 80GB per day of traffic for a single customer.. while web app on his laptop CPU is doing all of the heavy filtering.</p>
<p>So we can’t keep infinitely bloating event schema, making it even heavier.</p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/1400/1*SEK3NXeBwKWHvw4fgcbVBg.png alt=https://miro.medium.com/max/1400/1*SEK3NXeBwKWHvw4fgcbVBg.png class=img_sJtY></p>
<p>Cell logic as number in a web-socket URL</p>
<p>Second problem is a <strong>noisy neighbour</strong>. Scalability, as I mentioned, is solved with “cell logic” (in a good scenario — aka tenant isolation) which means sharding socketqueue application servers by company ID. This also means that we must have <strong>fixed amount of containers</strong> and fixed amount of queues to ensure predictable routing.</p>
<p>So problem arises whenever you have one company generating thousands of events — they are not distributed among all servers, instead they <strong>spike CPU</strong> of a single node to the point of health check failure. There isn’t any room to vertically grow single-core CPU, only to double amount of servers which means <strong>wasted infrastructure resources</strong>.</p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/1400/1*2pcMt6Bjn_pgBLO9CLjjOA.png alt=https://miro.medium.com/max/1400/1*2pcMt6Bjn_pgBLO9CLjjOA.png class=img_sJtY></p>
<p>noisy neighbour CPU spike of particular pod</p>
<p>Third issue is <strong>visibility & tracing</strong>. Same as with REST API, without proper documentation (wether it is swagger or type definitions), it is very hard to understand what can be inside of the event schema and most important, who uses what in case you want to do a breaking change. Which leads to a vicious cycle of nobody removing anything from the event & bloating it even more.</p>
<p>Finally, if web-socket connection is down because user went into a tunnel or just closed his laptop — he may loose events. Could that cause a loss of <em>a deal</em> and profits for the user?</p>
<p>Over the years we’ve optimized the hell out of socketqueue, so its</p>
<ul>
<li>multi-threaded as it listens queues and WS connection handling</li>
<li>compresses traffic</li>
<li>checks permissions & visibility</li>
</ul>
<p>but what if we could do better..? 🤔</p>
<h1><strong>How</strong></h1>
<p>Idea behind <a href=https://spec.graphql.org/June2018/#sec-Subscription-Operation-Definitions target=_blank rel="noopener noreferrer">graphql subscriptions</a> is pretty simple — you declare only what you want to receive, given some filtering arguments. And it will be server’s job to intelligently filter events.</p>
<p>I can’t do a better job of explaining basic setup than <a href=https://twitter.com/benawad target=_blank rel="noopener noreferrer">Ben</a> here 😁. So what he shows here is a single server instance where pubsub is just in-memory event routing directly from mutation. But in our case there are no mutations — real changes are generated by the php legacy far-far away.</p>
<h1><strong>Mission scope</strong></h1>
<p>So what I wanted to achieve was</p>
<ul>
<li>demo graphql subscriptions in production, having explicit schema</li>
<li>test horizontal pod scaling</li>
<li>increase reliability by using kafka instead of rabbitMq</li>
<li>use small, normalized, domain events to keep things simple</li>
<li>keep event delivery latency below 2 sec [to not be slower than socketqueue we’re trying to replace]</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=risks><strong>Risks</strong><a href=#risks class=hash-link aria-label="Прямая ссылка на risks" title="Прямая ссылка на risks">​</a></h2>
<p>What I didn’t know..</p>
<ul>
<li>how do we authenticate?</li>
<li>what protocol should we use? SSE? WS? whats this <a href=https://github.com/dunglas/mercure target=_blank rel="noopener noreferrer">mercure</a> thing.. and does some of it fallback to pooling?</li>
<li>will WS/TCP connections be bound to same pod or not?</li>
<li>can we do multiple subscriptions at a time?</li>
</ul>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/3920/1*K-aB3FKXH0jXeG4HiLRdVw.png alt=https://miro.medium.com/max/3920/1*K-aB3FKXH0jXeG4HiLRdVw.png class=img_sJtY></p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/4004/1*5q23Z56at20SsvRkOB_6Hw.png alt=https://miro.medium.com/max/4004/1*5q23Z56at20SsvRkOB_6Hw.png class=img_sJtY></p>
<ul>
<li>what storage / transfer medium do we use? DB? redis streams? kafka? redis pubsub? KTable?</li>
<li>can we rewind events in time in case user got disconnected? would we need to store cursor ID per entity? also, how does live query work?</li>
<li>how do we filter events by company, user, session, entity? is there a standard for subscription filter fields?</li>
<li>can we re-use federated graphql schema? can we enrich events? what should be QoS / retry logic if gateway is down? Lee Byron went into it at depth <a href="https://youtu.be/rapO30fpREg?t=6675" target=_blank rel="noopener noreferrer">in his talk over 5 years ago</a>.</li>
<li>how many items can we subscribe to?</li>
<li>how do we unsubscribe? or disconnect users when they log out?</li>
</ul>
<h1><strong>Proof of concept</strong></h1>
<p>Before the mission, I made a simple node service that connected to kafka and proxied events without any filtering. This was already promising. But for a mission I wanted to try out <a href=https://go.dev/ target=_blank rel="noopener noreferrer"><em><strong>go</strong></em></a> to have all CPUs to be involved to maximize that efficiency, while this PoC was a fallback (that proved itself very useful)</p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/2256/1*8i540taseWXr_TAV2ysBZw.png alt=https://miro.medium.com/max/2256/1*8i540taseWXr_TAV2ysBZw.png class=img_sJtY></p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/4952/1*z39G_eYPNR7Zuu_Hl1dK7g.png alt=https://miro.medium.com/max/4952/1*z39G_eYPNR7Zuu_Hl1dK7g.png class=img_sJtY></p>
<h1><strong>Liftoff</strong></h1>
<p>Four of us (<a href=https://www.linkedin.com/in/kurapov/ target=_blank rel="noopener noreferrer">myself</a>, <a href=https://www.linkedin.com/in/pavel-nikolajev-84184a64/ target=_blank rel="noopener noreferrer">Pavel</a>, <a href=https://www.linkedin.com/in/kristjan-luik-89bb03122/ target=_blank rel="noopener noreferrer">Kristjan</a> and <a href=https://www.linkedin.com/in/abhishek-goswami-591541b1/ target=_blank rel="noopener noreferrer">Hiro</a>) have set off for entire summer to try and do just that.. explore the unknown 🛸 and bring value back to the launchpad.</p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/1400/1*QlBXCk8EjRtp5n_Fxr2xTw.png alt=https://miro.medium.com/max/1400/1*QlBXCk8EjRtp5n_Fxr2xTw.png class=img_sJtY></p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=gophers><strong>gophers</strong><a href=#gophers class=hash-link aria-label="Прямая ссылка на gophers" title="Прямая ссылка на gophers">​</a></h2>
<p>We looked into <a href=https://github.com/graph-gophers/graphql-go target=_blank rel="noopener noreferrer">graph-gophers/graphql-go</a> as first basis and within couple of days we’ve re-created PoC of subscribing to kafka events</p>
<ul>
<li>We’ve hit the dilemma of GraphQL integer spec <a href=https://github.com/graphql/graphql-js/issues/292#issuecomment-186702912 target=_blank rel="noopener noreferrer">not matching go’s int32</a>.</li>
<li>Got per-property filtering and per-argument filtering working</li>
<li>Hit need of SSL for WSS to work, otherwise CORS blocked requests</li>
<li>Got <a href=http://nginx.org/en/docs/http/websocket.html target=_blank rel="noopener noreferrer">nginx to proxy web socket requests</a>!</li>
<li>We found that there are two transport protocols, as websocket is a loose tranport so any library can implement whatever it wants. <a href=https://github.com/graph-gophers/graphql-transport-ws target=_blank rel="noopener noreferrer">Gophers implemented</a> older version, that was compliant with apollo & graphiql but not with graphql-ws</li>
<li>Hit issue that apollo federation lib did not like <code>Subscription</code> in <a href=https://github.com/pipedrive/graphql-schema-registry target=_blank rel="noopener noreferrer">schema registration</a>. We figured that we can clean only Subscription type from root to have other types checked for collisions</li>
</ul>
<p>Basic filtering was pretty simple, you just need to connect two streams (channels) — kafka and web sockets (that gophers need as schema resolvers) while having a goroutine in the middle transforming data</p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/3712/1*zXxbPFcX5Xqu7zGz8k3kSw.png alt=https://miro.medium.com/max/3712/1*zXxbPFcX5Xqu7zGz8k3kSw.png class=img_sJtY></p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/3668/1*0dXQgXJcVTET0AswerSujA.png alt=https://miro.medium.com/max/3668/1*0dXQgXJcVTET0AswerSujA.png class=img_sJtY></p>
<p>We’ve hit a major <a href=https://github.com/graph-gophers/graphql-transport-ws/pull/9 target=_blank rel="noopener noreferrer">roadblock with gophers</a> and JWT authentication, we’re not that experienced in <em>go</em> & don’t have much time to start changing a major framework.</p>
<p>We also figured that enrichment is not a priority, and we need to bring code into production 🚀 and test scaling. Thats the agile way.</p>
<p>Second big blocker — entity visibility checks. Reading domain events from kafka means that we don’t have extra information, like who can see a deal. We need to query some service about this. Doing it on every event of every company likely can lead to DoS 🤦‍♂️</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=gqlgen><strong>Gqlgen</strong><a href=#gqlgen class=hash-link aria-label="Прямая ссылка на gqlgen" title="Прямая ссылка на gqlgen">​</a></h2>
<p>We scratch gophers, switch to gqlgen. Channel exchange logic remains the same and we get JWT token authentication working. Difference is that now subscription events are autogenerated based on schema.graphql.</p>
<p>Next, I find that exchange (in-memory pub-sub in go) is kinda flawed, we need at least 1 subscription for streaming to take place.. newer version is a bit better and allows to have channel per-company.</p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/2532/1*_tIlshM1g5F8tYgIN4qAfQ.png alt=https://miro.medium.com/max/2532/1*_tIlshM1g5F8tYgIN4qAfQ.png class=img_sJtY></p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/2176/1*w6B9z69_upq05WXXb2Vt5Q.png alt=https://miro.medium.com/max/2176/1*w6B9z69_upq05WXXb2Vt5Q.png class=img_sJtY></p>
<p>We also start brainstorming how schema should look like to have it scalable across different entitites, have filters, have multiple entity actions and multiple ids supported.</p>
<p>1 month in. We have UI working with hacked but performant permission check. We take vacations to cool off 🌴 And only now I see this 🤯 presentation by <a href=https://twitter.com/mandiwise target=_blank rel="noopener noreferrer">Mandi Wise</a> from Apollo, even though I’ve gone through most of youtube videos by that time..</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=final-architecture><strong>Final architecture</strong><a href=#final-architecture class=hash-link aria-label="Прямая ссылка на final-architecture" title="Прямая ссылка на final-architecture">​</a></h2>
<p>So we come back and scratch gqlgen again, it was painful but well.. agile. We split service in <strong>two</strong>, adding redis pub-sub with replication and sentinel in between</p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/1400/1*JDm6Oo8YfE1-r7lzttAyNQ.png alt=https://miro.medium.com/max/1400/1*JDm6Oo8YfE1-r7lzttAyNQ.png class=img_sJtY></p>
<ul>
<li>graphql-subscription-workers remains in go, but becomes way simpler — it is be able to scale well to consume all kafka partitions. Workers filter out events by doing 10x parallel permissions checks and transform event schema if needed</li>
<li>graphql-subscriptions deals with connections & scales horizontally as much as needed. It leverages great <a href=https://github.com/enisdenjo/graphql-ws target=_blank rel="noopener noreferrer">graphql-ws</a> library that has all sorts of hooks, so kudos to <a href=https://github.com/enisdenjo target=_blank rel="noopener noreferrer">Denis Badurina</a></li>
<li>redis pub-sub serves as exchange broker doing most of the filtering & sharding by company, user and entity ids.</li>
</ul>
<p>For example, worker pushes to message channel: <code>&lt;companyId>.deal.&lt;dealId></code>. This is very similar to rabbitMQ routing as it also provides regex wildcard matching by the subscribers. This allows us to theoretically subscribe to <code>&lt;companyId>.*</code> and handle all events if such need arises.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=subscription-schema-types><strong>Subscription schema types</strong><a href=#subscription-schema-types class=hash-link aria-label="Прямая ссылка на subscription-schema-types" title="Пряма�я ссылка на subscription-schema-types">​</a></h2>
<p>So as you can see from the diagram, we followed Mandi’s advice and wrote event enrichment by querying gateway. This did require polling of federated schema and hard-coded resolvers of which query specific entity must make, but it gives immence flexibility to the frontend</p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/2376/1*zBOSyHn9wocWYbXR7r80gA.gif alt=https://miro.medium.com/max/2376/1*zBOSyHn9wocWYbXR7r80gA.gif class=img_sJtY></p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/3504/1*dauu7v8ZBwU667SdCCBBnA.png alt=https://miro.medium.com/max/3504/1*dauu7v8ZBwU667SdCCBBnA.png class=img_sJtY></p>
<p>Schema choices we had to make:</p>
<ul>
<li>we do not merge original event with enriched one, although we could. This is because we don’t have guarantees that graphql-service responds in timely manner. Kafka “raw” event data is much more reliable. We also have minor differences in schema when referencing is used (raw deal.stageId vs enriched <a href=http://deal.stage.id target=_blank rel="noopener noreferrer">deal.stage.id</a>)</li>
<li>we added “delta” as JSON, mostly because frontend really wanted to use that in case frontend storage wanted to update only specific keys. This requires specific shape of kafka event though</li>
<li>we have a generic event type (dealEvent) along side with action-specific events (dealAdded), because generic events take into account correct order of events for the same entity ( added -> changed -> deleted ) which is not guaranteed chronologically if you subscribe to separate types</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=live-queries><strong>Live queries</strong><a href=#live-queries class=hash-link aria-label="Прямая ссылка на live-queries" title="Прямая ссылка на live-queries">​</a></h2>
<p>This a cool concept that elegantly fixes a problem which I was really fixated on — connection loss.</p>
<p>From to <a href=https://the-guild.dev/blog/subscriptions-and-live-queries-real-time-with-graphql target=_blank rel="noopener noreferrer">Laurin’s article</a> by The Guild, we’ve got same <strong>fetchOrSubscribe</strong> function which first does enrichment request and then subscribes to kafka events using async iterator magic. The difference however is in schema — we use “liveQuery” as an argument, not as a root property.</p>
<p>This thing alone meets 99% of consistency requirements in web apps, without the need to rewind events (using <a href=https://redis.io/docs/data-types/streams/ target=_blank rel="noopener noreferrer">redis streams</a>?). So “cursor-based query revalidation and diffing” that <a href=https://twitter.com/benjamn/status/1579891243798401026 target=_blank rel="noopener noreferrer">Ben Newman suggested at last Graphql Summit</a> seems like a very rare use case where you want to rewind events as a niche product feature (in gaming?)</p>
<h1><strong>Performance & security testing</strong></h1>
<p>Finally, by the mission end we tested how well our solution scales in production, gradually rolling it out to real customers.</p>
<p><img decoding=async loading=lazy src=https://miro.medium.com/max/1400/1*mHE_vMsNTPr25y7IkePG2Q.png alt=https://miro.medium.com/max/1400/1*mHE_vMsNTPr25y7IkePG2Q.png class=img_sJtY></p>
<p>Performance testing in production</p>
<p>This did reveal interesting things - if you subscribe to <em>deals</em> by IDs… and if you do this in <em>pipeline view</em> where user can scroll very fast, you can have waves of subscriptions. So better to avoid blocking permission checks onSubscribe and have some throttling logic on frontend.</p>
<p>We have had also observed random pods suddenly loosing all of their connections, that has lead us to revise memory limits & <a href=https://github.com/nodejs/node/issues/35573 target=_blank rel="noopener noreferrer">max_old_space_size bug</a>.</p>
<p>We have implemented various security limitations on amount of connections, subscriptions, timeouts, taking into account logouts, permission changes etc. Not only because of external risks, but also because we did find that Redis needs to do a lot of CPU to match <strong>pub</strong>lishers to <strong>sub</strong>scribers.</p>
<h1><strong>Future steps</strong></h1>
<p>Theoretically, we could shard Redis instances by entity types if we would face performance problems.</p>
<p>We could force socketqueue deprecation by <em>temporarily</em> adding api events as a universal subscription, proxying all data to the frontend without any filtering. Sacrifice efficiency for the sake of having single transport layer.</p>
<p>We have had service operational for over a year now and so far got ~10 entities supported, tied to different kafka topics</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=in-defence-of-graphql><strong>In defence of GraphQL</strong><a href=#in-defence-of-graphql class=hash-link aria-label="Прямая ссылка на in-defence-of-graphql" title="Прямая ссылка на in-defence-of-graphql">​</a></h2>
<p>Adoption of GraphQL and subscriptions in particular is seen as slow, although it is voluntary.</p>
<p>With <a href="https://youtu.be/UZWe5Usun7I?t=4130" target=_blank rel="noopener noreferrer">codegen</a> that can wrap REST API, it can be seen as complex, without — as too demanding of service refactoring, alongside a REST API — as redundant, with <a href=https://www.apollographql.com/docs/federation/ target=_blank rel="noopener noreferrer">federation</a> — as having too many layers, with <a href=https://github.com/graphql/dataloader target=_blank rel="noopener noreferrer">dataloader</a> but without observability — as doing <a href=https://twitter.com/Popeska/status/1592177670212943873 target=_blank rel="noopener noreferrer">too many poorly batched RPC calls</a>.</p>
<p>Return on investment is not seen, if <em>value</em> is not measured.</p>
<p>GraphQL has taken onto itself a big responsibility of making web more transparent, predictable, reusable and more efficient. I urge developers 🌞 to have professional patience — educate your colleagues, deliver <strong>hard metrics</strong> to managers, proving GraphQL superiority.</p>
<p>My dream is that there will come a day when devs will replace schema-less WS events & REST APIs with GraphQL and subscriptions for anyone to consume. Clients are our future, this is the way</div><footer class=docusaurus-mt-lg><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><a href="https://github.com/tot-ra/kurapov.ee/tree/main/blog/tech/Dream of scalable & enriched graphql-subscriptions.md" target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_wrwg aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Отредактировать эту страницу</a></div><div class="col lastUpdated_VnXK"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Навигация по странице поста блога"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/психология/Об этике пчеловодства"><div class=pagination-nav__sublabel>Следующий пост</div><div class=pagination-nav__label>Об этике пчеловодства</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/tech/Journey to a Federated GraphQL"><div class=pagination-nav__sublabel>Предыдущий пост</div><div class=pagination-nav__label>Journey to a Federated GraphQL</div></a></nav></main><div class="col col--2"><div class="tableOfContents_m6jX thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#risks class="table-of-contents__link toc-highlight"><strong>Risks</strong></a><li><a href=#gophers class="table-of-contents__link toc-highlight"><strong>gophers</strong></a><li><a href=#gqlgen class="table-of-contents__link toc-highlight"><strong>Gqlgen</strong></a><li><a href=#final-architecture class="table-of-contents__link toc-highlight"><strong>Final architecture</strong></a><li><a href=#subscription-schema-types class="table-of-contents__link toc-highlight"><strong>Subscription schema types</strong></a><li><a href=#live-queries class="table-of-contents__link toc-highlight"><strong>Live queries</strong></a><li><a href=#in-defence-of-graphql class="table-of-contents__link toc-highlight"><strong>In defence of GraphQL</strong></a></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title>Короткие мысли</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://www.tiktok.com/@artkurapov target=_blank rel="noopener noreferrer" class=footer__link-item>TikTok<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://twitter.com/tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Twitter<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.threads.com/@tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Threads<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://t.me/+4kDpExZlraQ0NGZk target=_blank rel="noopener noreferrer" class=footer__link-item>Telegram<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://bsky.app/profile/tot-ra.bsky.social target=_blank rel="noopener noreferrer" class=footer__link-item>Bluesky<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://vk.com/artkurapov target=_blank rel="noopener noreferrer" class=footer__link-item>ВКонтакте<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://tot-ra.livejournal.com/ target=_blank rel="noopener noreferrer" class=footer__link-item>ЖЖ<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div><div class="col footer__col"><div class=footer__title>Business</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://calendly.com/artkurapov/30min target=_blank rel="noopener noreferrer" class=footer__link-item>Calendly<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.linkedin.com/in/kurapov/ target=_blank rel="noopener noreferrer" class=footer__link-item>LinkedIn<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://github.com/tot-ra target=_blank rel="noopener noreferrer" class=footer__link-item>GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://medium.com/@tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Medium<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href="https://stackoverflow.com/users/158448/artjom-kurapov?tab=profile" target=_blank rel="noopener noreferrer" class=footer__link-item>Stack Overflow<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.slideshare.net/totra/presentations target=_blank rel="noopener noreferrer" class=footer__link-item>Slideshare<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://habr.com/ru/users/tot_ra/posts/ target=_blank rel="noopener noreferrer" class=footer__link-item>Habr<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div><div class="col footer__col"><div class=footer__title>Community</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://www.youtube.com/user/artkurapov/ target=_blank rel="noopener noreferrer" class=footer__link-item>Long videos on Youtube<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.twitch.tv/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Streams on Twitch<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.instagram.com/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Природа в Instagram<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.facebook.com/artkurapov target=_blank rel="noopener noreferrer" class=footer__link-item>Facebook<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.reddit.com/user/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Reddit<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div><div class="col footer__col"><div class=footer__title>Multimedia</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://suno.com/@tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Music on Suno<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://goodreads.com/tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Books on Goodreads<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://steamcommunity.com/id/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Games on Steam<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://open.spotify.com/user/1176479585 target=_blank rel="noopener noreferrer" class=footer__link-item>Music on Spotify<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://soundcloud.com/tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Music on Soundcloud<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.thingiverse.com/tot_ra/designs target=_blank rel="noopener noreferrer" class=footer__link-item>3D models on Thingiverse<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.pinterest.com/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Pinterest<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright © 2025</div></div></div></footer></div>