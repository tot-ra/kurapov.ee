<!doctype html><html lang=ru dir=ltr class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>19 записей с тегом "backend" | Артём Курапов</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:image content=https://kurapov.ee/img/docusaurus-social-card.jpg><meta data-rh=true name=twitter:image content=https://kurapov.ee/img/docusaurus-social-card.jpg><meta data-rh=true property=og:url content=https://kurapov.ee/blog/tags/backend><meta data-rh=true property=og:locale content=ru><meta data-rh=true name=docusaurus_locale content=ru><meta data-rh=true name=docsearch:language content=ru><meta data-rh=true property=og:title content='19 записей с тегом "backend" | Артём Курапов'><meta data-rh=true name=docusaurus_tag content=blog_tags_posts><meta data-rh=true name=docsearch:docusaurus_tag content=blog_tags_posts><link data-rh=true rel=icon href=/img/favicon/favicon.ico><link data-rh=true rel=canonical href=https://kurapov.ee/blog/tags/backend><link data-rh=true rel=alternate href=https://kurapov.ee/blog/tags/backend hreflang=ru><link data-rh=true rel=alternate href=https://kurapov.ee/blog/tags/backend hreflang=x-default><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="Артём Курапов RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="Артём Курапов Atom Feed"><link rel=stylesheet href=/assets/css/styles.f16a072c.css><script src=/assets/js/runtime~main.148adc91.js defer></script><script src=/assets/js/main.4f7edb4f.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Перейти к основному содержимому"><a class=skipToContent_aCxL href=#__docusaurus_skipToContent_fallback>Перейти к основному содержимому</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Переключить навигационную панель" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/artjom.webp alt="Artjom Kurapov" class="themedComponent_cfDz themedComponent--light_Kj2W"><img src=/img/artjom.webp alt="Artjom Kurapov" class="themedComponent_cfDz themedComponent--dark__Nfe"></div><b class="navbar__title text--truncate">Артём Курапов</b></a><a class="navbar__item navbar__link" href="/docs/Об авторе">Об авторе</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/blog>Блог</a></div><div class="navbar__items navbar__items--right"><a href=https://github.com/tot-ra/kurapov.ee target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><div class="toggle_LxwK colorModeToggle_c2rS"><button class="clean-btn toggleButton_gSiH toggleButtonDisabled_GY0v" type=button disabled title="Переключение между темным и светлым режимом (сейчас используется Светлый режим)" aria-label="Переключение между темным и светлым режимом (сейчас используется Светлый режим)" aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_WH3Q><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_OWtW><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_vXry></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_jkFy"><div class="container margin-vert--lg"><div class=row><aside class="col col--3"><nav class="sidebar_aM6_ thin-scrollbar" aria-label="Навигация по последним постам в блоге"><div class="sidebarItemTitle_Dvxs margin-bottom--md">Последние заметки</div><div role=group><h3 class=yearGroupHeading_ZKt1>2025</h3><ul class="sidebarItemList_X9hj clean-list"><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/всякое/Фото старинного Таллинна">всякое/Фото старинного Таллинна</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/вера/От чего спасает Христос">вера/От чего спасает Христос</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2025/05/07/события/ AWS Gen AI meetup"> AWS Gen AI meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2025/04/29/события/ AGI - Beyond the Hype Before the Storm">AGI: Beyond the Hype, Before the Storm</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2025/04/28/события/ Decentralized AI event"> Decentralized AI event</a></ul></div><div role=group><h3 class=yearGroupHeading_ZKt1>2024</h3><ul class="sidebarItemList_X9hj clean-list"><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/12/13/события/ Tallinn AI meetup"> Tallinn AI meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/11/26/события/ AI meetup notes"> AI meetup notes</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href=/blog/2024/11/14/события/AI-ED-Webinar>Andmete ja tehisintellekti olulisusest personaliseerituma õppe poole liikumisel by Innar Liiv</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/кино/The Wild Robot">кино/The Wild Robot</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href='/blog/управление/Product team models - project based, "feature factory" and product operating model'>Product team models - project based, feature factory and product operating model</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/tech/devices/Моя коллекция часов в 2024">Моя коллекция часов в 2024</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/tech/soft/Как записывать экран с круглой камерой">Как записывать экран с круглой камерой</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href=/blog/2024/10/18/события/AsuurKeraamika>Asuur Keraamika</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href=/blog/tech/backend/gpu/CUDA>CUDA</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/10/12/события/Katana meetup">Katana meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/10/04/события/Pipedrive meetup">Pipedrive meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/10/01/события/Digit 2024 Tartu">Digit Tartu conference 2024</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/09/25/события/TallinnJS meetup">Tallinn JS meetup</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/2024/05/24/события/Latitude 59">Latitude 59</a><li class=sidebarItem_hoJQ><a class=sidebarItemLink_rV_M href="/blog/управление/hiring/Homework sandboxes">Sandboxes for homework assignments</a></ul></div></nav></aside><main class="col col--7"><header class=margin-bottom--xl><h1>19 записей с тегом "backend"</h1><a href=/blog/tags>Посмотреть все теги</a></header><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Путь к Федеративному GraphQL">Путь к Федеративному GraphQL</a></h2><div class="container__LhH margin-vert--md"><time datetime=2020-09-09T10:00:00.000Z>9 сентября 2020 г.</time> · <!-- -->14 мин. чтения</div></header><div class=markdown><p><img decoding=async loading=lazy src=/assets/images/e28dc66e8bb64f31576418ef1b102685-d28033219b614b9e24f66c8824864013.png width=1400 height=767 class=img_sJtY></p>
<p>Картинка с dgraph.io</p>
<p>Программисты любят хорошие истории, поэтому надеюсь что пятилетний путь к композитному API с помощью GraphQL в боевой среде (на пике выдающей 110 запросов в секунду при 100мс задержке) будет интересен.</p>
<p>[Если вы спешите, проскрольте ниже к <em>урокам</em> и гляньте на открытый код <a href=https://github.com/pipedrive/graphql-schema-registry target=_blank rel="noopener noreferrer">graphql-schema-registry</a>]</p>
<p><img decoding=async loading=lazy src=/assets/images/c0651522464466d29683331192513234-0d6725afcb058e05cf879c4af95bb1dc.png width=1400 height=726 class=img_sJtY></p>
<p>schema registry с примером тестовой схемы</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=задача>Задача<a href=#задача class=hash-link aria-label="Прямая ссылка на Задача" title="Прямая ссылка на Задача">​</a></h2>
<p>Годами, <a href=https://www.pipedrive.com/ target=_blank rel="noopener noreferrer">Pipedrive</a> (которому в начале 2020 стукнуло уже 10 лет), давал публичный <a href=https://developers.pipedrive.com/docs/api/v1/ target=_blank rel="noopener noreferrer">REST API</a> где были и недокументированные пути для нашего веб приложения. Один из них /users/self, который изначально задумывался для загрузки информации о пользователе, нормально с течением времени стал грузить все что надо для первой загрузки страницы, доходя до 30 разных типов сущностей. Сам он выдавался PHP монолитом, который по натуре синхронный. Мы <a href=https://medium.com/pipedrive-engineering/how-two-developers-accelerated-php-monolith-in-pipedrive-df8a18bc2d8a target=_blank rel="noopener noreferrer">пытались его распараллелить</a>, но неудачно.
<img decoding=async loading=lazy src=/assets/images/2f8932407cb9eab3eed55e354353c688-c614b3189765bdaf3f9679fef3bcd6f7.png width=1000 height=273 class=img_sJtY>
/users/self распределение задержки для оставшегося траффика</p>
<p>С точки зрения поддержки, каждое новое изменение все больше усложняло код и никто не хотел владеть этой огромной функцией.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=прототип-с-прямым-доступом-к-бд>Прототип с прямым доступом к БД<a href=#прототип-с-прямым-доступом-к-бд class=hash-link aria-label="Прямая ссылка на Прототип с прямым доступом к БД" title="Прямая ссылка на Прототип с прямым доступом к БД">​</a></h2>
<p>Давайте вернемся назад в прошлое, когда наши разработчики стали экспериментировать с graphql.</p>
<p>Года 3-4 назад, в команде разработки <a href=https://marketplace.pipedrive.com/ target=_blank rel="noopener noreferrer">рынка приложений</a>, я услышал от <a href=https://twitter.com/bashmach target=_blank rel="noopener noreferrer">Паши</a>, нашего фулл-стек разработчика новенькие для меня термины - <a href=https://elixir-lang.org/ target=_blank rel="noopener noreferrer">elixir</a> и graphql. Он участвовал в тестовом проекте в котором напрямую работал с MySQL и выдавал основные сущности Pipedrive по /graphql.</p>
<p>На локальной машине работало прекрасно, но это не масштабировалось на весь код, потому что функционал - не обычный CRUD, а весь монолит переписывать никто не хотел.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=прототип-со-склейкой>Прототип со склейкой<a href=#прототип-со-склейкой class=hash-link aria-label="Прямая ссылка на Прототип со склейкой" title="Прямая ссылка на Прототип со склейкой">​</a></h2>
<p>Переносимся в 2019, когда я заметил еще один тестовый репозиторий от другого коллеги, который стал использовать GraphQL stitching с определением сущностей с помощью <a href=https://github.com/graphql-compose/graphql-compose target=_blank rel="noopener noreferrer">graphql-compose</a> и резолверами которые делали запрос уже к нашему REST API. Как можете представить, это уже было значительным улучшением, потому что нам не надо было переопределять всю бизнес-логику и graphql становился просто приятной оберткой.</p>
<p>Из недостатков этого решения:</p>
<ul>
<li>
<p><strong>Производительность</strong>. Небыло <a href=https://github.com/graphql/dataloader target=_blank rel="noopener noreferrer">dataloader</a>'а, поэтому был риск N+1 сетевых запросов. Небыло ограничения сложности запроса и какого-либо промежуточного кеширования.</p>
</li>
<li>
<p><strong>Управление схемой</strong>. При склейке типов, мы определяли все сущности в одном репозитории, отдельно от самих сервисов которые этими даннами владеют. Это усложняло деплой - приходилось бы писать обратно-совместимые изменения, что-бы избегать несовпадения схемы и функций.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=подготовка>Подготовка<a href=#подготовка class=hash-link aria-label="Прямая ссылка на Подгот�овка" title="Прямая ссылка на Подготовка">​</a></h2>
<p>В Октябре 2019, я стал готовиться к <a href="https://www.youtube.com/watch?v=ekKp-tA0A9k" target=_blank rel="noopener noreferrer">миссии</a>, которая превратила бы прошлое решение в рабочее с помощью Apollo федерации, которая <a href=https://www.apollographql.com/blog/apollo-federation-f260cf525d21/ target=_blank rel="noopener noreferrer">вышла чуть ранее</a> в этом же году. Кроме того, результат приземлился бы в команде <em>Core</em>, которая стала бы поддерживать его в долгосрочной перспективе.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=сбор-ожиданий-разработчиков>Сбор ожиданий разработчиков<a href=#сбор-ожиданий-разработчиков class=hash-link aria-label="Прямая ссылка на Сбор ожиданий разработчиков" title="Прямая ссылка на Сбор ожиданий разработчиков">​</a></h2>
<p>В компании некоторые разработчики были довольно скептичны и предлагали построить свое решение просто склеивая запросы воедино, отправляя по POST и надеясь на свой gateway который будет распараллеливать обработку.</p>
<p>Другие считали что graphql еще слишком сырой что-бы использовать в жизни и лучше подождать. Третьи предлагали рассмотреть альтернативы, типа Protobuf и Thrift, а в качестве транспорта рассмотреть <a href=https://grpc.io/ target=_blank rel="noopener noreferrer">GRPC</a>, <a href=https://www.odata.org/ target=_blank rel="noopener noreferrer">OData</a>.</p>
<p>Четвертые напротив, на полном ходу писали graphql под одиночные сервисы (insights, teams) и выкатывали в лайв, однако не могли повторно использовать сущности (например User). В <a href=https://www.pipedrive.com/en/jobs/czech-republic target=_blank rel="noopener noreferrer">Праге</a> ребята написали все на typescript + <a href=https://relay.dev/ target=_blank rel="noopener noreferrer">relay</a> на фронтенде, который нам еще предстоит <a href=https://github.com/apollographql/apollo-server/issues/3159 target=_blank rel="noopener noreferrer">перенести в федерацию</a>.</p>
<p>Изучать новую технологию было круто.</p>
<p>Строгий, само-документирующийся API для фронтендеров? Глобально определяемые сущности уменьшающие дублирование и улучшающие прозрачность и владение среди всех команд? Gateway который автоматом делает под-запросы и между сервисами без избыточной выборки? Ухх.</p>
<p>Впрочем, я знал что нам понадобится управлять схемой как-то динамически, что-бы не полагаться на захардкоженые значения и видеть что происходит. Нечно типа <a href=https://docs.confluent.io/current/schema-registry/index.html target=_blank rel="noopener noreferrer">Confluent’s schema-registry</a> или <a href=https://bitbucket.org/atlassian/graphql-braid/src/master/ target=_blank rel="noopener noreferrer">Atlassian’s Braid</a>, но они либо под Кафку делались, либо на Java, которую мы не хотели поддерживать.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=план>План<a href=#план class=hash-link aria-label="Прямая ссылка на План" title="Прямая ссылка на План">​</a></h2>
<p>Я выступил с инженерной миссией у которой было 3 цели:</p>
<ul>
<li>
<p>Уменьшение первичной загрузки страницы (<em>воронка продаж</em>) на 15%. Достижимо если заменить некоторые REST запросы в один /graphql</p>
</li>
<li>
<p>Уменьшение траффика на 30%. Достижимо если перенести загрузку всех <em>сделок для воронки продаж</em> в graphql и спрашивать меньше свойств.</p>
</li>
<li>
<p>Использовать строгую типизацию (что-бы фронтендерам надо было писать меньше кода в <a href=https://en.wikipedia.org/wiki/Defensive_programming target=_blank rel="noopener noreferrer">защитном стиля</a>)</p>
</li>
</ul>
<p>Мне повезло, <a href=https://github.com/pipedrive/graphql-schema-registry#honorable-mentions target=_blank rel="noopener noreferrer">трое разработчиков</a> присоединились к миссии, в т.ч. автор прототипа.</p>
<p><img decoding=async loading=lazy src=/assets/images/55e6e4675e2b2ad39f82f66a62e4d05f-b70655d5cee90146aec68a775ece72e5.png width=946 height=477 class=img_sJtY></p>
<p>Сетевые запросы по мере загрузки веб-приложения</p>
<p>Изначальный план по сервисам выглядел так:
<img decoding=async loading=lazy src=/assets/images/e21b54c336353f713dfb5e6cd8a353f2-22c6ebd4a113c37e872623e90991f19f.png width=1400 height=606 class=img_sJtY></p>
<p>Сервисы над которыми предстояло бы работать</p>
<p>Тут schema-registry был бы общим сервисом, который мог бы хранить схему любого типа, получая на входе что вы в него кинете (swagger, typescript, graphql, avro, proto). На выходе он мог бы так же выдавать что вы хотите.</p>
<p>Gateway периодически опрашивал бы schema-registry и вызывал бы уже сервисы которые владеют данными согласно запросу и схеме. В свою очередь frontend компоненты могли бы скачивать актуальную схему для autocomplete и самих запросов.</p>
<p>На деле впрочем, мы сделали только поддержку graphql формата, потому что для федерации его было достаточно, а время как обычно быстро закончилось.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=итоги>Итоги<a href=#итоги class=hash-link aria-label="Прямая ссылка на Итоги" title="Прямая ссылка на Итоги">​</a></h2>
<p>Главную цель по замене /users/self в веб-приложении мы сделали в течение первых двух недель ? (ничоси!). А вот полировка всего решения что-бы оно быстро и надежно работало, заняло все оставшееся время.</p>
<p>К концу миссии (в феврале 2020), мы каким-то чудом достигли 13% ускорения первой загрузки страницы и 25% ускорения при повторной загрузке (из-за добавленного кеширования), согласно синтетическому UI тесту который мы гоняли на <a href=https://www.datadoghq.com/ target=_blank rel="noopener noreferrer">Datadog</a>.</p>
<p>Уменьшить трафик нам не удалось, потому что мы не достигли рефакторинга вида воронки продаж - там все еще REST.</p>
<p>Что-бы ускорить добавление сервисов в федерацию другими командами (у нас 600+ человек), мы записали обучающие видео что-бы все были в курсе как оно все работает вместе. После окончания миссии IOS- и Android- клиенты тоже мигрировали на graphql и в целом были рады.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=выученные-уроки>Выученные уроки<a href=#выученные-уроки class=hash-link aria-label="Прямая ссылка на Выученные уроки" title="Прямая ссылка на Выученные уроки">​</a></h2>
<p>Глядя на дневник миссии из этих 60 дней, могу выделить наибольшие трудности что-бы вам было бы попроще</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=управляйте-своей-схемой>Управляйте своей схемой<a href=#управляйте-своей-схемой class=hash-link aria-label="Прямая ссылка на Управляйте своей схемой" title="Прямая ссылка на Управляйте своей схемой">​</a></h2>
<blockquote>
<p>_Могли бы мы построить это сами? Возможно, но это не было бы так отполировано.<br>
<!-- -->_<a href=https://medium.com/paypal-engineering/scaling-graphql-at-paypal-b5b5ac098810 target=_blank rel="noopener noreferrer"><em>Mark Stuart, Paypal Engineering</em></a></p>
</blockquote>
<p>В течение первых пары дней я попробовал <a href=https://studio.apollographql.com/ target=_blank rel="noopener noreferrer">Apollo studio</a> и их <a href=https://www.apollographql.com/docs/studio/schema-checks/#the-check-process target=_blank rel="noopener noreferrer">инструментарий</a> для терминала по проверке схемы. Сервис прекрасный и работает из коробки с минимальными настройками gateway.</p>
<p><img decoding=async loading=lazy src=https://habrastorage.org/r/w1560/getpro/habr/upload_files/166/7a4/d4f/1667a4d4f5851f4095d94a7bdf8ab8d7.png alt="Написанный нами инструментарий для валидации схемы" title="Написанный нами инструментарий для валидации схемы" class=img_sJtY></p>
<p>Написанный нами инструментарий для валидации схемы</p>
<p>Однако несмотря на все фишки этого облачного сервиса, я посчитал что для такого важного дела как маршрутизация траффика было бы опрометчиво полагаться на сторонний сервис из-за рисков для жизнеспособности нашего дела, несмотря на богатый функционал и сколько-то выгодные расценки. Поэтому мы написали свой сервис с минимально нужным функционалом и теперь отправили его в opensource -  <a href=https://github.com/pipedrive/graphql-schema-registry target=_blank rel="noopener noreferrer"><strong>graphql-schema-registry</strong></a> .</p>
<p>Вторая причина была в том что-бы следовать модели <a href=https://medium.com/pipedrive-engineering/tanker-the-story-of-multi-dc-customer-data-migration-framework-ad842c2c6b9c target=_blank rel="noopener noreferrer">распределенной архитектруры датацентров</a> Pipedrive. У нас нет центрального датацентра, каждый DC самодостаточен. Это дает нам как более высокую надежность, так и способность открывать новые датацентры в Китае, России, Иране или на Марсе ?</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=версионируйте-свою-схему>Версионируйте свою схему<a href=#версионируйте-свою-схему class=hash-link aria-label="Прямая ссылка на Версионируйте свою схему" title="Прямая ссылка на Версионируйте свою схему">​</a></h2>
<p>Федеративная схема и graphql gateway очень хрупкие. Если у вас появится конфликт имен у типов или неверная ссылка между типами в одном из сервисов, то gateway может этого не пережить.</p>
<p>По умолчанию, gateway напрямую <a href=https://www.apollographql.com/docs/apollo-server/federation/introduction/#gateway-example target=_blank rel="noopener noreferrer">опрашивает все сервисы</a> касательно их схемы, поэтому достаточно одного из сервисов с ошибкой что-бы поломать всем трафик. Apollo studio решает это посредством проверки схемы еще до деплоя и отказе если видит какой-то конфликт.</p>
<p>Проверка совместимости схем правильный подход, но конкретное решение у Apollo зависит от их внутреннего состояния, т.к. они хранят правильную склеенную схему на данный момент. Это делает <a href=https://www.apollographql.com/docs/studio/schema/schema-reporting-protocol/#protocol-sequence target=_blank rel="noopener noreferrer">протокол регистрации</a> сложным и <a href=https://www.apollographql.com/docs/studio/schema/schema-reporting/#rolling-deploys-with-schema-reporting target=_blank rel="noopener noreferrer">зависящим от времени</a>.</p>
<p>Мы же напротив, связали версии микросервисов (генерируемые на основе хешей докер-образов) со схемой. Микросервисы регистрируют уже в ходе своей работы и делают это один раз без <a href=https://www.apollographql.com/docs/studio/schema/schema-reporting/#rolling-deploys-with-schema-reporting target=_blank rel="noopener noreferrer">последующих повторений</a>. Gateway делает выборку всех федерированных сервисов из <a href=https://www.consul.io/ target=_blank rel="noopener noreferrer">консула</a> и спрашивает schema-registry составить схему /schema/compose , предоставляя их версии.</p>
<p>Если schema-registry видит что предоставленные версии несовместимы, она откатывается на прошлые версии
<img decoding=async loading=lazy src=/assets/images/ac6951a7e0a2933369f74b934e035e80-0a00afabffc98cc17c18fc5e4823e352.png width=1400 height=580 class=img_sJtY>
<img decoding=async loading=lazy src=/assets/images/3feed981ef1fc75944a76cf3754056b5-a5f59d03438a4c3e8abc7ab59701340e.png width=1304 height=616 class=img_sJtY></p>
<p>Регистрация схемы при старте сервиса</p>
<p>Микросервисы могут выдавать как REST так и Graphql API, поэтому мы используем оповещения тревоги при неудачной регистрации схемы, оставляя при этом работу REST.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=определение-схемы-на-основе-rest-не-просто>Определение схемы на основе REST не просто<a href=#определение-схемы-на-основе-rest-не-просто class=hash-link aria-label="Прямая ссылка на Определение схемы на основе REST не просто" title="Прямая ссылка на Определение схемы на основе REST не просто">​</a></h2>
<p>Поскольку я не знал как лучше перенести схему из нашего REST в graphql, я сначала попробовал <a href=https://github.com/IBM/openapi-to-graphql target=_blank rel="noopener noreferrer">openapi-to-graphql</a>, нормально наша документация на тот момент не имела детального описания запросов и ответов.</p>
<p><img decoding=async loading=lazy src=/assets/images/2fc46dbba5892bd114758c2604b48e46-8096847fb11461df9769b79d501d3dec.png width=772 height=518 class=img_sJtY>
Спрашивать у каждой команды что-бы они написали бы ее, очевидно заняло бы уйму времени, поэтому мы определили основные сущности сами ? просто глядя на ответ при разных REST запросах.</p>
<p>В дальнейшем это нам аукнулось, так как оказалось что REST API иногда зависит от того кто делает запрос, либо зависит от внутреннего состояния и логики.
<img decoding=async loading=lazy src=/assets/images/b30de9ea845324d1f49bb1a79e5b4acb-b6a0e7a1508a3f9340be13c7ab8f3e58.png width=1230 height=517 class=img_sJtY></p>
<p>Например после настраиваемые <em>поля данных</em> меняют REST API в зависимости от пользователя. Если его добавить к сделке, то он оно будет выдаваться с ключем-хешем на уровне deal.pipeline_id. С федеративным graphql, динамическая схема невозможно, поэтому нам пришлось передвигать эти настраиваемые поля в отдельный список</p>
<p>Другая проблема это стиль наименований в json-ответе. Мы хотели поддерживать верблюжийСтиль, но почти весь REST отвечал нам в змеином_стиле, пришлось пока остаться на смешанном.</p>
<p><img decoding=async loading=lazy src=/assets/images/617cbdac0101669627746edf3b773e48-d3ee145f2aa36b7633c43cb755c1dbc2.png width=1560 height=675 class=img_sJtY></p>
<p>федеративный граф данных Pipedrive (слева) с 2 сервисами (из 539) и еще-не-федеративный граф сервиса leads (справа)</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=cqrs-и-кеш>CQRS и кеш<a href=#cqrs-и-кеш class=hash-link aria-label="Прямая ссылка на CQRS и кеш" title="Прямая ссылка на CQRS и кеш">​</a></h2>
<p>Модель данных в Pipedrive не может полагаться на простой TTL-кеш.</p>
<p>Например, когда инженер поддержки создает глобальное оповещение о предстоящем техническом обслуживании приложения из нашей админки, он ожидает что сообщение будет сразу же видно пользователям. Эти глобальные оповещения могут быть адресованы как всем пользователям, так и конкретным компаниям и индивидуальным людям. Чистить такой кеш приходится используя 3 разных ключа.</p>
<p>Что-бы делать параллельные запросы к PHP-монолиту, мы написали сервис на nodejs (назвали его monograph), который кеширует все что отвечает монолит в memcached. Этот кеш надо чистить из монолита в зависимости от бизнес-логики. Это немного антипаттерн, потому что кеш получается общим для разных сервисов и сильно их связывает.</p>
<p><img decoding=async loading=lazy src=/assets/images/a8837cc6450f909abee25a30a2e28981-0cbef379ca0aa9b002bc14f91050f1fd.png width=1232 height=382 class=img_sJtY></p>
<p>Тут можно заметить <a href=https://martinfowler.com/bliki/CQRS.html target=_blank rel="noopener noreferrer">CQRS pattern</a>. Впрочем, такой кеш позволяет ускорять 80% запросов и дает итоговую среднюю задержку такую же как и у монолита.</p>
<p><img decoding=async loading=lazy src=/assets/images/64d0d5bf393aa6ba6bf232332db1d3eb-eddbe86fce681cdb0355bc3cee8535d3.png width=1560 height=401 class=img_sJtY></p>
<p>Время средней задержки ответа монолита (слева) и graphql gateway (справа) в регионе US на основе NewRelic</p>
<p>Еще одна сложность - язык пользователя. Как только он меняется, нам надо чистить уйму разных сущностей - от типов активности до того какие настройки должны быть при показе гугл карт. И что еще хуже - язык уже управляется не в монолите, а был вынесен в отдельный сервис <em>identity</em>. Связывать его с общим кешем очень не хотелось.</p>
<p>Identity владеет данными пользователей, поэтому мы сделали так что он кидает событие через kafka, которое ловит monograph и чистит все нужные кеши. Тут есть недостаток, что событие приходит с задержкой (может максимум 1 сек), поэтому чистка кеша происходит не мгновенно. Нормально это не критично, потому что пользователь не так быстро уходит со страницы что-бы сделать повторный запрос к бекенду и заметить что в кешах еще старый язык.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=следите-за-производительностью>Следите за производительностью<a href=#следите-за-производительностью class=hash-link aria-label="Прямая ссылка на Следите за производительностью" title="Прямая ссылка на Следите за производительностью">​</a></h2>
<p>Производительность была главной целью и для этого нам пришлось хорошо прокачаться в знании APM и выслеживании распределенных запросов между микросервисами что-бы определить самые медленные места. Мы на тот момент использовали Datadog и он хорошо себя зарекомендовал.</p>
<p>Для ускорения, мы кешировали все 30 параллельных запросов в memcached. Но по ходу дела возникали проблемы. Например на картинке слева видно что некоторые резолверы делают запрос в memcached и получают ответ за 10мс, а другие тупят, словно жду своей очереди выростая до 220мс. Как оказалось, это было из-за того что я использовал один и тот же хост <a href=https://github.com/facebook/mcrouter target=_blank rel="noopener noreferrer">mcrouter</a>. Как только я стал их ротировать, мемкеш стал отдавать все за 20мс максимум.</p>
<p>Что-бы уменьшить количество этих сетевых запросов к мемкешу, мы склеили его в один используя <a href=https://github.com/3rd-Eden/memcached#public-methods target=_blank rel="noopener noreferrer">getMulti</a> функцию. Получается что несмотря на то что все resolver'ы выполняются независимо, они блочатся на 5мс с помощью debounce и склеиваются воедино.</p>
<p><img decoding=async loading=lazy src=/assets/images/1dc6beb1bfea7bfe18afdd32f3fbefa6-92e0ffd5c4629b52815bf1b5292bcaca.png width=1560 height=564 class=img_sJtY></p>
<p>На картинке справа видна другая проблема. Эти желтые линии это налог graphql gateway на приведение данных к строгому типу. Причем чем больше данных вы гоняете через сервис, тем дольше будет эта фаза выполнятся.</p>
<p><img decoding=async loading=lazy src=/assets/images/65652f1707e2c00f50b1cae39c4c04b8-2148bc2a79105bb3de31d98d9d45eb77.png width=1000 height=561 class=img_sJtY></p>
<p>Вобщем по ходу миссии постоянно приходилось мониторить какие же запросы нам надо еще закешировать и под конец стало бесить что скажем 28 из 30 запросов прекрасно кешируются, а оставшиеся два мало того что отвечают целых 500мс, так их еще и невозможно легко закешировать.</p>
<p>Нам пришлось вынести их в отдельный graphql запрос, который делается после первого /graphql запроса на инициализацю страницы. Так что сейчас мы на деле делаем уже порядка 3-5 независимых запросов, в зависимости от тайминга фронтенда (там тоже debounce зависящий от параллельной подгрузки FE компонентов)</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=не-следите-за-производительностью>Не следите за производительностью<a href=#не-следите-за-производительностью class=hash-link aria-label="Прямая ссылка на Не следите за производительностью" title="Прямая ссылка на Не следите за производительностью">​</a></h2>
<p>Казалось бы полностью противоположный урок, но на деле это значит что в лайв-среде вам лучше отключить мониторинг приложения (APM) и <a href=https://www.apollographql.com/docs/apollo-server/api/apollo-server/#apolloserver target=_blank rel="noopener noreferrer">tracing<!-- -->:true</a>, если вы используете их.</p>
<p><img decoding=async loading=lazy src=/assets/images/7ed98ffd99435aa8f49204f198739783-feb27d1f66a9bc17778ab082878f60fc.png width=1000 height=550 class=img_sJtY></p>
<p>Отключение отслеживания у нас ускорило среднюю задержку в два раза с 700мс до 300мс для нашей тестовой компании. Насколько я понимаю, причина крылась в функциях которые замеряют время (типа performance.now()), которые необходимы для замера каждого резолвера.</p>
<p>Мы делали профайлинг graphql gateway с помощью  <a href=https://medium.com/@paul_irish/debugging-node-js-nightlies-with-chrome-devtools-7c4a1b95ae27 target=_blank rel="noopener noreferrer">Chrome DevTools</a>, но так просто вызов этих мелких функций, раскиданных повсюду не заметишь.</p>
<p><a href="https://www.youtube.com/watch?v=VnG7ej56lWw" target=_blank rel="noopener noreferrer">Бен тут</a> делал замеры и тоже пришел к этому.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=попробуйте-ранний-запрос>Попробуйте ранний запрос<a href=#попробуйте-ранний-запрос class=hash-link aria-label="Прямая ссылка на Попробуйте ранний запрос" title="Прямая ссылка на Попробуйте ранний запрос">​</a></h2>
<p>На фронтенде, время создания graphql запроса для нас оказалось сложновато. Я хотел передвинуть первый /graphql как можно раньше (даже до загрузки всего кода в vendors.js) в графике сетевых запросов. Мы смогли это сделать, но веб-приложение из-за этого стало значительно сложней.</p>
<p>Что-бы делать запрос вам понадобится <a href=https://github.com/apollographql/apollo-client target=_blank rel="noopener noreferrer">graphql клиент</a> и парсинг <a href=https://github.com/apollographql/graphql-tag target=_blank rel="noopener noreferrer">gql литералов</a> для определения самого запроса. Дальше его надо либо выдавать в отдельном bundle, либо отказываться от всех удобств и использовтать сырой <a href=https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch target=_blank rel="noopener noreferrer">fetch</a>. Даже если делать сырой запрос, дальше надо что-то делать с ответом - распределять данные по моделям либо сохранять в глобальную переменную. Вобщем мы решили отказаться от этого и надеяться на server-side-rendering и <a href=https://medium.com/samsung-internet-dev/a-beginners-guide-to-service-workers-f76abf1960f6 target=_blank rel="noopener noreferrer">service workers</a> в будущем.
<img decoding=async loading=lazy src=/assets/images/45a6bc6fa90a4b4d4f92170543daa475-7e0b3c2aac26da753727ff6a62d44712.png width=1400 height=682 class=img_sJtY></p>
<p>Перенос /graphql запроса левей</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=оценивайте-сложность-запроса>Оценивайте сложность запроса<a href=#оценивайте-сложность-запроса class=hash-link aria-label="Прямая ссылка на Оценивайте сложность запроса" title="Прямая ссылка на Оценивайте сложность запроса">​</a></h2>
<p>Чем graphql примечателен, так это то что тут можно оценивать насколько больно запрос клиента будет бить по инфраструктуре не делая при этом еще никакой работы. Для оценки сложности надо указывать цену внутри самой схемы с помощью директив, а дальше делать саму проверку при получении запроса и отклонять его если сложность слишком велика, подобно нашему <a href=https://pipedrive.readme.io/docs/core-api-concepts-rate-limiting target=_blank rel="noopener noreferrer">rate limit</a> на частоту запросов.</p>
<p>Сначала мы попробовали <a href=https://github.com/pa-bru/graphql-cost-analysis target=_blank rel="noopener noreferrer">graphql-cost-analysis</a> библиотеку, но в итоге написали свою, поскольку захотели больше фич - множителях при выдаче списков данных, вложенности и рекурсии, а так же определении типов влияния на инфраструктуру (сетевой запрос, БД, CPU, работа с файлами). Тут сложней всего оказалось внедрять поддержку своей директивы в gateway и schema-registry. Надеюсь мы нашу библиотеку тоже опубликуем.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=у-схемы-много-лиц>У схемы много лиц<a href=#у-схемы-много-лиц class=hash-link aria-label="Прямая ссылка на У схемы много лиц" title="Прямая ссылка на У схемы много лиц">​</a></h2>
<p>Работать со схемой в js/typescript на низком уровне порой мучительно. Это начинаешь понимать когда пробуешь интегрировать существующий graphql сервис в федерацию.</p>
<p>Например настройки <a href=https://github.com/graphql-community/koa-graphql#options target=_blank rel="noopener noreferrer">koa-graphql</a> и <a href=https://www.apollographql.com/docs/apollo-server/v1/servers/koa/ target=_blank rel="noopener noreferrer">apollo-server-koa</a> ожидают что вы создадите вложенный объект  <a href=https://github.com/graphql/graphql-js#using-graphqljs target=_blank rel="noopener noreferrer"><strong>GraphQLSchema</strong></a>  который включает и сами резолверы. Но федеративный apollo/server <a href=https://www.apollographql.com/docs/apollo-server/federation/implementing-services/#generating-a-federated-schema target=_blank rel="noopener noreferrer">хочет схему и резолверы отдельно</a>:</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">buildFederatedSchema([{typeDefs, resolvers}])</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>В другом случае, как я уже писал, вам захочется определить схему с помощью <a href=https://github.com/apollographql/graphql-tag target=_blank rel="noopener noreferrer">gql литерала</a>, или сохранить схему в schema.graphql файл, а когда вам надо будетделать проход по всей схеме для оценки сложности, понадобится <a href=https://github.com/graphql/graphql-js/blob/master/src/language/ast.js target=_blank rel="noopener noreferrer">ASTNode</a> (и функции <a href=https://github.com/graphql/graphql-js/blob/d4c82e0849318d045107321c6655c1a5da37b798/src/language/parser.d.ts#L58 target=_blank rel="noopener noreferrer">parse</a> / <a href=https://github.com/graphql/graphql-js/blob/dd0297302800347a20a192624ba6373ee86836a3/src/utilities/buildASTSchema.js#L121 target=_blank rel="noopener noreferrer">buildASTSchema</a>)</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=плавная-canary-деплой>Плавная canary деплой<a href=#плавная-canary-деплой class=hash-link aria-label="Прямая ссылка на Плавная canary деплой" title="Прямая ссылка на Плавная canary деплой">​</a></h2>
<p>Во время миссии мы выкатывали изменения сначала всем разработчикам что-бы отследить очевидные ошибки.</p>
<p>Под конец миссии в феврале, мы выкатили graphql только на 100 компаний-"везунчиков". Дальше мы медленно выкатывали их до 1000 компаний, потом 1%, 10%, 30%, 50% и наконец в июне выкатили всем.</p>
<p>Деплоили мы просто используя логику деления company ID без остатка. В дополнение, у нас было несколько настроек - кому еще включать, кому не включить никогда и рубильник выключающий graphql сразу у всех на фронтенде. Было очень полезно во время инцидентов сразу избавиться от подозрений что это все из-за нового graphql и упростить дебаг.</p>
<p>Учитывая насколько большие изменения мы делали, это был хороший опыт быстро получить обратную связь, найти баги (с кешированием), при этом снизив риски для большинства пользователей.</p>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=надежды-и-мечты>Надежды и мечты<a href=#надежды-и-мечты class=hash-link aria-label="Прямая ссылка на Надежды и мечты" title="Прямая ссылка на Надежды и мечты">​</a></h2>
<p>Что-бы достичь всех плюшек от того что graphql может нам дать, надо еще много что поменять - добавить мутации, подписки, массовые операции на уровне федерации. Все это требует работы с командами и евангелизм что-бы увеличить количество федерируемых сервисов.</p>
<p>Как только наш graphql API станет стабильным и достаточным для использования любыми пользователями, его можно выкатить в качестве второй версии нашего API. Для публикации впрочем понадобятся еще директивы для ограничения доступа к сущностям согласно <a href=https://oauth.net/2/scope/ target=_blank rel="noopener noreferrer">OAuth видимости</a> (для приложений из рынка) и согласно нашим <a href=https://www.pipedrive.com/en/pricing target=_blank rel="noopener noreferrer">продуктам</a>.</p>
<p>В самой schema-registry надо добавить отслеживание клиентов, связать ее gateway для получения аналитики трафика что-бы проще было понять какие поля можно удалять, надо добавить фильтрацию и подсветку сущностей в зависимости от директив цены и видимости, валидировать именование, хранить постоянные запросы (persisted query), публиковать историю изменений итоговой схемы для сторонних разработчиков.</p>
<p>Кроме того, поскольку у нас есть сервисы на go, еще непонятно как стоит делать внутренний трафик - стоит ли использовать GRPC из-за скорости и надежности, либо использовать независимые graphql эндпоинты, либо ставить централизованный внутренний gateway. Если GRPC лучше только из-за его бинарности, может мы можем написать библиотечку которая тоже упакует graphql данные с помощью <a href=https://msgpack.org/ target=_blank rel="noopener noreferrer">msgpack</a>?</p>
<p>Что касается внешнего мира, надеюсь Apollo со своим <a href="https://www.youtube.com/watch?v=MvHzOwdLb_o" target=_blank rel="noopener noreferrer">проектом Constellation</a> ускорят обработку запроса на Rust что-бы небыло этих 10% налога на производительность и смогут федерировать graphql сервисы без серьезных изменений последних.</p>
<p>Вобщем прекрасное время что-бы наслаждаться разработкой где уйма сложности!</div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Шпаргалка по golang - часть 1">Шпаргалка по golang</a></h2><div class="container__LhH margin-vert--md"><time datetime=2018-04-18T10:00:00.000Z>18 апреля 2018 г.</time> · <!-- -->3 мин. чтения</div></header><div class=markdown><p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019193324-2e3bc176acc7171df381d8de660e89f2.png" width=1280 height=720 class=img_sJtY></p>
<p>После php и node начал писать на go, поэтому по-аналогии с unix-шпаргалкой, выпишу для себя основы..</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=запуск>Запуск<a href=#запуск class=hash-link aria-label="Прямая ссылка на Запуск" title="Прямая ссылка на Запуск">​</a></h3>
<p>go run main.go → компиляция и запуск exe<br>
<!-- -->go build main.go → только компиляция и создание exe, без запуска<br>
<!-- -->go get -u <a href=https://github.com/x/y target=_blank rel="noopener noreferrer">https://github.com/x/y</a> → импортирование зависимостей</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=переменные-и-типы>Переменные и типы<a href=#переменные-и-типы class=hash-link aria-label="Прямая ссылка на Переменные и типы" title="Прямая ссылка на Переменные и типы">​</a></h3>
<table><thead><tr><th><th><th><tbody><tr><td>тип<td>декларация<td>значение по умолчанию<tr><td>целые<td>int8, int 16, int32, int64, uint, uint64<td>0<tr><td>бинарные<td>byte<td><tr><td>бит<td>bool<td>false<tr><td>с плавающей точкой<td>float, float32, float64<td>0<tr><td>строка<td>string, rune<td>(пустая строка)</table>
<div class="language-go codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-go codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>var</span><span class="token plain"> i </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>10</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>var</span><span class="token plain"> myfirstvar</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> mysecondvar </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>3</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>4</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// объявление разом</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>var</span><span class="token plain"> autoInt </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>-</span><span class="token number" style=color:#36acaa>10</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// компилятор сам подберёт тип</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>var</span><span class="token plain"> mystring </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"test\n"</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// двойные для строк, всё в уникоде</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>var</span><span class="token plain"> mysymbol </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token char">'\u2318'</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// один символ</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>var</span><span class="token plain"> rawBinary </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token char">'\x27'</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// одинарные кавычки для символа</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">myNewDeclared </span><span class="token operator" style=color:#393A34>:=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>42</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// быстрая инициализация</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">myMathVar </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>7</span><span class="token operator" style=color:#393A34>+</span><span class="token number" style=color:#36acaa>3i</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// математикам</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=приведение-типов>Приведение типов<a href=#приведение-типов class=hash-link aria-label="Прямая ссылка на Приведение типов" title="Прямая ссылка на Приведение типов">​</a></h3>
<div class="language-go codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-go codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token function" style=color:#d73a49>int</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">myfloat</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>float64</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">myInt</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>string</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>48</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//будет номер символа, а не строчка "48"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">bin </span><span class="token operator" style=color:#393A34>:=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token function" style=color:#d73a49>byte</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">mystr</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//перевод строки в массив байтов для итерации по байтам</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=констан�та>Константа<a href=#константа class=hash-link aria-label="Прямая ссылка на Константа" title="Прямая ссылка на Константа">​</a></h3>
<div class="language-go codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-go codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> fullName </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Artjom"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>//объявление нескольких переменных с инкрементом</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"> one </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>iota</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>+</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>1</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//iota начало итерации с нуля</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"> </span><span class="token boolean" style=color:#36acaa>_</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// пропуск "двойки"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"> KB </span><span class="token builtin">uint64</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>1</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;&lt;</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>10</span><span class="token operator" style=color:#393A34>*</span><span class="token boolean" style=color:#36acaa>iota</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>)</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=массив>Массив<a href=#массив class=hash-link aria-label="Прямая ссылка на Массив" title="Прямая ссылка на Массив">​</a></h3>
<p>Низкоуровневый тип. Длина массива фиксирована.</p>
<div class="language-go codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-go codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>var</span><span class="token plain"> a1 </span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>3</span><span class="token punctuation" style=color:#393A34>]</span><span class="token builtin">int</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//длина массива, сразу заполнится [0 0 0]</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>var</span><span class="token plain"> a1 </span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>2</span><span class="token operator" style=color:#393A34>*</span><span class="token plain">size</span><span class="token punctuation" style=color:#393A34>]</span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//длина зависит от перменной</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">a3</span><span class="token operator" style=color:#393A34>:=</span><span class="token punctuation" style=color:#393A34>[</span><span class="token operator" style=color:#393A34>...</span><span class="token punctuation" style=color:#393A34>]</span><span class="token builtin">int</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>,</span><span class="token number" style=color:#36acaa>2</span><span class="token punctuation" style=color:#393A34>,</span><span class="token number" style=color:#36acaa>3</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//инициализирование значениями</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>var</span><span class="token plain"> aa</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>3</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>3</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//массив массивов</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>len</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">mystring</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//длина строк и массивов</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=слайс-резиновый-массив>Слайс (резиновый массив)<a href=#слайс-резиновый-массив class=hash-link aria-label="Прямая ссылка на Слайс (резиновый массив)" title="Прямая ссылка на Слайс (резиновый массив)">​</a></h3>
<p>Более сложная структура. Состоит из массива с фиксированной длиной (capacity) в которую записано меньшее количество элементов (length). Как только length превышает capacity, размер capacity удваивается</p>
<div class="language-go codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-go codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>var</span><span class="token plain"> s1 </span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token builtin">int</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//без размера</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>append</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">s1</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>100</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// добавление</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>len</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">s1</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>cap</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">s1</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// узнать capacity</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s2</span><span class="token operator" style=color:#393A34>:=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token function" style=color:#d73a49>int</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>,</span><span class="token number" style=color:#36acaa>2</span><span class="token punctuation" style=color:#393A34>,</span><span class="token number" style=color:#36acaa>3</span><span class="token punctuation" style=color:#393A34>,</span><span class="token number" style=color:#36acaa>4</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//создание со значениями</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s1 </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token builtin">append</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">s1</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> s2</span><span class="token operator" style=color:#393A34>...</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//Соединение слайсов через оператор развёртывания значений</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s3 </span><span class="token operator" style=color:#393A34>:=</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>make</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token builtin">int</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>10</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//Создание слайса сразу нужной длины, значения уже будут заполнены</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">s4 </span><span class="token operator" style=color:#393A34>:=</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>make</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>]</span><span class="token builtin">int</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>10</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>15</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// Создание слайса с нужной capacity</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>copy</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">s7</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> s6</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// копирование значений, но размер целевого слайса должен совпадать</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">fmt</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>Println</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain"> s7</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>:</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// часть слайса</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>// слайс из массива</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">a</span><span class="token operator" style=color:#393A34>:=</span><span class="token punctuation" style=color:#393A34>[</span><span class="token operator" style=color:#393A34>...</span><span class="token punctuation" style=color:#393A34>]</span><span class="token function" style=color:#d73a49>int</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>5</span><span class="token punctuation" style=color:#393A34>,</span><span class="token number" style=color:#36acaa>6</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><br></span><span class=token-line style=color:#393A34><span class="token plain">b</span><span class="token operator" style=color:#393A34>:=</span><span class="token plain">a</span><span class="token punctuation" style=color:#393A34>[</span><span class="token punctuation" style=color:#393A34>:</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//слайс теперь ссылается на массив</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=мап-ассоциативный-массив>Мап (ассоциативный массив)<a href=#мап-ассоциативный-массив class=hash-link aria-label="Прямая ссылка на Мап (ассоциативный массив)" title="Прямая ссылка на Мап (ассоциативный массив)">​</a></h3>
<div class="language-go codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-go codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>var</span><span class="token plain"> myEmptyMap </span><span class="token keyword" style=color:#00009f>map</span><span class="token punctuation" style=color:#393A34>[</span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>]</span><span class="token builtin">string</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// [тип ключа] и тип данных, но пустой, в него нельзя писать</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>var</span><span class="token plain"> mm1 </span><span class="token keyword" style=color:#00009f>map</span><span class="token punctuation" style=color:#393A34>[</span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>]</span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>map</span><span class="token punctuation" style=color:#393A34>[</span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>]</span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>{</span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//пустой интерфейс</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">mm2 </span><span class="token operator" style=color:#393A34>:=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>map</span><span class="token punctuation" style=color:#393A34>[</span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>]</span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>{</span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">mm3 </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>make</span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>map</span><span class="token punctuation" style=color:#393A34>[</span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>]</span><span class="token builtin">string</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">mm2</span><span class="token punctuation" style=color:#393A34>[</span><span class="token string" style=color:#e3116c>"firstName"</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Artjom"</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//write</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">fmt</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>Println</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">mm2</span><span class="token punctuation" style=color:#393A34>[</span><span class="token string" style=color:#e3116c>"firstName"</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//read</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>delete</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">mm3</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"somekey"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//delete</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">fmt</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>Println</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">mm3</span><span class="token punctuation" style=color:#393A34>[</span><span class="token string" style=color:#e3116c>"nonexistingkey"</span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//выдаст значение по умолчанию (пустая строка)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token boolean" style=color:#36acaa>_</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> exists </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> mm3</span><span class="token punctuation" style=color:#393A34>[</span><span class="token string" style=color:#e3116c>"missing"</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>// проверка есть ли такой ключ</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=ключевые-�слова-в-управляющих-конструкциях>Ключевые слова в управляющих конструкциях<a href=#ключевые-слова-в-управляющих-конструкциях class=hash-link aria-label="Прямая ссылка на Ключевые слова в управляющих конструкциях" title="Прямая ссылка на Ключевые слова в управляющих конструкциях">​</a></h3>
<ul>
<li>
<p>fallthrough - проваливание в switch case</p>
</li>
<li>
<p>break - выход из  switch</p>
</li>
<li>
<p>range - итерирование по символам строки, например</p>
</li>
<li>
<p>for index﻿val := range mystr</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=функция>Функция<a href=#функция class=hash-link aria-label="Прямая ссылка на Функция" title="Прямая ссылка на Функция">​</a></h3>
<p>init() - вызывается при старте программы в любом из пакетов (порядок неконтролируемый)</p>
<div class="language-go codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-go codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic>//аргументы передаются по значению</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>func</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>avg</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">x </span><span class="token builtin">int</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> float</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//возвращаемый тип в конце</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>func</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>multipleArgs</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">severalInts </span><span class="token operator" style=color:#393A34>...</span><span class="token builtin">int</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//развёртывание аргументов в слайс</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>func</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>avg2</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">y </span><span class="token builtin">int</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">res float</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//сокращение return res в конце</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    res </span><span class="token operator" style=color:#393A34>:=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>3</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>func</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>mysql</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">file File</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> x</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    file</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>open</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>defer</span><span class="token plain"> file</span><span class="token punctuation" style=color:#393A34>.</span><span class="token function" style=color:#d73a49>close</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>//заранее объявляет что надо вызвать в конце исполнения функции</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>if</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">x</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic>//do more lots of stuff</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>return</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>1</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>См. также</p>
<ul>
<li><a href=https://gobyexample.com/ target=_blank rel="noopener noreferrer">​Go by example</a></li>
<li><a href=https://tour.golang.org/list target=_blank rel="noopener noreferrer">Go tour</a></li>
<li><a href=https://github.com/golang/go/wiki/SliceTricks target=_blank rel="noopener noreferrer">Slice tricks</a></li>
</ul>
<iframe width=100% height=400 src=https://www.youtube.com/embed/9Pk7xAT_aCU title="1. Программирование на Go. Введение" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy=strict-origin-when-cross-origin></iframe></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Dashboard на основе Grafana и InfluxDB">Dashboard на основе Grafana и InfluxDB</a></h2><div class="container__LhH margin-vert--md"><time datetime=2017-12-25T10:00:00.000Z>25 декабря 2017 г.</time> · <!-- -->2 мин. чтения</div></header><div class=markdown><p>В продолжение темы умного дома где мой <a href=https://kurapov.ee/rus/technology/gadgets/smart_home_pellet_burner_RTB30/ target=_blank rel="noopener noreferrer">котёл умел выдавать API</a> для мониторинга температур, захотелось мне вывести эти данные в более приятный вид. Кроме того, хотя сам котёл умеет рисовать графики, он показывал на них только температурную зону одного контура, а мне хотелось видеть два.</p>
<p>Поэтому я решил поизучать бесплатный dashboard и графико-генератор на основе <a href=http://grafana.net/ target=_blank rel="noopener noreferrer">Grafana</a>. Зарегился и упёрся в то что он сам не хранит данные. Он умеет только подключаться к <strong>внешним источникам</strong> и делать запросы туда. </p>
<p>Новый MySQL мне не хотелось поднимать, а открывать существующий тем более. Cloudwatch от Амазона - видимо полезен для мониторинга сервисов если вы активно пользуетесь этой инфраструктурой. Prometheus я могу и на работе посмотреть. Выбрал InfluxDB - специальную БД для хранения временных событий.</p>
<p><a href=https://docs.influxdata.com/influxdb/v1.4/introduction/installation/ target=_blank rel="noopener noreferrer">Ставить Influx</a> было достаточно просто. Сложней было связать графану с influx.</p>
<p>Сервис гоняется на 8086 порту и Grafana хочет SSL и CORS. Поэтому пришлось делать proxy на nginx и добавлять header:</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">location /influx/ {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    proxy_set_header HOST $host;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    proxy_set_header X-Forwarded-Proto $scheme;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    proxy_set_header X-Real-IP $remote_addr;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    add_header 'Access-Control-Allow-Credentials' 'true';</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    proxy_pass http://localhost:8086/;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Теперь встаёт вопрос как данные добавить в influx. Писать будет процесс на node, поэтому я по-быстрому нашёл библиотечку и пример подключения: </p>
<div class="language-js codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-js codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> </span><span class="token maybe-class-name">Influx</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>require</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'influx'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>const</span><span class="token plain"> influx </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>new</span><span class="token plain"> </span><span class="token class-name">Influx</span><span class="token class-name punctuation" style=color:#393A34>.</span><span class="token class-name">InfluxDB</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">	</span><span class="token literal-property property" style=color:#36acaa>host</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'localhost'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">	</span><span class="token literal-property property" style=color:#36acaa>database</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'home'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">	</span><span class="token literal-property property" style=color:#36acaa>schema</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">		</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">			</span><span class="token literal-property property" style=color:#36acaa>measurement</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'response_times'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">			</span><span class="token literal-property property" style=color:#36acaa>fields</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">				</span><span class="token literal-property property" style=color:#36acaa>boiler_smoketemp</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token maybe-class-name">Influx</span><span class="token punctuation" style=color:#393A34>.</span><span class="token property-access maybe-class-name">FieldType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FLOAT</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">				</span><span class="token literal-property property" style=color:#36acaa>boiler_output</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token maybe-class-name">Influx</span><span class="token punctuation" style=color:#393A34>.</span><span class="token property-access maybe-class-name">FieldType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FLOAT</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">				</span><span class="token literal-property property" style=color:#36acaa>boiler_power</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token maybe-class-name">Influx</span><span class="token punctuation" style=color:#393A34>.</span><span class="token property-access maybe-class-name">FieldType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FLOAT</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">				</span><span class="token literal-property property" style=color:#36acaa>boiler_light</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token maybe-class-name">Influx</span><span class="token punctuation" style=color:#393A34>.</span><span class="token property-access maybe-class-name">FieldType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FLOAT</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">				</span><span class="token literal-property property" style=color:#36acaa>boiler_oxygen</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token maybe-class-name">Influx</span><span class="token punctuation" style=color:#393A34>.</span><span class="token property-access maybe-class-name">FieldType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FLOAT</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">				</span><span class="token literal-property property" style=color:#36acaa>boiler_oxygenlow</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token maybe-class-name">Influx</span><span class="token punctuation" style=color:#393A34>.</span><span class="token property-access maybe-class-name">FieldType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FLOAT</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">				</span><span class="token literal-property property" style=color:#36acaa>boiler_oxygenmid</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token maybe-class-name">Influx</span><span class="token punctuation" style=color:#393A34>.</span><span class="token property-access maybe-class-name">FieldType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FLOAT</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">				</span><span class="token literal-property property" style=color:#36acaa>boiler_oxygenhigh</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token maybe-class-name">Influx</span><span class="token punctuation" style=color:#393A34>.</span><span class="token property-access maybe-class-name">FieldType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FLOAT</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">				</span><span class="token literal-property property" style=color:#36acaa>boiler_connectionindex</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token maybe-class-name">Influx</span><span class="token punctuation" style=color:#393A34>.</span><span class="token property-access maybe-class-name">FieldType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FLOAT</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">				</span><span class="token literal-property property" style=color:#36acaa>boiler_return</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token maybe-class-name">Influx</span><span class="token punctuation" style=color:#393A34>.</span><span class="token property-access maybe-class-name">FieldType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FLOAT</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">				</span><span class="token literal-property property" style=color:#36acaa>zone_1</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token maybe-class-name">Influx</span><span class="token punctuation" style=color:#393A34>.</span><span class="token property-access maybe-class-name">FieldType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FLOAT</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">				</span><span class="token literal-property property" style=color:#36acaa>zone_2</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token maybe-class-name">Influx</span><span class="token punctuation" style=color:#393A34>.</span><span class="token property-access maybe-class-name">FieldType</span><span class="token punctuation" style=color:#393A34>.</span><span class="token constant" style=color:#36acaa>FLOAT</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">			</span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">			</span><span class="token literal-property property" style=color:#36acaa>tags</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">				</span><span class="token string" style=color:#e3116c>'host'</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">			</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">		</span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">	</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic>//заполняем data..</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">influx</span><span class="token punctuation" style=color:#393A34>.</span><span class="token method function property-access" style=color:#d73a49>writePoints</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">	</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">		</span><span class="token literal-property property" style=color:#36acaa>measurement</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'heating'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">		</span><span class="token literal-property property" style=color:#36acaa>fields</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> data</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	</span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>]</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>.</span><span class="token keyword control-flow" style=color:#00009f>catch</span><span class="token punctuation" style=color:#393A34>(</span><span class="token parameter">err</span><span class="token plain"> </span><span class="token arrow operator" style=color:#393A34>=></span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">	</span><span class="token console class-name">console</span><span class="token punctuation" style=color:#393A34>.</span><span class="token method function property-access" style=color:#d73a49>error</span><span class="token punctuation" style=color:#393A34>(</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token template-string string" style=color:#e3116c>Error saving data to InfluxDB! </span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>${</span><span class="token template-string interpolation">err</span><span class="token template-string interpolation punctuation" style=color:#393A34>.</span><span class="token template-string interpolation property-access">stack</span><span class="token template-string interpolation interpolation-punctuation punctuation" style=color:#393A34>}</span><span class="token template-string template-punctuation string" style=color:#e3116c>`</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Теперь что-бы проверить записались ли данные, можно использовать хронограф - скачиваемый UI-сервис который в более ранних версиях был встроен в influx в виде админ-панели.</p>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241016133602-4282ac478ccf1d138f4f4fc2f78efe1f.png" width=1322 height=1164 class=img_sJtY></p>
<p>Окей, данные плывут, теперь осталось совсем чуть-чуть что-бы они появились и в графане где можно будет подключить и другие источники данных тоже..</p>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241016133611-bdbc720d783f18d90ae5bad523a89875.png" width=2154 height=1566 class=img_sJtY></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Микросервисы 2">Микросервисы 2</a></h2><div class="container__LhH margin-vert--md"><time datetime=2017-07-06T10:00:00.000Z>6 июля 2017 г.</time> · <!-- -->3 мин. чтения</div></header><div class=markdown><p>В прошлой статье я начал изучать микросервисный подход, но до полноценного решения тогда не дошёл. Тогда я пробовал сам поднимать процессы на php, управлять ими, связывать между собой через очереди потому что монолит не мог справиться с асинхронными задачами. Но чего у меня реально нехватало, так это <strong>нормальной изоляции и деплоймента, межсервисного взаимодействия и стабильной работы</strong>.</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=docker>Docker<a href=#docker class=hash-link aria-label="Прямая ссылка на Docker" title="Прямая ссылка на Docker">​</a></h3>
<p>Я сразу скажу что не знаю как настраивать production с докер-контейнерами, но сервисы в рабочем окружении поднимаются тривиально</p>
<ul>
<li>
<p>Ставите <a href=https://www.docker.com/products/docker-toolbox target=_blank rel="noopener noreferrer">Docker для Мака или для Windows</a></p>
</li>
<li>
<p>Ставите <a href=https://github.com/moncho/dry target=_blank rel="noopener noreferrer">dry</a> для терминала (по желанию)</p>
</li>
<li>
<p>Создаёте Dockerfile</p>
</li>
<li>
<p>Создаёте docker-compose.yml</p>
</li>
<li>
<p>Запускаете docker-compose up</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_CPg9" id=концепции>Концепции<a href=#концепции class=hash-link aria-label="Прямая ссылка на Концепции" title="Прямая ссылка на Концепции">​</a></h4>
<p><strong>Images (образы)</strong> это изолированная среда, как правило с конкретным языком (node, php) или библиотекой. За это отвечает <a href=https://docs.docker.com/engine/reference/builder/ target=_blank rel="noopener noreferrer">Dockerfile</a>, который ссылается на существующий, скачиваемый образ на докер хабе.</p>
<p>Что-бы увидеть установленные образы, есть комманда  <strong><strong>docker images</strong></strong> . </p>
<p><strong><strong>Контейнеры</strong></strong>  это запущенные образы которые изолированы от host-машины. Обычно контейнер поднимается для какого-то сервиса, поэтому у него есть своё название, явно объявлен маппинг сетевых портов на host-машину и способ монтирования файловой системы -  за это отвечает docker-compose.yml</p>
<p>Что-бы увидеть установленные образы, есть комманда  <strong><strong>docker images</strong></strong> . </p>
<p><strong><strong>Контейнеры</strong></strong>  это запущенные образы которые изолированы от host-машины. Обычно контейнер поднимается для какого-то сервиса, поэтому у него есть своё название, явно объявлен маппинг сетевых портов на host-машину и способ монтирования файловой системы -  за это отвечает docker-compose.yml</p>
<p>По умолчанию порт  <strong><strong>не перебрасываются на такой же</strong></strong> , а файлы хоста не линкуются и  <strong><strong>не будут обновляться внутри контейнера</strong></strong>  после старта.</p>
<p>Что-бы увидеть запущенные контейнеры, есть комманда  <strong><strong>docker ps</strong></strong>  (а лучше dry)</p>
<p>Что-бы запустить текущую папку есть  <strong><strong>docker-compose down && docker-compose up</strong></strong>  — это основная комманда которой вы будете пользоваться в разработке если будете делать изменения</p>
<p>Для автоматизации перезагрузки контейнера при изменении файлов на hostе, для node надо копать в сторону <a href=http://pm2.keymetrics.io/docs/usage/docker-pm2-nodejs/ target=_blank rel="noopener noreferrer">pm2-docker</a></p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=consul>Consul<a href=#consul class=hash-link aria-label="Прямая ссылка на Consul" title="Прямая ссылка на Consul">​</a></h3>
<p>Консул это сервер, который служит для связывания сервисов воедино (service discovery), поддержания их состояния здоровья (healthcheck) и для их конфигурации без перезапуска (key-value storage)</p>
<p>Каждый поднимающийся сервис сам должен зарегистрировать себя в консуле, указать на каком IP/порте он работает. Сам должен открыть HTTP endpoint который будет выдавать состояние здоровья</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=сложности>Сложности<a href=#сложности class=hash-link aria-label="Прямая ссылка на Сложности" title="Прямая ссылка на Сложности">​</a></h3>
<p>При создании микросервисов самая сложная часть это <strong>граница</strong> и <strong>управление</strong>.  Сервис должен отвечать за конкретную бизнес-функцию и доменную область. Это вертикальный срез приложения.  Но при этом сервис должен выполнять весь стек работы — ui, backend, db storage, queue processor. Впихивать столько ответсвенности в один сервис технологически сложно, поэтому приходится дробить вертикальный стек ещё на несколько горизонтальных слоёв. Образно был article-manager - стал article-frontend, article-server, article-worker, над которыми нависают ещё всякие сервисы мониторинга. Это тяжело связывать вместе и деплоить разом.</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=node>Node<a href=#node class=hash-link aria-label="Прямая ссылка на Node" title="Прямая ссылка на Node">​</a></h3>
<p>Поскольку нода висит постоянно в памяти, в отличие от php, который запускается при запросе, то возникает проблема перезагрузки кода при его изменении. Вот как выглядит Dockerfile с PM2:</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">FROM node:6-alpine</span><br></span><span class=token-line style=color:#393A34><span class="token plain">USER root</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ENV PORT=3000</span><br></span><span class=token-line style=color:#393A34><span class="token plain">EXPOSE 3000</span><br></span><span class=token-line style=color:#393A34><span class="token plain">RUN npm install pm2 -g</span><br></span><span class=token-line style=color:#393A34><span class="token plain">WORKDIR /app</span><br></span><span class=token-line style=color:#393A34><span class="token plain">CMD ["pm2-docker", "start", "pm2.json", "--watch"]</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Теперь в pm2.json описывается при каком случае надо перезапускать докер сервис</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">{</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  "apps": [</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      "name": "article-manager",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      "script": "index.js",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      "env": {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        "PORT": 3000,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        "CONSUL_IP": "192.168.10.10",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        "CONSUL_PORT": 8500,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        "SERVICE_NAME": "article-manager"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      },</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      "watch": true,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      "ignore_watch": [</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        "node_modules",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        "npm-debug.log",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        ".idea",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        ".git",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        "test/coverage"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      ],</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      "watch_options": {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        "followSymlinks": false</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  ]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=redis>Redis<a href=#redis class=hash-link aria-label="Прямая ссылка на Redis" title="Прямая ссылка на Redis">​</a></h3>
<p>Очень быстрая in-memory база для кеширования данных</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">version: '2'</span><br></span><span class=token-line style=color:#393A34><span class="token plain">services:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  redis-master:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    image: 'redis:2.8'</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    network_mode: bridge</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    volumes:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        - ./data:/data</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    ports:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        - 6379:6379</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    command: redis-server --appendonly yes</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=alias>Alias<a href=#alias class=hash-link aria-label="Прямая ссылка на Alias" title="Прямая ссылка на Alias">​</a></h3>
<p>Для удобства, советую добавить в ваш ~/.bashrc или ~/.zshrc алиас на быстрое поднятие контейнера:</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">alias doc='docker-compose down && docker-compose up'</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Создаём виртуальный образ ОС для среды разработки">Создаём виртуальный образ ОС для среды разработки</a></h2><div class="container__LhH margin-vert--md"><time datetime=2016-09-29T10:00:00.000Z>29 сентября 2016 г.</time> · <!-- -->2 мин. чтения</div></header><div class=markdown><p>В качестве основы, будем использовать CentOS 6.5</p>
<ul>
<li>Устанавливаем последние Virtualbox и <a href=https://www.vagrantup.com/downloads.html target=_blank rel="noopener noreferrer">Vagrant</a></li>
<li>Создаём новую виртуалку в virtualbox на основе федоры, поставив 2ГБ RAM и 20 GB под жёсткий диск</li>
<li>Скачиваем CentOS-6.5-x86_64-LiveCD.iso с <a href=http://mirror.nsc.liu.se/centos-store/6.5/isos/x86_64/ target=_blank rel="noopener noreferrer">http://mirror.nsc.liu.se/centos-store/6.5/isos/x86_64/</a>. Он включает мгновенный бут (загрузчик), recovery и установку</li>
<li>Ставим root'у пароль vagrant (потом сменить можно)</li>
<li>Добавляем стандартного пользователя vagrant<!-- -->:vagrant</li>
</ul>
<p>Обновляем систему:</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">#dont update unless you want CentOS 6.8 upgrade</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#yum update -y</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#install basic tools</span><br></span><span class=token-line style=color:#393A34><span class="token plain">yum install -y htop nano</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#reboot for kernel updates to take place</span><br></span><span class=token-line style=color:#393A34><span class="token plain">shutdown -r now</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Систему надо <a href=https://blog.engineyard.com/2014/building-a-vagrant-box target=_blank rel="noopener noreferrer">настроить для вагранта</a>, если мы хотим её автоматически выкатывать под разные проекты..</p>
<p>Сначала - настроить пользователя</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">sudo visudo -f /etc/sudoers.d/vagrant</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#adding to this file:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">vagrant ALL(ALL) NOPASSWD:ALL</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#setup vagrant public key access</span><br></span><span class=token-line style=color:#393A34><span class="token plain">mkdir -p /home/vagrant/.ssh</span><br></span><span class=token-line style=color:#393A34><span class="token plain">chmod 0700 /home/vagrant/.ssh</span><br></span><span class=token-line style=color:#393A34><span class="token plain">wget --no-check-certificate \</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub \</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    -O /home/vagrant/.ssh/authorized_keys</span><br></span><span class=token-line style=color:#393A34><span class="token plain">chmod 0600 /home/vagrant/.ssh/authorized_keys</span><br></span><span class=token-line style=color:#393A34><span class="token plain">chown -R vagrant /home/vagrant/.ssh</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">nano /etc/ssh/sshd_config</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#uncomment  AuthorizedKeysFile %h/.ssh/authorized_keys</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#enable public key authentication</span><br></span><span class=token-line style=color:#393A34><span class="token plain">service sshd restart</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#start ssh on reboot</span><br></span><span class=token-line style=color:#393A34><span class="token plain">chkconfig sshd on</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">visudo #comment out requiretty option</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Теперь для вагранта нужны Guest Additions. Это iso файл который у virtual box'а уже есть. Надо смонтировать его на диск и запустить установку пакетов</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">yum install -y gcc build-essential perl kernel-devel</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#mount VBoxGuestAdditions.iso on CD in Virtualbox and run these:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">sudo mount /dev/cdrom /mnt </span><br></span><span class=token-line style=color:#393A34><span class="token plain">cd /mnt</span><br></span><span class=token-line style=color:#393A34><span class="token plain">sudo ./VBoxLinuxAdditions.run</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">echo export KERN_DIR=/usr/src/kernels/`uname -r`/ >> ~/.bashrc</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Теперь, у вас вероятно стоит надстройка для безопасности - SELinux. Если вы будете разрабатывать локально, то лучше его отключить</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">setenforce Permissive</span><br></span><span class=token-line style=color:#393A34><span class="token plain">nano /etc/sysconfig/selinux</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#set to:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#SELINUX=disabled</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Теперь когда всё готово, выходим из виртуалки и упаковываем её для vagrant'а. Для этого надо зайти в папку где лежит виртуалка и запустить комманду которая сгенерит package.box файлик на который в дальнейшем будет ссылаться Vagrantfile в нашем проекте:</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">#package box and move it to desktop</span><br></span><span class=token-line style=color:#393A34><span class="token plain">vagrant package --base CentosEmpty && mv package.box ~/Desktop/</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#clean vagrant cache</span><br></span><span class=token-line style=color:#393A34><span class="token plain">vagrant global-status --prune</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#cd to your project that references new box from desktop</span><br></span><span class=token-line style=color:#393A34><span class="token plain">vagrant up</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>См также:</p>
<p><a href=http://williamwalker.me/blog/creating-a-custom-vagrant-box.html target=_blank rel="noopener noreferrer">http://williamwalker.me/blog/creating-a-custom-vagrant-box.html</a><br>
<a href=https://www.vagrantup.com/docs/boxes/base.html target=_blank rel="noopener noreferrer">https://www.vagrantup.com/docs/boxes/base.html</a><br>
<a href=http://aruizca.com/steps-to-create-a-vagrant-base-box-with-ubuntu-14-04-desktop-gui-and-virtualbox/ target=_blank rel="noopener noreferrer">http://aruizca.com/steps-to-create-a-vagrant-base-box-with-ubuntu-14-04-desktop-gui-and-virtualbox/</a><a href=https://stefanwrobel.com/how-to-make-vagrant-performance-not-suck target=_blank rel="noopener noreferrer"></a><br>
<a href=https://stefanwrobel.com/how-to-make-vagrant-performance-not-suck target=_blank rel="noopener noreferrer">https://stefanwrobel.com/how-to-make-vagrant-performance-not-suck</a></p>
<p><a href=http://unix.stackexchange.com/questions/18435/how-to-install-virtualbox-guest-additions-on-centos-via-command-line-only target=_blank rel="noopener noreferrer">http://unix.stackexchange.com/questions/18435/how-to-install-virtualbox-guest-additions-on-centos-via-command-line-only</a></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Управление количеством backend-процессов в реактивных приложениях">Управление количеством backend-процессов в реактивных приложениях</a></h2><div class="container__LhH margin-vert--md"><time datetime=2016-07-18T10:00:00.000Z>18 июля 2016 г.</time> · <!-- -->1 мин. чтения</div></header><div class=markdown><p>Одна из проблем с которой сталкивается backend разработчик разрабатывая приложение с отложенными вычислениями это управление параллельными процессами. Например, если вы делаете <strong>загрузку картинок</strong> которые необходимо в дальнейшем обработать (уменьшить, вырезать, передвинуть на другой сервер), то для масштабирования такого решения под N -> infinity пользователей, каждый этап имеет смысл делать в отдельном процессе, число которых тоже можно масштабировать вместе с ростом N. </p>
<p>Я по-прежнему использую php демонов, которые рождаются кроном (если на nohup полагаться не хочется). Но поскольку мне хочется одновременно делать ресайз картинки в 5 разных размеров одновременно, я хочу управлять количеством instance'ов php процессов. Это решается простой bash-коммандой:</p>
<div class="language-bash codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-bash codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">[ "$(ps -ef| grep -v grep | grep imageResizer|wc -l)" -lt 5 ] && php imageResizer.php > /var/logs/imageResizer.log</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Заметьте что ключевая комманда -lt. Если коротко, то мы ищем процессы (ps) по их имени (grep), исключая самих себя и считаем количество найденных строк (wc), количество которых должно быть меньше (lt) количества заданных мною инстансов. Как вариант вместо -lt можно использовать -eq 0, если хочется только одного демона</div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href=/blog/tech/backend/Микросервисы>Микросервисы</a></h2><div class="container__LhH margin-vert--md"><time datetime=2016-05-06T10:00:00.000Z>6 мая 2016 г.</time> · <!-- -->7 мин. чтения</div></header><div class=markdown><p>Микросервисы в современной веб-разработке это <a href=https://habrahabr.ru/post/249183/ target=_blank rel="noopener noreferrer">архитектурный подход</a> по разделению изначального монолитного приложения на независимые системные (linux) процессы. Необходимость в таком разделении возникает когда монолит становится <strong>слишком медленным</strong> для одного синхронного процесса, когда код тянет <strong>слишком много зависимостей</strong> и когда <strong>повышается риск</strong> что-то сломать в этой длинной цепочке обработки данных.</p>
<p>Микросервисы — не панацея и тоже усложняют всё приложение в плане транзактивности, логов, и обработки ошибок, управления конфигураций, версионирования, деплоя, возникает дублирование bootstrap-кода из-за изоляции сервисов. Поэтому стоит осторожно подходить к тому, что вы хотите выделить в микросервис и что он даст по <strong>характеристикам</strong> приложения (performance, стабильность, масштабирование, разделение нагрузки). Как правило, веб-приложения создаются <a href=https://martinfowler.com/bliki/MonolithFirst.html target=_blank rel="noopener noreferrer">сначала монолитом</a>, а потом разделяются на сервисы — так эффективней и проще эволюционировать.</p>
<iframe width=934 height=350 src=https://www.youtube.com/embed/2yko4TbC8cI title="Martin Fowler  –  Microservices" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy=strict-origin-when-cross-origin></iframe>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=паттерны-взаимодействия>Паттерны взаимодействия<a href=#паттерны-взаимодействия class=hash-link aria-label="Прямая ссылка на Паттерны взаимодействия" title="Прямая ссылка на Паттерны взаимодействия">​</a></h3>
<p>Общение между сервисами можно делать по-разному:</p>
<ol>
<li>
<p>Синхронно — сервис вызывают явно как веб-сервис по HTTP/REST, делая работу <strong>синхронно</strong> по-старинке, подобно веб-серверу, тогда как клиент ждёт ответа (подобно ajax)</p>
</li>
<li>
<p>Асинхронно — cервис вызывают явно по HTTP/REST, регистрируется задача и клиент тут же получает job ID. Клиент обязан сам проверить состояние задачи, периодически спрашивая у сервиса (polling, aws transcoder)</p>
</li>
<li>
<p>Асинхронно — сервис как работник (демон) без публичного доступа. Слушает какой-то ресурс и генерирует новые вызовы. Это может быть</p>
</li>
</ol>
<ul>
<li>единая шина сообщений (<a href=https://www.rabbitmq.com/ target=_blank rel="noopener noreferrer">RabbitMQ</a>,<a href=http://gearman.org/ target=_blank rel="noopener noreferrer">Gearman</a>, <a href=http://zeromq.org/ target=_blank rel="noopener noreferrer">0MQ</a>, Kafka, AWS SQS, AWS Kinesis)></li>
<li>хранилище с локами (файлы, память, Memcache, Redis)</li>
<li>другие ресурсы (процессы, сеть, железо)</li>
</ul>
<ol start=4>
<li>Асинхронно, не используя MQ, регистрирует слушателей в себе и сам знает к кому куда стучать</li>
</ol>
<p>Главное что-бы подход был единый, с предсказуемым форматом данных (<a href=http://json.org/ target=_blank rel="noopener noreferrer">JSON</a>, <a href=https://github.com/google/protobuf target=_blank rel="noopener noreferrer">protobuf</a>, <a href=http://thrift.apache.org/ target=_blank rel="noopener noreferrer">thrift</a>, <a href=http://msgpack.org/ target=_blank rel="noopener noreferrer">messagepack</a>).Для удобной конфигурации и дружбы между сервисами, надо ставить <a href=https://www.consul.io/ target=_blank rel="noopener noreferrer">Consul</a>, <a href=https://github.com/coreos/etcd target=_blank rel="noopener noreferrer">ETCD</a> или <a href=https://zookeeper.apache.org/ target=_blank rel="noopener noreferrer">ZooKeeper</a> — они позволят абстрагироваться от конкретных IP адресов и PID процессов.</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=пример>Пример<a href=#пример class=hash-link aria-label="Прямая ссылка на Пример" title="Прямая ссылка на Пример">​</a></h3>
<p>Например пользователь приложения имеет возможность <strong>загружать файлы</strong>.Обработка файла очень тяжёлая по CPU, генерирует несколько результатов и занимает много времени из-за долгих внутренних сетевых запросов по загрузке готовых обработанных файлов в хранилище. Допустим эта синхронная операция upload+resize+store занимает 20 секунд в монолитном приложении. В микросервисном приложении, вы решаете создать сервис <strong>обработки</strong> картинки, а для очередей сначала создаёте табличку в БД. Отлично, это даёт возможность сервис положить на другую машину и не нагружать основной сайт. Теперь возникают практические вопросы — как это всё сделать? Практически, если раньше в монолите разные слои приложения проверяли всё за вас, то теперь чуть ли не все значимые классы надо будет выделять отдельные сервисы авторизацию, логирование, менеджер картинок, менеджер транзакций и сам ресайз картинок.</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=веб-сервис-на-php>Веб-сервис на PHP<a href=#веб-сервис-на-php class=hash-link aria-label="Прямая ссылка на Веб-сервис на PHP" title="Прямая ссылка на Веб-сервис на PHP">​</a></h3>
<p>Если ваш сервис должен иметь публичный веб-интерфейс, проще всего запустить php в качестве сервера под конкретную папку и она будет по запросу дёргаться. Тут пригодятся микро-фреймворки типа <a href=http://silex.sensiolabs.org/ target=_blank rel="noopener noreferrer">Silex</a>, <a href=https://www.slimframework.com/ target=_blank rel="noopener noreferrer">Slim</a> или <a href=https://lumen.laravel.com/ target=_blank rel="noopener noreferrer">Lumen</a></p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">#run me as:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#php -S 0.0.0.0:80 -t /var/www/silex</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#install me with:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#composer require silex/silex:~1.3</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">$loader = require __DIR__.'/vendor/autoload.php';</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">$app = new Silex\Application();</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#синхронная работа</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$app->post('/resizeImage', function(Request $request) use($app) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    #загрузить imagemagick, сделать resize, сохранить</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    return "{success:true}";</span><br></span><span class=token-line style=color:#393A34><span class="token plain">});</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#асинхронная работа</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$app->post('/resizeImageAsync', function(Request $request) use($app) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    #зарегистрировать новую работу и передать её демону через RabbitMQ, см. ниже</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    #клиента оповестим автоматом через websocketы</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    return "{success:true}";</span><br></span><span class=token-line style=color:#393A34><span class="token plain">});</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=демон-работник-на-php>Демон-работник на PHP<a href=#демон-работник-на-php class=hash-link aria-label="Прямая ссылка на Демон-работник на PHP" title="Прямая ссылка на Демон-работник на PHP">​</a></h3>
<p>Хотя php изначально разрабатывался как интерпретатор html файлов, современный php может работать в постоянном режиме как сервис если его запустить в CLI режиме. В реальной жизни, php демоны как правило нестабильны из-за утечек памяти и не так эффективны по скорости как сервисы на nodejs или go. Запустить демон можно из коммандной строки..</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">php -f /var/www/app/daemon/myImageProcessor.php</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#let it live after terminal exit:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">nohup php -f myImageProcessor.php &</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>С демонами есть несколько особенностей</p>
<ul>
<li>Работая в бесконечном цикле надо чистить ресурсы (DB-соединения, file handles)</li>
<li>Надо мониторить рост своей памяти что-бы не умереть от fatal error</li>
<li>Надо поддерживать graceful stop при получении SIGTERM и прочих сигналов что-бы не повредить данные на случай если кто-то остановит демона из консоли или перезапустит сервис</li>
<li>Надо ловить все исключения, делать альтернативную функциональность бэкапов и откатов, формировать красивый log</li>
<li>Перезапуск сервера должен запускать демоны заново — через крон или через регистрацию демона в виде системного сервиса</li>
</ul>
<p>У вас может быть несколько экземпляров (instance) одного и того же демона в виде разных процессов. Тогда очень важно не попасть в проблемы многопоточности — дедлоки транзакций, запись в один log файл параллельно и обработка одного и того же задания. Обо всём этом чуть позже..</p>
<p>А пока, вот простой пример с бесконечным циклом и псевдо-кодом:</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">//myImageProcessor.php</span><br></span><span class=token-line style=color:#393A34><span class="token plain">//set custom process name</span><br></span><span class=token-line style=color:#393A34><span class="token plain">cli_set_process_title('php - daemon - myImageProcessor.php');</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">//enable process interruption handling</span><br></span><span class=token-line style=color:#393A34><span class="token plain">declare(ticks = 1);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$interrupted = false;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">function handleSignal(){</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $interrupted = true;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">pcntl_signal(SIGTERM, "handleSignal");</span><br></span><span class=token-line style=color:#393A34><span class="token plain">pcntl_signal(SIGHUP, "handleSignal");</span><br></span><span class=token-line style=color:#393A34><span class="token plain">pcntl_signal(SIGUSR1, "handleSignal");</span><br></span><span class=token-line style=color:#393A34><span class="token plain">pcntl_signal(SIGINT, "handleSignal");</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">while(true){</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $db->connect();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $db->query("SELECT * FROM images WHERE processed = 0");</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    //do some work here with resize & upload</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $db->disconnect();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    //memory cleanup & check</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    gc_collect_cycles();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    const MAX_MEMORY_EXTRA = 10 * 1024 * 1024;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    if (convertToBytes(ini_get('memory_limit')) &lt; (memory_get_usage(true) + MAX_MEMORY_EXTRA)) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        exit();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    //graceful shutdown</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    if($interrupted){</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        exit();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    //wait for some time to decrease load on DB above</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    sleep(10);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_CPg9" id=управление-процессами>Управление процессами<a href=#управление-процессами class=hash-link aria-label="Прямая ссылка на Управление процессами" title="Прямая ссылка на Управление процессами">​</a></h2>
<p>Проверку на УЖЕ запущенного демона можно сделать как на уровне bash, так и на уровне самого php с использованием экзотических флагов в базе, флагов во временных файлах или же используя такой же доступ к shell. С такой проверкой, комманду можно смело класть в cron и демон будет запускаться автоматом (раз в минуту)</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=bash>Bash<a href=#bash class=hash-link aria-label="Прямая ссылка на Bash" title="Прямая ссылка на Bash">​</a></h3>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">#check if daemon is not running yet</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#add logs</span><br></span><span class=token-line style=color:#393A34><span class="token plain">[ "$(ps -ef| grep -v grep | grep myImageProcessor|wc -l)" -eq 0 ] && php -f myImageProcessor.php > /var/www/logs/myImageProcessor.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">#up to 5 instances!</span><br></span><span class=token-line style=color:#393A34><span class="token plain">[ "$(ps -ef| grep -v grep | grep imageResizer|wc -l)" -lt 5 ] && php myImageProcessor.php > /var/logs/myImageProcessor.log</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Остановить демона можно так же из шелла..</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">sudo /usr/bin/kill -9 `ps aux | grep 'myImageProcessor' | grep -v grep | awk '{print $2}'`</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=pm2>PM2<a href=#pm2 class=hash-link aria-label="Прямая ссылка на PM2" title="Прямая ссылка на PM2">​</a></h3>
<p>Для более могучего nodejs, существует отличный process manager, который может управлять и php-демонами! С его помощью можно сразу видеть <strong>только</strong> процессы демонов. Кроме того:</p>
<ul>
<li>перезапускать демона сразу после его падения</li>
<li>следить за изменениями файла что-бы перезапустить демон (watch)</li>
<li>следить за памятью и CPU и перезапускать при их превышениях</li>
</ul>
<p>Менеджеры попроще — <a href=https://github.com/foreverjs/forever target=_blank rel="noopener noreferrer">forever</a> и <a href=https://github.com/tableflip/guvnor target=_blank rel="noopener noreferrer">guvnor</a></p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=очереди-и-rabbitmq>Очереди и RabbitMQ<a href=#очереди-и-rabbitmq class=hash-link aria-label="Прямая ссылка на Очереди и RabbitMQ" title="Прямая ссылка на Очереди и RabbitMQ">​</a></h3>
<p>Как только вы начали использовать демонов, вероятней всего вы станете использовать и паттерн Command, по которому микросервисы выполняют роль работников (workers). MQ-сервер выступает в роли брокера и шины, связывающей асинхронные процессы воедино. Он отвечает за надёжность передачи сообщения сервису и за то что несколько сервисов не получат одну и ту же комманду. Реализовывать это на стандартной БД было бы сложней</p>
<p>Для PHP-демонов, подключение rabbitMQ делается с помощью <a href=https://github.com/php-amqplib/php-amqplib target=_blank rel="noopener noreferrer">php-amqplib</a> библиотеки и бесконечный цикл в этом случае начинает зависеть от неё..</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">$callback = function($msg){</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    //actual work here</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $data = json_decode($msg->body, true);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    //Ack message that everything is done</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $msg->delivery_info['channel']->basic_ack($msg->delivery_info['delivery_tag']);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">//technical details..</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$connection = new AMQPStreamConnection('localhost', 5672, 'root', 'pass');</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$channel    = $connection->channel();</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">//new queue if it was missing</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$channel->queue_declare($queue, false, true, false, false);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">//one entry at a time</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$channel->basic_qos(null, 1, null);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$channel->basic_consume($queue, $receiverName, false, false, false, false, $callback);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">//almost infinite cycle</span><br></span><span class=token-line style=color:#393A34><span class="token plain">while (count($channel->callbacks)) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">	$channel->wait(null);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">$channel->close();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$connection->close();</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Понятно что один сервис хорошо, но архитектура ценна именно тем что сервисы взаимодействуют между собой. Поэтому сообщения можно генерировать другому сервису. Например если обработалось изображение, значит надо оповестить пользователя в реальном времени и обновить UI.</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">$queue = 'datasync';</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$message = ['imageID'=>34, 'status'=>'processed'];</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$message = json_encode($message);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">$connection = new AMQPStreamConnection($server, $port, $login, $pass);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$channel    = $connection->channel();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$channel->queue_declare($queue, false, true, false, false);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">$channel->basic_publish(new AMQPMessage($message, ['delivery_mode' => 2]), '', $routeKey);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$channel->close();</span><br></span><span class=token-line style=color:#393A34><span class="token plain">$connection->close();</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=перспективы>Перспективы<a href=#перспективы class=hash-link aria-label="Прямая ссылка на Перспективы" title="Прямая ссылка на Перспективы">​</a></h3>
<p>Более серьёзные сервисы пишутся на nodejs, а лучше на Go.</p>
<p>Грубо говоря, если прогнать <a href=https://github.com/tsenart/vegeta target=_blank rel="noopener noreferrer">нагрузочный тест</a>, то с PHP вы получите 300 req/s, тогда как с node 7000 req/s, а с go 9000 req/s.</p>
<p>С Go можно копать в сторону <a href=https://github.com/micro/go-micro target=_blank rel="noopener noreferrer">go-micro</a></p>
<p>См. также</p>
<ul>
<li><a href=http://kamashev.name/2011/05/daemons-base/ target=_blank rel="noopener noreferrer">Демоны — Основы</a></li>
<li><a href=http://kamashev.name/2011/06/daemons-signals/ target=_blank rel="noopener noreferrer">Демоны — Сигналы</a></li>
<li><a href=http://kvz.io/blog/2009/01/09/create-daemons-in-php/ target=_blank rel="noopener noreferrer">Create Daemons in PHP</a></li>
<li><a href=https://www.sitepoint.com/php-rabbitmq-advanced-examples/ target=_blank rel="noopener noreferrer">PHP and RabbitMQ : Advanced examples</a></li>
<li><a href=https://www.rabbitmq.com/tutorials/tutorial-one-php.html target=_blank rel="noopener noreferrer">RabbitMQ introduction</a></li>
<li><a href=https://www.digitalocean.com/community/tutorials/how-to-install-and-manage-rabbitmq target=_blank rel="noopener noreferrer">How to Install and Manage RabbitMQ</a></li>
<li><a href=https://rclayton.silvrback.com/failing-at-microservices target=_blank rel="noopener noreferrer">Failing at Microservices</a></li>
</ul>
<iframe width=467 height=260 src=https://www.youtube.com/embed/6yy4vyZFTsM title='Maxim Sidorenko - "Microservices architecture in Online Card Processing"' frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy=strict-origin-when-cross-origin></iframe>
<iframe width=467 height=260 src=https://www.youtube.com/embed/hcHKOqMGd-c title="Микросервисы: первая кровь: видео доклада (Dev Labs 2016)" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy=strict-origin-when-cross-origin></iframe>
<iframe width=467 height=260 src=https://www.youtube.com/embed/tJHVM198suE title="Виталий Баум — Практические примеры создания Микросервисов" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy=strict-origin-when-cross-origin></iframe>
<iframe width=467 height=260 src=https://www.youtube.com/embed/PFQnNFe27kU title="Principles Of Microservices by Sam Newman" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy=strict-origin-when-cross-origin></iframe></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Amazon S3 direct upload">Amazon S3 direct upload</a></h2><div class="container__LhH margin-vert--md"><time datetime=2016-03-01T10:00:00.000Z>1 марта 2016 г.</time> · <!-- -->1 мин. чтения</div></header><div class=markdown><p>вторник, 1 марта 2016 г. в 11:07:40</p>
<p>Amazon S3 <a href=http://docs.aws.amazon.com/AmazonS3/latest/dev/RESTAuthentication.html target=_blank rel="noopener noreferrer">поддерживает</a> прямой upload. Делается всё просто со <a href=https://github.com/uqee/angular-evaporate target=_blank rel="noopener noreferrer">сторонними библиотеками</a>, особенно если у вас ангуляр</p>
<p>bower install evaporate angular-evaporate --save</p>
<p>Добавляете в настройках путь к серверной подписке, где с php <a href=https://github.com/carsonmcdonald/direct-browser-s3-upload-example target=_blank rel="noopener noreferrer">очень просто</a> делается подпись:</p>
<p>echo base64_encode(hash_hmac('sha1', $_GET['to_sign'], AWS_SECRET, true));</p>
<p>Добавляете CORS-файл на S3, вбиваете в нужные места ключи — вот у вас готов аплоадер, поддерживающий multipart, параллельную загрузку файлов, необходимую для файлов в 100MB и выше</div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Как параллельно запустить процессы в sh скрипте">Как параллельно запустить процессы в sh скрипте</a></h2><div class="container__LhH margin-vert--md"><time datetime=2015-02-03T10:00:00.000Z>3 февраля 2015 г.</time> · <!-- -->2 мин. чтения</div></header><div class=markdown><p>Порой надо написать какой-то установочный скрипт, который требует одновременный запуск нескольких задач, из которых некоторые достаточно долгие — сервер, билд проекта. Это не то же самое что <a href=http://stackoverflow.com/questions/13077241/execute-combine-multiple-linux-commands-in-one-line target=_blank rel="noopener noreferrer">последовательный запуск</a> с «&&» или «;» разделителями. Shell-скрипты могут и это с помощью комманды <strong>trap.</strong></p>
<p>Комманда работает на прерывании процесса (второй параметр). В данном случае это EXIT и TERM. Основная комманда - убиение запущенных этим терминалом в фоне процессов (<a href=http://www.unix.com/man-page/opensolaris/1/jobs/ target=_blank rel="noopener noreferrer">jobs -p</a>). Сами они перечисляются дальше с <a href=http://tiswww.case.edu/php/chet/bash/bashref.html#SEC22 target=_blank rel="noopener noreferrer">группировкой фигурными скобками</a>.</p>
<p>Первый trap таким образом вызывает последующие вызовы. Заметьте что второй вызов с инициализацией базы mongo стоит с задержкой в 3 секунды, что-бы сервер успел подняться (который уже будет бежать бесконечно)</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">echo 'db.createCollection("myCollection");' > mongoInit.js</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">trap 'echo Starting MongoDB with preinstalled collections; kill $(jobs -p)' EXIT</span><br></span><span class=token-line style=color:#393A34><span class="token plain">{ trap '/usr/local/bin/mongod --dbpath myMongoDBStorage' TERM; sleep 5 & wait; } &</span><br></span><span class=token-line style=color:#393A34><span class="token plain">{ trap 'sleep 3 && mongo myProjectDB mongoInit.js' TERM; sleep 5 & wait; } &</span><br></span><span class=token-line style=color:#393A34><span class="token plain">sleep 1</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p> </p>
<p>На практике получается впрочем так, что комманды бегут бесконечно, т.е. mongod запускается, вы нажимаете Ctrl+C, а он всё ещё работает.. <strong>jobs</strong> ничего не показывает, но если возникает соединение - контекст возвращается. Приходится использовать killall mongod</p>
<p>Вдохновлено <a href=http://stackoverflow.com/questions/2525855/how-to-propagate-a-signal-through-an-arborescence-of-scripts-bash/3414377#3414377 target=_blank rel="noopener noreferrer">stackoverflow</a>. См. теорию - <a href=http://tldp.org/LDP/Bash-Beginners-Guide/html/sect_12_01.html target=_blank rel="noopener noreferrer">Signals</a> & <a href=http://tldp.org/LDP/Bash-Beginners-Guide/html/sect_12_02.html target=_blank rel="noopener noreferrer">Traps</a> </p>
<p>upd. как оказалось, более простой и эффективный способ - использовать <a href=http://user.hashcode.ru/questions/4573/bash-%D0%B2%D0%BE%D0%B7%D0%BC%D0%BE%D0%B6%D0%BD%D0%BE-%D0%BB%D0%B8-%D0%B2-linux-%D0%BF%D0%B0%D1%80%D0%B0%D0%BB%D0%BB%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5-%D0%B2%D1%8B%D0%BF%D0%BE%D0%BB%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5-sh-%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D0%B0 target=_blank rel="noopener noreferrer">одинарный &</a>, который <a href=http://bashitout.com/2013/05/18/Ampersands-on-the-command-line.html target=_blank rel="noopener noreferrer">пушит комманды в фоновый режим</a> и запускает дальше следующие</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">/usr/local/bin/mongod --dbpath myMongoDBStorage & sleep 3 && mongo myProjectDB mongoInit.js</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p> </p>
<p>В таком случае jobs показывает работающий mongod и вобщем то его тоже приходится убивать вручную.</div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Популярные 404 ошибки">Популярные 404 ошибки</a></h2><div class="container__LhH margin-vert--md"><time datetime=2014-01-08T10:00:00.000Z>8 января 2014 г.</time> · <!-- -->1 мин. чтения</div></header><div class=markdown><p>У моего веб-сервера постоянно спрашивают какую-то фигню. Поэтому я решил выписать какие файлы и запросы наиболее частые или могут быть необходимы для разных случаев</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=атаки>Атаки<a href=#атаки class=hash-link aria-label="Прямая ссылка на Атаки" title="Прямая ссылка на Атаки">​</a></h3>
<p>Сайт можно опрашивать ради какой-то полезной информации, а можно сканировать. Наиболее популярные атаки это проверки на движки и попытки их взлома</p>
<ul>
<li>Wordpress - wp-login.php</li>
<li>PHPmyadmin - phpmyadmin/scripts/setup.php</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=иконки-для-браузера>Иконки для браузера<a href=#иконки-для-браузера class=hash-link aria-label="Прямая ссылка на Иконки для браузера" title="Прямая ссылка на Иконки для браузера">​</a></h3>
<ul>
<li><a href=http://ru.wikipedia.org/wiki/Favicon target=_blank rel="noopener noreferrer"><strong>favicon.ico</strong></a>  - иконки для браузера</li>
<li><a href=https://developer.apple.com/library/ios/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html target=_blank rel="noopener noreferrer">touch-icon-*.png</a> иконки для ios десктопа</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=роботам>Роботам<a href=#роботам class=hash-link aria-label="Прямая ссылка на Роботам" title="Прямая ссылка на Роботам">​</a></h3>
<ul>
<li>
<p><a href=http://www.robotstxt.org/ target=_blank rel="noopener noreferrer"><strong>robots.txt</strong></a>  - запреты на индексацию для поисковиков</p>
</li>
<li>
<p>crossdomain.xml - запрашивается флешем/sliverlight при кроссдоменных запросах</p>
</li>
<li>
<p><a href=http://www.sitemaps.org/ru/ target=_blank rel="noopener noreferrer"><strong>sitemap.xml</strong></a> - для поисковиков</p>
</li>
<li>
<p><a href=http://humanstxt.org/RU target=_blank rel="noopener noreferrer">humans.txt</a> - авторы сайта</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=дебаг-js>Дебаг JS<a href=#дебаг-js class=hash-link aria-label="Прямая ссылка на Дебаг JS" title="Прямая ссылка на Дебаг JS">​</a></h3>
<ul>
<li><a href=http://stackoverflow.com/questions/18487596/error-jquery-2-0-2-min-map-not-found/18488028#18488028 target=_blank rel="noopener noreferrer">*.map</a> файлы для дебага минимизированных js-библиотек</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=ретина---2xpng>Ретина - *@2x.png<a href=#ретина---2xpng class=hash-link aria-label="Прямая ссылка на Ретина - *@2x.png" title="Прямая ссылка на Ретина - *@2x.png">​</a></h3>
<p>Для экранов с высокой плотностью пикселей некоторые сайты добавляют дублирование картинок под ios. Обычно это решается @2x суффиксом и <a href=http://retinajs.com/ target=_blank rel="noopener noreferrer">retina.js</a>, либо с помощью css/background-image как то описано чуть ниже. Проблема в том что файлы указывать, а иногда они проскальзывают</p>
<div class="language-css codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-css codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token selector class" style=color:#00009f>.icon</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token property" style=color:#36acaa>width</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>32</span><span class="token unit">px</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token property" style=color:#36acaa>height</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>32</span><span class="token unit">px</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token property" style=color:#36acaa>background-image</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token url function" style=color:#d73a49>url</span><span class="token url punctuation" style=color:#393A34>(</span><span class="token url" style=color:#36acaa>icon.png</span><span class="token url punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token atrule rule" style=color:#00a4db>@media</span><span class="token atrule" style=color:#00a4db> </span><span class="token atrule keyword" style=color:#00009f>only</span><span class="token atrule" style=color:#00a4db> screen </span><span class="token atrule keyword" style=color:#00009f>and</span><span class="token atrule" style=color:#00a4db> </span><span class="token atrule punctuation" style=color:#393A34>(</span><span class="token atrule property" style=color:#36acaa>-moz-min-device-pixel-ratio</span><span class="token atrule punctuation" style=color:#393A34>:</span><span class="token atrule" style=color:#00a4db> </span><span class="token atrule number" style=color:#36acaa>1.5</span><span class="token atrule punctuation" style=color:#393A34>)</span><span class="token atrule punctuation" style=color:#393A34>,</span><span class="token atrule" style=color:#00a4db> </span><br></span><span class=token-line style=color:#393A34><span class="token atrule" style=color:#00a4db></span><span class="token atrule keyword" style=color:#00009f>only</span><span class="token atrule" style=color:#00a4db> screen </span><span class="token atrule keyword" style=color:#00009f>and</span><span class="token atrule" style=color:#00a4db> </span><span class="token atrule punctuation" style=color:#393A34>(</span><span class="token atrule property" style=color:#36acaa>-o-min-device-pixel-ratio</span><span class="token atrule punctuation" style=color:#393A34>:</span><span class="token atrule" style=color:#00a4db> </span><span class="token atrule number" style=color:#36acaa>3</span><span class="token atrule" style=color:#00a4db>/</span><span class="token atrule number" style=color:#36acaa>2</span><span class="token atrule punctuation" style=color:#393A34>)</span><span class="token atrule punctuation" style=color:#393A34>,</span><span class="token atrule" style=color:#00a4db> </span><br></span><span class=token-line style=color:#393A34><span class="token atrule" style=color:#00a4db></span><span class="token atrule keyword" style=color:#00009f>only</span><span class="token atrule" style=color:#00a4db> screen </span><span class="token atrule keyword" style=color:#00009f>and</span><span class="token atrule" style=color:#00a4db> </span><span class="token atrule punctuation" style=color:#393A34>(</span><span class="token atrule property" style=color:#36acaa>-webkit-min-device-pixel-ratio</span><span class="token atrule punctuation" style=color:#393A34>:</span><span class="token atrule" style=color:#00a4db> </span><span class="token atrule number" style=color:#36acaa>1.5</span><span class="token atrule punctuation" style=color:#393A34>)</span><span class="token atrule punctuation" style=color:#393A34>,</span><span class="token atrule" style=color:#00a4db> </span><br></span><span class=token-line style=color:#393A34><span class="token atrule" style=color:#00a4db></span><span class="token atrule keyword" style=color:#00009f>only</span><span class="token atrule" style=color:#00a4db> screen </span><span class="token atrule keyword" style=color:#00009f>and</span><span class="token atrule" style=color:#00a4db> </span><span class="token atrule punctuation" style=color:#393A34>(</span><span class="token atrule property" style=color:#36acaa>min-devicepixel-ratio</span><span class="token atrule punctuation" style=color:#393A34>:</span><span class="token atrule" style=color:#00a4db> </span><span class="token atrule number" style=color:#36acaa>1.5</span><span class="token atrule punctuation" style=color:#393A34>)</span><span class="token atrule punctuation" style=color:#393A34>,</span><span class="token atrule" style=color:#00a4db> </span><br></span><span class=token-line style=color:#393A34><span class="token atrule" style=color:#00a4db></span><span class="token atrule keyword" style=color:#00009f>only</span><span class="token atrule" style=color:#00a4db> screen </span><span class="token atrule keyword" style=color:#00009f>and</span><span class="token atrule" style=color:#00a4db> </span><span class="token atrule punctuation" style=color:#393A34>(</span><span class="token atrule property" style=color:#36acaa>min-resolution</span><span class="token atrule punctuation" style=color:#393A34>:</span><span class="token atrule" style=color:#00a4db> </span><span class="token atrule number" style=color:#36acaa>1.5</span><span class="token atrule unit" style=color:#00a4db>dppx</span><span class="token atrule punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token selector class" style=color:#00009f>.icon</span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token property" style=color:#36acaa>background-image</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token url function" style=color:#d73a49>url</span><span class="token url punctuation" style=color:#393A34>(</span><span class="token url" style=color:#36acaa>icon@2x.png</span><span class="token url punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token property" style=color:#36acaa>background-size</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>32</span><span class="token unit">px</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>32</span><span class="token unit">px</span><span class="token punctuation" style=color:#393A34>;</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><a href=http://analytics.blogspot.ru/2013/09/monitoring-analyzing-error-pages-404s.html target=_blank rel="noopener noreferrer">Мониторинг 404 ошибок</a> с google analytics</div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Дебаг и установка работающего Magento">Дебаг и установка работающего Magento</a></h2><div class="container__LhH margin-vert--md"><time datetime=2013-11-08T10:00:00.000Z>8 ноября 2013 г.</time> · <!-- -->1 мин. чтения</div></header><div class=markdown><p>Небольшая заметка для себя о том как управиться с копированием и установкой на локалку существующего production-magento сайта.</p>
<ul>
<li>
<p>Что-бы видеть ошибки<br>
<code>cp /errors/local.xml.sample /errors/local.xml</code></p>
</li>
<li>
<p>Что-бы поменять настройки БД<br>
<code>nano /app/etc/local.xml</code></p>
</li>
<li>
<p>Что-бы <a href=http://www.magentocommerce.com/wiki/recover/restore_base_url_settings target=_blank rel="noopener noreferrer">сменить пути</a> идём в БД табличку <strong>core_config_data</strong> и находим по path LIKE '%base_url' ссылки. Меняем на новые.</p>
</li>
<li>
<p>Не помогло? Пути по прежнему кидают на старый сайт? Это скорей всего из-за того что Magento кеширует настройки в xml файлах. Если вы удалите кеш-файлы в var-папке..<br>
<!-- -->rm -rf var/*</p>
<p>Этого может быть мало. В моём случае хардкорный дебаг Varien_Simplexml_Configкласса указал что файлы подтягиваются из временных папок.. в моём случае на маке в /var/tmp. Тоесть надо ещё<br>
<!-- -->rm -rf /var/tmp/magento/*</p>
</li>
<li>
<p>Ещё одна фишка - <a href=http://www.magentocommerce.com/boards/viewthread/43148/ target=_blank rel="noopener noreferrer">не ставьте</a> localhost в качестве base_url</p>
</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Особенности мобильной версии сайта">Особенности мобильной версии сайта</a></h2><div class="container__LhH margin-vert--md"><time datetime=2010-09-18T10:00:00.000Z>18 сентября 2010 г.</time> · <!-- -->3 мин. чтения</div></header><div class=markdown><p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019193745-2507a3603b808db45ea0a2e777107535.png" width=500 height=600 class=img_sJtY></p>
<p>Сделал себе мобильную версию блога, просто <a href=http://www.useit.com/alertbox/mobile-usability.html target=_blank rel="noopener noreferrer">потому что надо</a> — даже на андроиде с умным форматированием текста (который <a href=http://www.opera.com/mobile/demo/ target=_blank rel="noopener noreferrer">изобрела Опера</a>) читать сайт не оптимизированный под мобильники неудобно. Для разработчиков это значит два варианта — либо сделать css файл который будет переделывать некоторые вещи и прятать ненужные блоки, либо же использовать отдельные шаблоны и в лучшем случае использовать параметр в том же контроллере что и основное приложение.</p>
<p>Устройство определяется через параметр user-agent в заголовке запроса - это можно использовать дальше в бизнес логике, например через <a href=http://detectmobilebrowsers.mobi/ target=_blank rel="noopener noreferrer">php функцию</a>. Знание устройства <em>может</em> влиять на то какую функциональность стоит <strong>подгружать</strong>, но это вовсе не обязательно потому что ..</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=игра-в-прятки-со-стилями>Игра в прятки со стилями<a href=#игра-в-прятки-со-стилями class=hash-link aria-label="Прямая ссылка на Игра в прятки со стилями" title="Прямая ссылка на Игра в прятки со стилями">​</a></h3>
<p>Мобильная версия в <em>лучшем случае</em> заключается лишь в одном css-файле, таком же как и версия для печати где вначале прячутся ненужные блоки, реклама которая слишком мелкая что-бы её даже заметили, всякие виджеты "самого популярного", статистика... Код подгрузки стилей в шапке выглядит следовательно так..</p>
<p><code>&lt;link rel="stylesheet" type="text/css" href="screen.css"media="screen" />   &lt;link rel="stylesheet" type="text/css" href="print.css"media="print" />   &lt;link rel="stylesheet" type="text/css" href="mobile.css"media="handheld" /></code></p>
<p>.. и просматриваются в Firefox благодаря <a href=https://addons.mozilla.org/ru/firefox/addon/60/ target=_blank rel="noopener noreferrer">Webdeveloper</a>-плагину:</p>
<p>Однако если в печати элементы <strong>форм</strong> прячутся, то в мобильной версии практически всё, и кнопки в особенности увеличивается. В этот момент вы вероятно задумываетесь над порядком HTML схемы — можно ли просто так спрятать пару блоков и при этом ничего не сломать. В простом блоге как у меня в общем то да, потому что общая структура осталось той же - шапка с поиском, меню и поток статей, а вот в более сложных сайтах хочется какую-то табуляцию <em>взамен</em> меню.</p>
<p>Теперь что-бы браузер в смартфоне не начинал сразу показывать страницу с птичьего полёта вставим немножко кода</p>
<p>    <code>&lt;meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />       &lt;meta name="HandheldFriendly" content="True" /></code></p>
<p>Первая строчка говорит фактически что ширина такая как задана у устройства, а zoom-out делать нельзя. Впрочем Андроидный webkit ограничения проигнорировал и бегунки по прежнему видны. А всё из-за фиксированных в пикселях размерах. Злоо.. Переопределям все блоки в ширину 100%, а все размеры шрифтов в em единицах. Таблицы, картинки и флеш-объекты всё ещё лезут за экран? Overflow<!-- -->:hidden<!-- --> на них. На картинки можно даже повесить уменьшение браузером с соблюдением пропорций</p>
<p><code>-webkit-transform: scale(0.5);-moz-transform:scale(0.5);</code></p>
<p>Но чудится мне что более качественные решения требуют более сложных решений с ресайзом.. я пока что повесил 100% ширину. С объектами (youtube) полегче - тоже вешается 100% ширина и минимальная высота в 200px.</p>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019193706-84977bdd3de071d1a33c86b38447c72d.png" width=325 height=485 class=img_sJtY></p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=всякие-важные-мелочи>Всякие важные мелочи<a href=#всякие-важные-мелочи class=hash-link aria-label="Прямая ссылка на Всякие важные мелочи" title="Прямая ссылка на Всякие важные мелочи">​</a></h3>
<p>Но самое главное естественно повесить самое нужное. В моём случае это личные контакты — телефон и email. Телефон можно сделать ссылкой которую поддерживают Android и iOS</p>
<p><code>&lt;a href="tel:112">Телефон спасения&lt;/a></code></p>
<p>В случае магазинов это наверняка будут времена работы и местоположение на карте (которые тоже нужно <a href=http://developer.apple.com/library/ios/#featuredarticles/iPhoneURLScheme_Reference/Articles/MapLinks.html#//apple_ref/doc/uid/TP40007894-SW1 target=_blank rel="noopener noreferrer">ссылками делать</a>).</p>
<ul>
<li>
<p>В iOS у полей ввода <code>&lt;input></code> на html5-сайтах надо указывать параметр type (email, url, tel) что-бы виртуальная клавиатура менялась на соответсвующий вид</p>
</li>
<li>
<p><a href=http://www.w3.org/TR/mobile-bp/ target=_blank rel="noopener noreferrer">Mobile Best Practices</a> рекомендует короткие ссылки, как например поддомен "m" m.flickr.com и <a href=http://m.facebook.com/ target=_blank rel="noopener noreferrer">m.facebook.com</a></p>
</li>
<li>
<p>Единые стили есть разве что для iPhone в виде <a href=http://jqtouch.com/ target=_blank rel="noopener noreferrer">плагина jQTouch</a></p>
</li>
</ul>
<p>Создание полноценной мобильной версии (а не просто css слоя) - сложная задача поскольку может ориентирована и на разные устройства (ipad, iphone, android, tv, старые мобильники) и соответсвенно может нуждаться в изменении кода (если скажем ajax не поддерживается). У Gmail к примеру 4 версии для мобильников.</p>
<p>См по теме</p>
<ul>
<li><a href=http://validator.w3.org/mobile/ target=_blank rel="noopener noreferrer">W3C mobile checker</a></li>
</ul></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Infinite scolling">Infinite scolling</a></h2><div class="container__LhH margin-vert--md"><time datetime=2010-05-31T10:00:00.000Z>31 мая 2010 г.</time> · <!-- -->2 мин. чтения</div></header><div class=markdown><p>Я вот уже больше месяца как делаю социальную сеть <a href=http://pling.ee/ target=_blank rel="noopener noreferrer">pling.ee</a>, которая акцентируется на связи посредством мобильных телефонов (SMS/MMS) и позиционировании людей с их помощью. Достаточно перспективный проект (как твиттер на дрожжах) и популярный среди местной молодёжи тем что можно почти нахаляву общаться.</p>
<p>Но технически возникла небольшая получасовая техническая задачка с навигацией, и раз уж я давно не писал, то может вам тоже будет полезно. Дело в том что в поток сообщений показывается ajax-ом, подгружаясь по X-сообщений  за раз чистым html (для json просто пришлось бы больше писать). Задача - прятать кнопку "ещё" если сообщений больше нет. Очень просто, но как оказывается не всё так очевидно.</p>
<p><img decoding=async loading=lazy src="data:image/png;base64,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" width=549 height=131 class=img_sJtY></p>
<p><img decoding=async loading=lazy src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAkUAAABTCAIAAAAeDOQ5AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAACRaADAAQAAAABAAAAUwAAAACQayjtAAAROUlEQVR4Ae2cX0xUVx7HTzd96oNijDDIdphMSPuCZYjtYKOzjXUVTVibxtpmEStN3BjnodYCvuiGJdUXwH9NlsasSTGCXTV2UzoJqLWmglFGDUydlzbsBMagDKYL9aGv7O+c+//O3Okd5F5m9HtjnHPP+Z3fOfO5w+97f+eemRfm5uaYvSMSidTV1dmzhRUIgAAIgAAIuErgD66OhsFAAARAAARAwBkC0DNnuMIrCIAACICAuwSgZ+7yxmggAAIgAALOEICeOcMVXkEABEAABNwlAD1zlzdGAwEQAAEQcIbAi8645V5/Gn/snHN4BgEQAAEQKDgCr/pWODdnB/WMJr2i6CXnpg7PIAACIAACBUTg8exvjs4W642O4oVzEAABEAABlwhAz1wCjWFAAARAAAQcJQA9cxQvnIMACIAACLhEAHrmEmgMAwIgAAIg4CgB6JmjeOEcBEAABEDAJQLQM5dAYxgQAAEQAAFHCUDPHMUL5yAAAiAAAi4RgJ65BBrDgAAIgAAIOEoAeuYoXjgHARAAARBwiQD0zCXQGAYEQAAEQMBRAtAzR/HCOQiAAAiAgEsEnl89m7wc2Rru4f+6ky7BxjAgAAIgkLcEUvFPwkNRxqLdPcdjeTvLbBNz9veIs41saiOUbaMJrbJoV2vdthLtfGFLJGZ77/q+6KosW1i/8AYCIFCIBCj+nGYtB+WAIMcH5bQQ39B85lxSWR/sORweZ2WBLxrn42DR++SNnhEJgujSB+jX23eLDrk01qJfYkwABEAgFwKpeMc3s+y5vNUNNjb0NebCKs9s80nPTGjUO6b0Allq+Zwxk9PqhTuukS/fPvJtsq5hfxXVJI+Hf/Tu8Q2yWRbuOcxNfIe61gXpVd+Reu1mHer9Wmxoa6RIX0P5+OEo71hGeR599PkhpsF0d3nStLP6YZLnNGX9W2uf8Jnhv3+1bc1QiyoQAIEFIhDtHy1/J8DukrtfLx359swk9+t/5y8nAg9oDal8D48kWgKnxQ3bEaBudu+pce5UOkzRRqmWX6UwIoUIpcxMYYevY1Fku3Fd9Fkf9F2Pjsvd6UX2P1vOxq+L97JevAVdxBMxUHHOddwq4rUWnTNFxbTYpY27GKV80rPJ0b3hURmCuAbWQJLH22bruxpkHTodX6PHSn11l5+xpdvqfFtHkvurvCyWvB58rc/zZHCyqL6rjrrzz2V3sq/Ry8eSOorrqhs6eZw+fGUBtYbE7Ga1chdTW9dXK1roE9Cf3LZFtUovmP3wj6DRs9qHRCujpEHMVEQogIAjBGJDh9mf+gJPPuF6tnTbwYZt9MpjwoNJigFlRROR+GTVkgt3mZ8PnxaIdvNai0P5e69a19e1TvhUVjhTcYsumavLTGGncemlIzfYnoY+fsvOj/2Naf4nZ72tDX2kfBSpTg2t7fLeFNp8QtJmioFa7FLmKfkSj9PkiJeKn5MrzTaK7SK/5pOeqTokMclyjVNPJuheg9Z55cNHtx3ZlgeqvOtPJaMkWiPj66vXMRanz6VkXxbw+b/hTVwaMx3RbsrnAv6IaBOKy+/UlM+N7h6Hf9bF3U8mL/wzofMjTNJr9D3TJQ1ipueDMgg4QODXSxF26KCX/q4V51LeIxZjeKWv/vXxjiNFoTrfBMWEDIGoiBnvyxU/GSKA2sQLul5y/qQ265rkG2vSV3W3AYWd1JNBFmhRg5LaUV8o862RtiNQMGQ/PogVTZTJXeQYuKVIMjfEpfSIJ4wMNvpRFrucT3qWEwuT+P1OX+/a4I2bMS+L+tY2kumScvZE6yFp29RsgslXVGuKDZ0rDZ3wPBiUqvigSy6Evz3uEauX/FM1HmptOEEfFHNWp/ngJZOfjDXGHnSmlzSIWRoeVIDAAhOYvDw4+HrohMGrd39Xw3766w4PsVYeH8pqXyt/xLbRGo9kZgpElMGoNfqYkB4BDKOQX92qUttQVHoIYhpCckj/2ww7piHsnJrmaYp4kgeTjR23btkU5n79kiXlk6MXctlRGtwSmDh1Y+KdVSIPW+pl47dTgjHJWNkSytUmp+gJMC9oB92bjHhP1C7VanjJu7+VXEUuSd2Vu57J0fGE0U47S/eTXqNZG0qSjEHMDFBwAgKOEBg/d9fXYv57Tx/Ju196PEEtNgOR7b/39MEy15jCTsnLIWY7HtIzF+pepYVQHruCYoEq8zyNES+zTeZpul+bT/kZkVKfn9H2ij0+fQ6uNu09wujxGInKJ2098tYI9dYmCz+65GXjLCCJ09Jtu33U/QzZ8770XG1o7zdsV6t4iqY58R1SP7haJX2IK0+0Muqe3NNQX9YjTcwf9In1dMO6AXXa20b/pftJr9EPYChDzAw4cAICDhGYZKFW4xd4eCYkf4mI1gCDTH16pM6Ax3pDIMr8/MzG37sW/fi+EqvHH3xg2lVvDjsU0LRpmJcrpclq/mntlL9N3cypRlpitZinGvFom0yGaKbSWPzCC3NzczZnEYlE6urqbBqT2U/jj1cUvWTf3palyLjVr4nY6iIZWewkzMHDPEznPdt5jIUuIAACIJCRQN4Eosezv73qW5FxjgtSmU/5mZ03RHcKB+3YmW2itBOkrsGwnGg2ceB8vrN1YCpwCQIgAALPOIFC07P5Xg76nmC2FH6+btEPBEAABPKdwHNzY12Y+0Hy/eOD+YEACIAACLhNAHrmNnGMBwIgAAIg4AQB6JkTVOETBEAABEDAbQLQM7eJYzwQAAEQAAEnCEDPnKAKnyAAAiAAAm4TgJ65TRzjgQAIgAAIOEEAeuYEVfgEARAAARBwmwD0zG3iGA8EQAAEQMAJAtAzJ6jCJwiAAAiAgNsEnP19EPq1LrffEMYDARAAARB4Lgk4qGeO/u7kc3mx8KZBAARAAAQsCWC90RINGkAABEAABAqIAPSsgC4WpgoCIAACIGBJAHpmiQYNIAACIAACBUQAelZAFwtTBQEQAAEQsCQAPbNEgwYQAAEQAIECIgA9K6CLhamCAAiAAAhYEoCeWaJBAwiAAAiAQAERgJ4V0MXCVEEABEAABCwJQM8s0aABBEAABECggAhAzwroYmGqIAACIAAClgSgZ5Zo0AACIAACIFBABKBnBXSxMFUQAAEQAAFLAtAzSzRoAAEQAAEQKCAC0LMCuliYKgiAAAiAgCUB6JklGjSAAAiAAAgUEAHoWQFdLEwVBEAABEDAkgD0zBINGkAABEAABAqIAPSsgC4WpgoCIAACIGBJAHpmiQYNIAACIAACBUTgxZzmGolEcrKHMQiAAAiAAAi4Q+CFubk5myPNzMzYtIQZCIAACIAACLhMIAc9c3lmGA4EQAAEQAAE7BPA8zP7rGAJAiAAAiCQvwSgZ/l7bTAzEAABEAAB+wSgZ/ZZwRIEQAAEQCB/CUDP8vfaYGYgAAIgAAL2CbirZ9PXjh69Nm1/dpLl/HrlOkr+2z+8t2v7lUHGBj/vaovm/3QxQxAAARBwlYDt75+RqLT3P9LmVt3YuaNSO13cUry3uXtEnkLplgNNG4qN89FNXmlWu5jeSLz3aGqj7MDKxuicZGbf8M9yXUX7xU0hY/uCna1cvTvUdWD7GCuvOf/xgnmFIxAAARDITiD5n/MfnPtFsnml/q9n3l2W3X7RWun7Z7aO1Hednd+lbJlaG83PSfZe93uamnrua2OSdZN5pvd7FAuy5o30ItVwa6WNl+lQOme00cZRS5N3P2y6OyGdDl9eo5ZVAxRAAARAoGAJTHz9b11Y++8/3vvnh1//Lz/fje38LJPgZkh7mJrTMJ74FKtZnciLuJOpq0ebR3iip2RKmhclVUqvkUbnvqeM6Ve897LnQOeGYnVY7rWzpJeWNXVZWuWOHZIHVuwppVI8NlJdJaqKVwVKR1PTrJIyuuINTZ2rrh09Kw+W0UZ2Y/USrNjcMTbBZn5o/irxfrg1SHaJtu13/Cc/2LmSCgMDouPmFmrSndbXJG6yzzpXe8Va4oHBivaTy08fk2tY9MqbF5af/5T93VQj7K0mgnoQAAEQWAgCiS/PsfBJHp3E4W89WbPrWCL5rlJjWKBifPWIB6tf/GxsYIL3EOGOMc1MWcTSapaHKUKye7uUEEePVHgYbGEHOsakUfn/5JmCnqnXSq2dSrno2aP+9uZ+pbfQHhKADaKC5ORqfAOXr27W2NkpL0RS7VStdEYSdfbaqp2MPZoi/eksZlyzqKap5Gp7v6exs6lS1PTGO3ewXlPNRjEEdeC+yVB3xGOsdkcxiSjXOZI1ual4YyB2f5qp52qP6fujLLCzmE2pNcUlnkcxeqSndFUbdAU7NsI8+Z87A+UVH7Flofcr3rydaA36WXRsIPTGrZUzZ5sHWEv4Flc4OoyndIVu8lq6it+vCd+itcSH907zCjoSbXRFy5dLJxY1ukYUQQAEQGABCTycSVBM08vGymX+CbprZ4rCKUpDg1IoOybGnpjxnwzfol50O95x5e2LFd/vG/a3hM8EGV+6/DxBUa5t3y+7L4b50xne695bn8qT1sIgY7cubpJ8Srf7PB6aehlv63PRMyWhkoelFy2RonTLMz2dGmVbdqqCM52aYiMjzcqDLVY9zTysNLBKSAdPjPqnpqfZVKncRdTE4hs96TWMpLRdyd604dl0inlW0TRSU6WBjXpFKi5hU+kiFe9tHw0caCL90/lYiOLE8Afbh7kj6Q6CCiJRG/zYz26PbV7DL8l3rOYzWczo+iUMp2QvPPCFadWGuyOFu+NvqXnlgjixqNHaUAIBEACBfCBQXvGWJIEUCdmd8SiJohwAvTUVr5wbG3xveYISONoNIB8VE2y5VRhUbChyzqT10slqbvmZ5lWUuJiRPHSSPnBhk5fpjEYmCZy+dtnYbvesdEtjYLSbZ2+qWvKusmxVUo51+f70Bi0fk4VO756SRVqa1C1CSo1cCz1SBqi3NpR/10aVMa2b/+3QwPfRCjZY8TbPt7SGzCXuYdmX279qK5NWKYVV9Mrplzed+SOJn3Kk1ygteAUBEACBhSfAs7E7PzxcvVNN0XjGtvyjpx/JFDZpUSpjGDQNZOplbH26/fpKskXLePyJGGVYrP+qmvzwZTrdqXFg3qW6qlJnY1kjOtLDrUbWbd7tX1nFLtMXACp3NHpoMZQfwiJ+ddQjpYHSoCS3BjGrrKoeiYl58kE9JfrUTpmmHRvFNtNr6L2aRMdAov4NnlCv9P+ZDX+pbrI3ncrd+cJ0ouP8WUn8KGO7XWHYR5Rek2lc1IEACIDAwhHwf1TPuo7dS8oeacVvmK31a4uN2UeiBy6UqwVJFOUAmBwe+zlUEeIyqQuJmhNjGNTqRcmyl2yXy3qjyXXxhlpPs/RErbS6mm+zoB0VO7ccJV0Rlnx98IB2yvd/8OdnykM4nrrxZEtnQz0y1VCyJQ5SrVhz+1GmT7Iqd9TGmpt7aahOevLGD8rDmvmmEZ1GCbl99Eh5+sdH5q6kecqDUk919ZQM+eQz2Ygh7P1HolU+xmqkja3Ldn5as2tf15uiK39Aqj+tr5E9rlx95iQjswSvqWin5UrDkV5jaMYJCIAACCw4Ae+7H5xn5+VHKmJ/h+mxSIYR1UcwFMcu8p0jfBeJHACphkc2XY28i0T2o4ZBvm/O5FvsRlECqfZ8R7F6Nn5fnzQs6/fPlHfr6qu0L9H4uNLVCWAwEAABEHCfgNgVouzgcHX4p8jPXJ1n9sEq1ewsu52brYO0E+T9TXazcjdnhrFAAARA4Fkk8GzkZ8/ilcF7AgEQAAEQyIXA0+0HyWUk2IIACIAACICAcwSgZ86xhWcQAAEQcJIAPaly+jfKaYhmdXOjk+9lIXw/G8/PFoIEfIAACDxvBChYaz8mLt581q835R2e3/2Nct3WDPk3hUObb5k3Tufd25r3hP4PPG05BBB0RQsAAAAASUVORK5CYII=" width=581 height=83 class=img_sJtY></p>
<p>Вот возможные решения (от худшего к лучшему)</p>
<ol>
<li>
<p>При первой загрузке страницы делать второй запрос и узнавать какой ID у последнего сообщения и потом детектить его показ с помощью js. Проблема в том что как правило SQL для запроса и так сложный, а тут надо его продублировать с изменением сортировки. Уже пахнет говнокодом.</p>
</li>
<li>
<p>Если число подгружаемых результатов меньше ожидаемых X элементов на странице то сразу прятать кнопку. Конечно с вероятностью 1/X она всё-таки будет показываться, зато</p>
</li>
<li>
<p>Сделать что-бы нажатие кнопки сразу показывало спрятанные закешированные результаты (и если их нет - то не показывать кнопку) + делать ajax-запрос и результаты прятать (а если их нет то тоже прятать кнопку). Тут много игры с js и к тому же подгружаются лишние данные (не факт что пользователь всегда нажимает на продолжение)</p>
</li>
<li>
<p>Использовать SQL_CALC_FOUND_ROWS что-бы расчитать число всех элементов и если их меньше чем offset + число на странице, то просто отметить последний элемент css-классом и через javascript проверить и спрятать кнопку если класс присутсвует</p>
</li>
</ol></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Цифровая подпись документов в Эстонии с помощью DigiDocService">Цифровая подпись документов в Эстонии с помощью DigiDocService</a></h2><div class="container__LhH margin-vert--md"><time datetime=2010-02-08T10:00:00.000Z>8 февраля 2010 г.</time> · <!-- -->7 мин. чтения</div></header><div class=markdown><p>В Эстонии с 2000 года вступил в силу <a href=http://www.esis.ee/ist2004/101.html target=_blank rel="noopener noreferrer">закон о цифровых подписях</a>, которые стали юридически равноценны обычным рукописным. Вскоре была создана и техническая основа - компания SertifitseerimisKeskus (буквально - «центр сертификации») принадлежащая банкам и телекоммуникацонным операторам (а не государству, представляете себе!) и схема обмена данными по X.509 стандарту. Эта статья расчитана в большей мере на программистов.</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=цифровая-подпись>Цифровая подпись?<a href=#цифровая-подпись class=hash-link aria-label="Прямая ссылка на Цифровая подпись?" title="Прямая ссылка на Цифровая подпись?">​</a></h3>
<p>Подпись как оказывается очень важна, а признаваемая государством - тем более. Снижаются затраты на распечатку и/или доставку счетов по оплате, договоров между работником и работодателем. Я уже не говорю про обычное подтверждение что документ прислан точно нужным человеком, а не хакером. Спасает положение то что у каждого гражданина Эстоини есть сертификат подписи, но его недостаточно. Проблема в том что одной подписи-закарючки в IT-мире недостаточно. Подпись в расширенном виде на самом деле включает в себя набор данные, в том числе не статичные.</p>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019194009-aaeb73a622e61baece8f34aa4258050a.png" width=961 height=316 class=img_sJtY></p>
<ol>
<li>
<p>Стороны подписывающие документ</p>
</li>
<li>
<p>Собственно документ или его отпечаток (говорящий о неизменном состоянии со времени подписания)</p>
</li>
<li>
<p>Свидетели (нотариус) и роль сторон</p>
</li>
<li>
<p>Время, место</p>
</li>
</ol>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019194024-bb5464809cd6267159da975ef08b2bad.png" width=305 height=360 class=img_sJtY></p>
<p>Контейнер всей этой информации решили сделать на XML и назвать .ddoc расширением и связать с онлайн-сервисом создания и подтверждения подписей — Digidoc. За основу берутся основные свойства эстонской ID-карточки - <strong>авторизация</strong>, <strong>подпись</strong> и шифрование и в результате имеем:</p>
<ul>
<li>цифровая подпись файлов (DigiDoc клиент, <a href=https://digidoc.sk.ee/ target=_blank rel="noopener noreferrer">портал</a> или третья сторона через DigiDocService)</li>
<li>шифрование и дешифрование файлов (DigiDoc клиент)</li>
<li><strong>подтверждение действительности</strong> (<a href=https://digidoccheck.sk.ee/ target=_blank rel="noopener noreferrer">digidoccheck</a>)</li>
<li>подпись электронной почты</li>
<li>подпись или авторизация с помощью мобильного телефона (Mobiil-ID)</li>
</ul>
<p>Контейнер со времени создания претерпел некоторые изменения, сейчас есть версия 1.3 основана на стандарте <strong>XAdES-X-L</strong> <a href=http://www.w3.org/TR/XAdES/ target=_blank rel="noopener noreferrer">расширенных электронных подписей</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=процесс-создания-подписи-с-digidocservice>Процесс создания подписи с DigiDocService<a href=#процесс-создания-подписи-с-digidocservice class=hash-link aria-label="Прямая ссылка на Процесс создания подписи с DigiDocService" title="Прямая ссылка на Процесс создания подписи с DigiDocService">​</a></h3>
<p>Теперь собственно о главном что может понадобится на любом сайте. Допустим вы продаёте рога и копыта и хотите всё юридически правильно оформить. По-старинке это было бы типичный checkbox мол «согласен с условиями». Теперь же можно получить юридически действительную подпись клиента под любым договором, распиской купли-продажи или договора предоставления услуги.</p>
<hr>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019194046-e4136a7b0c56547b005297c2a8a91987.png" width=543 height=529 class=img_sJtY></p>
<p>Что-бы это у себя сделать Sertifitseerimiskeskus предоставляет услугу DigiDocService по SOAP, и для этого опубликованы следующие списки WSDL-методов: <code>http://www.sk.ee/DigiDocService/DigiDocService_2_3.wsdl //почти live   https://digidocservice.sk.ee/?wsdl //live - работает с CURL только вместе с Juur-SK.crt   https://www.openxades.org:8443/?wsdl //test</code><br>
<!-- -->В обмене данными участвуют следующие стороны</p>
<ul>
<li>
<p>Клиент с нормальной ид-карточкой и софтом</p>
</li>
<li>
<p>Наше серверное приложение</p>
</li>
<li>
<p>Digidoc-узел (см. wsdl выше)</p>
</li>
<li>
<p>OCSP сервер, публикующий устаревшие или отозванные сертификаты id-карт</p>
</li>
</ul>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019194054-8ee51e38df18cf8f380b78b70a919479.png" width=805 height=668 class=img_sJtY></p>
<p>Если опустить очевидное, то процесс в общем выглядит так</p>
<ol>
<li>
<p>Создание сессии между приложением и digidoc (<strong>StartSession</strong>) с передачей инфы о контейнере (который может включать несколько подписываемых файлов) — либо целиком файлы, либо их SHA1-хэш. Запоминаем вернувшися SessionCode у себя</p>
</li>
<li>
<p>Можно запросить с помощью <strong>GetSignatureModules</strong> сразу готовый html (со всякими апплетами, activex компонентами..) для того что-бы получить сертификаты клиента</p>
</li>
<li>
<p>Клиент авторизуется передавая данные серверу, который вызывает <strong>PrepareSignature</strong> (signCertHex, signCertId), получает обратно бинарный хэш контейнера документов <strong>SignedInfoDigest</strong> который клиент должен подписать</p>
</li>
<li>
<p>Клиент подписывает <strong>SignedInfoDigest</strong> введя PIN2 — генерируется подпись signValueHex и передаётся в <strong>FinalizeSignature</strong>(). На этом моменте digidoc проверяет действительность сертификата пользователя у OSCP</p>
</li>
<li>
<p>В успешном случае можно уже скачать .ddoc файл. Если оригинальные файлы не отсылались, то их в base64-форме внедряют в вернувшийся xml. Сессия закрывается CloseSession.</p>
</li>
</ol>
<p>Авторизацию и подпись можно поставить и с помощью мобильного телефона, где добавляются ещё и сторона оператора (MSSP), но я этот случай здесь не рассматриваю.</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=о-качестве-ddservice>О качестве ddservice<a href=#о-качестве-ddservice class=hash-link aria-label="Прямая ссылка на О качестве ddservice" title="Прямая ссылка на О качестве ddservice">​</a></h3>
<p>Поставляемый <a href=http://www.sk.ee/pages.php/020207010702,1039 target=_blank rel="noopener noreferrer">php-пакет</a> в качестве примера полон багов и говнокода — написанный под php4 надо постараться что-бы прикрутить его к PEAR под php5, надо увеличить таймаут curl во всех запросах с 4 секунд на что-либо существенное.</p>
<p>У меня в процессе вылетали ошибкииспользовал test-среду вместо live <code>200: Failed to get signature confirmation/notary // используйте live среду вместо test   Validation constraint violation: data type mismatch xsd:string in element 'Sesscode' //приведите сессию в int-тип   </code></p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=чтение-сертификата-с-id-карты>Чтение сертификата с ID-карты<a href=#чтение-сертификата-с-id-карты class=hash-link aria-label="Прямая ссылка на Чтение сертификата с ID-карты" title="Прямая ссылка на Чтение сертификата с ID-карты">​</a></h3>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019194118-653729e6c44d20ad0795bbefc3aa034b.png" width=564 height=441 class=img_sJtY></p>
<p>Возвращаемся к двум основным пунктам подписи. До вызова <strong>PrepareSignature</strong> метода, на странице есть компонент (Applet, ActiveX либо зависимый от браузера plugin) который считывает два параметра</p>
<ul>
<li>
<p>signCertHex — сертификат подписи переведённый из цифрового DER формата в HEX</p>
</li>
<li>
<p>signCertId — идентификатор приватного ключа</p>
</li>
</ul>
<p>В качестве <a href=http://www.sk.ee/pages.php/020207010805 target=_blank rel="noopener noreferrer">компонента</a> DigiDocService возвращает ActiveX для IE (EIDCard.cab файлик) и аплет для остальных ( SignApplet_sig.jar,iaikPkcs11Wrapper_sig.jar ). ActiveX в плане интеграции довольно прост - можно javascriptом вызвать оба метода, следовательно прикрутить их к любому дизайну, другое дело что у меня этот компонент не работает (уж и драйверы переустанавливал - не помогло). А вот аплет мало того что подгружает яву, так и в дизайн не вписывается со своими кнопками.</p>
<h4 class="anchor anchorWithStickyNavbar_CPg9" id=firefox--esteid-xpcom-v04>Firefox - EstEID XPCOM v0.4<a href=#firefox--esteid-xpcom-v04 class=hash-link aria-label="Прямая ссылка на Firefox - EstEID XPCOM v0.4" title="Прямая ссылка на Firefox - EstEID XPCOM v0.4">​</a></h4>
<p>В идеале каждый браузер мог бы завести свой plugin который бы поддерживал обработку созданного в RIA</p>
<p><code>&lt;object type="application/x-esteid" /></code></p>
<p>Но глядя как это <a href="http://my.opera.com/community/forums/topic.dml?id=156020&abc=&page=1&skip=0&show=&perscreen=50" target=_blank rel="noopener noreferrer">тянется c 2006 года</a> в Opera, очевидно что это будет долго. Впрочем Firefox уже умеет использовать <a href="http://support.sk.ee/index.php?_m=knowledgebase&_a=viewarticle&kbarticleid=69?app=FFInstaller&code=1&appver=0.8.6.4&l=" target=_blank rel="noopener noreferrer">onepin-opensc-pkcs11.dll</a> как с помощью SK'шного хака, так и с помощью <a href=https://id.eesti.ee/idtrac/wiki/FirefoxModuleInstaller target=_blank rel="noopener noreferrer">плагина</a> EstEID XPCOM v0.4 написанного в RIA и Smartlink. В результате имеем <a href=https://id.smartlink.ee/plugin_tests/test.html target=_blank rel="noopener noreferrer">красивую картинку</a> в Firefox и нет нужды читать страшные мануалы по копированию dll-файлов и ошибок «Teie arvutisse on vaja installeerida <strong>PKCS</strong>#11 <strong>ohjurprogramm</strong>!»</p>
<p>Этот компонент успешно может яваскриптом выкачивать данные об id-карте к примеру— document.getElementById('esteid').signCert.cert. Но этот сертификат подписи для DigiDoc надо первести в шестнадцатиричный формат из PEM. Примерно так:<br>
<!-- -->        <code>$sTempKey=str_replace(array(           "-----BEGIN CERTIFICATE-----",           "-----END CERTIFICATE-----",           "\n"           ),'',$sTempKey);              $sTempKey=base64_decode($sTempKey);           $sTempKey=bin2hex($sTempKey);</code><br>
<a href=http://code.google.com/p/esteid/ target=_blank rel="noopener noreferrer">EstID-плагин</a> теперь переехал и выпускается как open-source</p>
<h4 class="anchor anchorWithStickyNavbar_CPg9" id=internet-explorer--eidcard-dsiglite2--idutil>Internet explorer - EIDCard / dsiglite2 + idutil<a href=#internet-explorer--eidcard-dsiglite2--idutil class=hash-link aria-label="Прямая ссылка на Internet explorer - EIDCard / dsiglite2 + idutil" title="Пря�мая ссылка на Internet explorer - EIDCard / dsiglite2 + idutil">​</a></h4>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019194135-52a5110d41efd3936f47c0c0db5e4542.png" width=412 height=195 class=img_sJtY></p>
<p>EIDCard.cab компонент судя по существующему коду прост - создаёшь объект, ссылаешься на этот файл, потом через vbscript спрашиваешь сертификат или запрашиваешь подпись digest'а - всё как в Firefox. Что-бы он заработал нормально надо соблюдать следующие заповеди</p>
<ol>
<li>Выключить автоматическое удаление сертификатов в ID-card tool если вы под Windows Vista с правами администратора</li>
<li>Держать объект EIDCard за пределами формы, иначе он не будет доступен вовсе</li>
<li>При создании подписи VBscript по умолчанию пытается записать результат в поле signValueHex, вот только видимо кто-то использует такую же переменную в компоненте из-за чего подпись не передаётся серверу.</li>
</ol>
<p>dsiglite2.cab это альтернатива для создания подписи, правда его найти удалось только у swedbank'а на странице и он слишком низкоуровневый, пришлось отказаться. Третий компонент очень полезен - idutil.cab понимает события вытаскивания карточки, хоть и с использованием JScript'а (в итоге получается каша из трёх ECMAscript диалектов)</p>
<p><code>&lt;!--Использование idutil для чтения личных данных в IE-->   &lt;div id="mTag">&lt;/div>   &lt;OBJECT  ID="myCard" CLASSID="CLSID:7F9F89F2-F12B-4B25-9C69-7358F38B898B" CodeBase="idutil.cab">&lt;/OBJECT>   &lt;SCRIPT LANGUAGE="JScript" FOR="myCard" EVENT="CardInserted() ">       var mTag = document.getElementById("mTag");       mTag.innerHTML = "Reading data...";       timerId = window.setInterval("reading()",500);   &lt;/SCRIPT>   &lt;SCRIPT LANGUAGE="JScript" FOR="myCard" EVENT="CardRemoved() ">       var mTag = document.getElementById("mTag");       window.clearInterval(timerId);       mTag.innerHTML = "Card removed";   &lt;/SCRIPT>   &lt;SCRIPT LANGUAGE="JScript">   var timerId;      function reading(){       var mTag = document.getElementById("mTag");       window.clearInterval(timerId);          mTag.innerHTML = "";       try {           myCard.ReadCard();           mTag.innerHTML='Hello,'+myCard.familyName+' '+myCard.personalCode;           }       catch(e) {           mTag.innerHTML="Reading failed";           }       }   &lt;/SCRIPT>   </code></p>
<p>Если вы «переписываете» ddservice, то имеет смысл сохранить корень (wsdl класс) и переписать обёртку. Обратите внимание что после чтения сертификата и PREPARE, нельзя перенаправлять на другую страницу - надо делать POST на ту же самую страницу, иначе аплет будет ругаться. Вторая проблема - правильно заменять маркеры вида <!-- -->1<!-- --> на реальные данные. Ну и третья проблема - расставить пути к jar-файлам если у вас используется ЧПУ, иначе плагины будут искаться в локальной несуществующей папке.</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=validity-confirmation>Validity confirmation<a href=#validity-confirmation class=hash-link aria-label="Прямая ссылка на Validity confirmation" title="Прямая ссылка на Validity confirmation">​</a></h3>
<p>Как я выше писал - существует digidoccheck с помощью которого можно проверить подпись. Листочек этот юридической силы не имеет в качестве распечатки цифровой подписи, но иметь на всякий случай не помешает. Разберёмся же какие тут данные есть и откуда они приходят</p>
<ul>
<li>
<p>Данные о файле и пользователе - приходят в ответе FinalizeSignature. Там очень просто - ходи по массиву и выдёргивай что тебе надо.</p>
</li>
<li>
<p>Серийный номер сертификата - десятичная версия  находится в ['SignedDocInfo']->SignatureInfo->Signer->Certificate->IssuerSerial и легко переводится в hex</p>
</li>
<li>
<p>Сертифицирующая сторона (собственно SK) в явном виде отсутсвует, надо выдирать из ['SignedDocInfo']->SignatureInfo->Confirmation->ResponderCertificate->Issuer</p>
</li>
<li>
<p>Хеш публичного ключа сертифицирующей стороны. На данный момент это ESTEID-SK 2007 и он <a href=http://www.sk.ee/pages.php/0203040502 target=_blank rel="noopener noreferrer">есть на сайте</a>, но правильней конечно запрашивать его динамически через WSDL метод GetSignersCertificate(). В php к результату надо приделать "-----BEGIN CERTIFICATE-----" и концовку (что-бы получить PEM формат) и взять от него openssl_x509_parse(). Внутри и будет находится заветная 4806DEBE ... Вариант захардкодить и обновлять каждые X лет я не рассматриваю</p>
</li>
<li>
<p>Хеш OCSP-сертификата о действительности карточки (HASH VALUE OF VALIDITY CONFIRMATION (OCSP RESPONSE)) берётся из WSDL метода getNotary() из которого OcspData попадает в sha1(base64_decode(...))</p>
</li>
</ul>
<p>Ваш покорный слуга на время написания статьи нашёл мега-баг в том листочке что генерирует Digidoc Client - там OCSP responce hash всегда одинаковый. Кроме того я бы добавил хеши самих документов для печати, иначе слишком много зависимости от памяти SK. Ну и в подарок - метод hex2bin</p>
<p>        <code>function hex2bin($data) {               $len = strlen($data);               for($i=0;$i&lt;$len;$i+=2) {               $newdata .= pack("C",hexdec(substr($data,$i,2)));               }               return $newdata;           }</code></p>
<p><a href=/assets/files/177-83c1e13ba056fea94e2565bebd44925c.pdf target=_blank>img/177.pdf</a></p>
<p><a href=/assets/files/172-e980ddbbd128ca3e592caf0b462f9945.pdf target=_blank>img/172.pdf</a></p>
<p><a href=/assets/files/173-9ca618f10cccd13714a1f258d8897858.pdf target=_blank>img/173.pdf</a></p>
<p><a href=/assets/files/174-262c8cb70fd8538f05e45bc5a645b855.pdf target=_blank>img/174.pdf</a></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Основные отличия HTML5">Основные отличия HTML5</a></h2><div class="container__LhH margin-vert--md"><time datetime=2009-09-11T10:00:00.000Z>11 сентября 2009 г.</time> · <!-- -->3 мин. чтения</div></header><div class=markdown><p>Недавно вышел HTML5, и хотя я надеялся что де-факто стандартом станет XHTML2, видимо этому не судьба. Следование веб-стандартам впринципе дело самодисциплины — кто-то пишет как умеет, а для кого-то это средство подчеркнуть свой проффесионализм.</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=тэги>Тэги<a href=#тэги class=hash-link aria-label="Прямая ссылка на Тэги" title="Прямая ссылка на Тэги">​</a></h3>
<p>Основным нововведением стало внесение давно ожидаемых новых элементов, благодаря которым содержание выглядит чуть более семантичным, хотя только разве что в блогах. Хитрые дизайнерские сайты с плавающими блоками видимо лучше делать на более общих div'ах</p>
<table><thead><tr><th><th><tbody><tr><td>Структурные тэги<td>Тэги содержания<tr><td>- header — понятное дело, шапка с логотипом, логином, навигацией..- nav — навигация.. как меню, так и «хлебные крошки»- footer — подвал с копирайтами, контактами- article — очевидно влияние блогосферы и rss- section — подраздел документа- aside — боковая панель (видимо с коментариями, самыми популярными статьями, тэгами и тп)<td>- video и audio — как альтернатива flash-плеерам. Врядли заменит флеш из-за проблем с кодеками и отсутствии поддержки уже созданных .flv видео. Мало поддерживается пока браузерами.- progress — полоса завершённости процесса. Полезно при заполнении форм- time — полезно для указания точного времени элемента- details — просто дополнительная информация- datalist — нечто типа автозаполнения, но с прописанными вариантами</table>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019195650-9b1f08fbba410f1d93903fc219f2f28f.png" width=434 height=320 class=img_sJtY></p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=формы>Формы<a href=#формы class=hash-link aria-label="Прямая ссылка на Формы" title="Прямая ссылка на Формы">​</a></h3>
<p>Что особенно радует что работа форм улучшена новыми типами input-элементов.</p>
<ul>
<li>date, datetime, time, month, week</li>
<li>email, url</li>
<li>range, number</li>
<li>color</li>
</ul>
<p>Их давно пора было вводить в стандарт, потому что число компонентов на js+dom которые делают эту работу растут постоянно (календарики для выбора даты, бегунки), более того - пишутся даже специальные надстройки типа <a href=http://jqueryui.com/ target=_blank rel="noopener noreferrer">jquery ui</a>. Кроме новых типов, введены интересные параметры, в частности <a href=http://dev.w3.org/html5/markup/input.file.html target=_blank rel="noopener noreferrer">параметр</a> <em><a href=http://dev.w3.org/html5/markup/input.file.html target=_blank rel="noopener noreferrer">multiple</a></em> для массовой загрузки файлов. И опять прийдётся распрощаться с <a href=http://www.uploadify.com/ target=_blank rel="noopener noreferrer">uploadify</a> и <a href=http://swfupload.org/ target=_blank rel="noopener noreferrer">swfupload</a>. Впрочем не обязательно.</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=перетащи-в-браузер>Перетащи в браузер<a href=#перетащи-в-браузер class=hash-link aria-label="Прямая ссылка на Перетащи в браузер" title="Прямая ссылка на Перетащи в браузер">​</a></h3>
<p>С давних пор я не понимал почему нельзя было сделать удобное перетаскивание чего-то с рабочего стола <em>внутрь</em> браузера. Точней перетащить то можно, но браузер как правило не поймёт что это за файлы или текст вы в него суёте. HTML5 предполагает распознавание таких случаев с помощью javascript <em>drop</em>-событий, при которых к содержанию получается доступ с помощью e.dataTransfer.getData() метода. Опять же - досвидания java аплеты и google gears.</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=данные-на-стороне-клиента>Данные на стороне клиента<a href=#данные-на-стороне-клиента class=hash-link aria-label="Прямая ссылка на Данные на стороне клиента" title="Прямая ссылка на Данные на стороне клиента">​</a></h3>
<p>Ещё одной отличительной особенностью стала возможность кэшировать чистые данные на стороне клиента без необходимости постоянно пересылать их с каждым обновлением страницы (т.е. явно не конкурент json-объектам), а объём достигает 5-10 мб (уже не конкурент cookies).</p>
<p><a href=http://dev.w3.org/html5/webstorage/ target=_blank rel="noopener noreferrer">Web storage</a> очень полезная особенно для мобильных устройств. Без HTML5 на это способна лишь Google gears.</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=а-сейчас-как-быть>А сейчас как быть?<a href=#а-сейчас-как-быть class=hash-link aria-label="Прямая ссылка на А сейчас как быть?" title="Прямая ссылка на А сейчас как быть?">​</a></h3>
<p>HTML5 всё ещё в режиме черновика, многие браузерные движки лишь пробуют внедрять новые возможности в бета-версиях (особенно заметен Presto). Надо дважды подумать перед тем как перепрыгивать со скачущей лошади на ещё теоретический мотоцикл, особенно если вас заботит совместимость с IE. Для него даже надо прописывать существование тэгов</p>
<p><code>document.createElement('header');   document.createElement('footer');   document.createElement('section');   document.createElement('aside');   document.createElement('nav');   document.createElement('article');</code></p>
<p>См. также</p>
<ul>
<li><a href=http://www.w3.org/TR/2009/WD-html5-diff-20090825/ target=_blank rel="noopener noreferrer">W3C - разница между html4 и 5</a></li>
<li><a href=http://www.w3.org/TR/2009/WD-html5-diff-20090825/ target=_blank rel="noopener noreferrer"></a><a href=http://www.whatwg.org/specs/web-apps/current-work/multipage/states-of-the-type-attribute.html target=_blank rel="noopener noreferrer">Web Forms</a></li>
<li><a href=http://www.alertdebugging.com/2009/08/16/on-html-5-drag-and-drop/ target=_blank rel="noopener noreferrer">On HTML5 Drag and Drop</a></li>
</ul></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Пишем Facebook приложение">Пишем Facebook приложение</a></h2><div class="container__LhH margin-vert--md"><time datetime=2009-06-14T10:00:00.000Z>14 июня 2009 г.</time> · <!-- -->5 мин. чтения</div></header><div class=markdown><p>Facebook - популярная социальная сеть где можно написать своё приложение. Не люблю толочь воду в ступе, поэтому сразу к делу. Встраивать можно двумя <em>направлениями</em>: внешнее приложение в Facebook или Facebook-данные во внешнее приложение (aka <a href=http://wiki.developers.facebook.com/index.php/Anatomy_of_a_Facebook_Connect_Site target=_blank rel="noopener noreferrer">Facebook Connect</a>). Тут я буду говорить о первом, что в принципе более трудоёмко и интересно. Как правило смысл facebook-приложение несёт две функциональности - взаимодействие с друзьями и информативное интегрирование в профиль пользователя.</p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=основы>Основы<a href=#основы class=hash-link aria-label="Прямая ссылка на Основы" title="Прямая ссылка на Основы">​</a></h3>
<p>Встраивать приложение можно в следующие <strong>места</strong>..</p>
<ul>
<li>Canvas - собственно страница с приложением. Доступна по ссылке <a href=http://apps.facebook.com/%D0%9D%D0%90%D0%97%D0%92%D0%90%D0%9D%D0%98%D0%95_%D0%9F%D0%A0%D0%9E%D0%93%D0%A0%D0%90%D0%9C%D0%9C%D0%AB/ target=_blank rel="noopener noreferrer">http://apps.facebook.com/НАЗВАНИЕ_ПРОГРАММЫ/</a></li>
<li>Profile box - маленький бокс внутри самого профиля пользователя</li>
<li>Profile tab - новый таб в профиле</li>
<li>Boxes tab - небольшой блок в табе boxes</li>
<li>News feed - доступ к потоку обновлений</li>
<li>Requests box - интерактивные сообщения другим пользователям</li>
</ul>
<p>Интеграция производится смешанными <strong>возможностями</strong>..</p>
<ul>
<li>REST API (<a href=http://api.new.facebook.com/restserver.php target=_blank rel="noopener noreferrer">http://api.new.facebook.com/restserver.php</a>) который даёт "тяжёлый" доступ для backend-а с возможностями загрузки фото, видео, получении списков друзей, событий, комментариев и тп.</li>
<li><a href=http://wiki.developers.facebook.com/index.php/FQL target=_blank rel="noopener noreferrer">FQL</a> - способ запрашивать данные по REST не просто через параметры метода, а уже через SQL-подобный синтаксис</li>
<li><a href=http://wiki.developers.facebook.com/index.php/FBML target=_blank rel="noopener noreferrer">FBML</a> - урезанный HTML + свои тэги которые Facebook интерпретирует в окне в своём стиле и дизайне и кэширует при инлайновом показе. Куча заморочек с встроенным валидатором тэгов</li>
<li>xFBML - FBML-тэги используемые в своём приложении</li>
<li>FBJS - урезанный JS</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=два-пути>Два пути<a href=#два-пути class=hash-link aria-label="Прямая ссылка на Два пути" title="Прямая ссылка на Два пути">​</a></h3>
<p>Теперь когда основные термины понятны перейдём к самому приложению которое размещается в Canvas. После создания нового приложения через <a href=http://www.facebook.com/developers/ target=_blank rel="noopener noreferrer">developer app</a>, скачивания <a href=http://svn.facebook.com/svnroot/platform/clients/packages/facebook-platform.tar.gz target=_blank rel="noopener noreferrer">REST-библиотеки</a> для php, выкладывании приложения на свой сайт и установки в настройках URL для Canvas становится видно что доступно два способа запуска - через <strong>iframe</strong> (+XFBML) либо <strong>чистый FBML</strong> который будет храниться на facebook. Понятное дело первый вариант самый простой. После создания программы и добавления/подтверждения в своём профиле, показ Canvas'а будет сопровождаться обычным iframe + GET-параметрами с префиксом fb_sig_, из которых самый важный это fb_sig_canvas_user. Второй вариант более муторный, но более тесно связан с FB.</p>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019195732-b8abad8fdfd14c5557cff11f16c5af09.png" width=831 height=585 class=img_sJtY></p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=права>Права<a href=#права class=hash-link aria-label="Прямая ссылка на Права" title="Прямая ссылка на Права">​</a></h3>
<p>Теперь надо подумать о том что приложение делает в принципе. В моём случае это quiz-тест - пользователь отвечает на вопросы и в конце статус ставится на стенку в профиль (profile wall).</p>
<p>Первым делом оказывается что очень полезно иметь подтверждение пользователя для получения данных (<a href=http://wiki.developers.facebook.com/index.php/Authorizing_Applications target=_blank rel="noopener noreferrer">Authorization</a>) которое вызывается методом Facebook::require_login и для пользователя выглядит просто как окошко передачи прав. Покопавшись в документации для публикации данных в Wall (News feed), есть метод <a href=http://wiki.developers.facebook.com/index.php/Feed.publishTemplatizedAction target=_blank rel="noopener noreferrer">Feed.publishTemplatizedAction</a>, но оказалось что он устаревший (deprecated). Альтернатива - <a href=http://wiki.developers.facebook.com/index.php/Stream.publish target=_blank rel="noopener noreferrer">Stream.publish</a>, и теперь переходим ко второй важной теме - расширенные права (<a href=http://wiki.developers.facebook.com/index.php/Extended_permissions target=_blank rel="noopener noreferrer">Extended permissions</a>).</p>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019195746-02b4283825182a91767056aa210ee7a0.png" width=656 height=327 class=img_sJtY></p>
<p>Без прав запрос получит просто фатальную ошибку. Для того что-бы программа получала более глубокий доступ над профилем пользователя, последний должен подтвердить это отдельно в диалоговом окне. А вызвать этот диалог что-бы запостить на стенку сообщение или изменить статус пользователя - не так то просто.</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">$facebook->api_client->stream_publish("My new status");</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Uncaught exception 'FacebookRestClientException' with message 'The user hasn't authorized the application to perform this action' i</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Теперь немного тонкостей - документацию в wiki и на форумах надо читать с большим подозрением, потому что часто встречается устаревший код (к примеру названия привилегий/методов stream_publish вместо publish_stream). Методы на проверку привилегий выдают либо фатальную ошибку либо невразумительную отписку на параметры, в том числе и тестовая <a href=http://developers.facebook.com/tools.php?api target=_blank rel="noopener noreferrer">API console</a></p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">if($facebook->api_client->users_hasAppPermission("publish_stream")){</span><br></span><span class=token-line style=color:#393A34><span class="token plain">//обновить статус тут</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_CPg9" id=fbml-соблазн>FBML-соблазн<a href=#fbml-соблазн class=hash-link aria-label="Прямая ссылка на FBML-соблазн" title="Прямая ссылка на FBML-соблазн">​</a></h4>
<p>К этому времени становятся понятными плюсы FBML-режима (принуждение к похожему интерфейсу и поддерживаемые FBML-тэги). У меня таки сработали</p>
<ul>
<li>FBML mode + onclick + тэг<code>&lt;fb:prompt-permission perms="stream_publish">Heelp&lt;/fb:prompt-permission></code></li>
<li>FBML mode +</li>
</ul>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">&lt;form promptpermission="status_update"> + onclick</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019195805-1f5514254aebc504535d813ecc6f5ed9.png" width=520 height=217 class=img_sJtY></p>
<p>Iframe + редирект на <a href="http://www.facebook.com/authorize.php?api_key=%D0%9C%D0%9E%D0%99_API_KEY&v=1.0&ext_perm=publish_stream&next=http://google.com" target=_blank rel="noopener noreferrer">http://www.facebook.com/authorize.php?api_key=МОЙ_API_KEY&v=1.0&ext_perm=publish_stream&next=http://google.com</a></p>
<p>Хотя и очень глючно выглядит:</p>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019195819-cd1c0dce9342bd16d4db198e11469086.png" width=685 height=273 class=img_sJtY></p>
<ul>
<li>FBML mode + redirect выдали "Error while loading page" сообщение</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=xfbml>xFBML<a href=#xfbml class=hash-link aria-label="Прямая ссылка на xFBML" title="Прямая ссылка на xFBML">​</a></h3>
<p>Понятно что права получать через iframe таким образом глючно, хочется одновременно и вместе и порознь с фейсбуком жить. Для этого есть xFBML-тэги которые интерпретируются фейсбуковским яваскриптом. Итого надо в своём приложении надо:</p>
<ol>
<li>Подключить яваскрипт <a href=http://static.ak.connect.facebook.com/js/api_lib/v0.4/FeatureLoader.js.php target=_blank rel="noopener noreferrer">http://static.ak.connect.facebook.com/js/api_lib/v0.4/FeatureLoader.js.php</a></li>
<li>Сделать <a href=http://wiki.developers.facebook.com/index.php/XFBML target=_blank rel="noopener noreferrer">xd_receiver.htm</a></li>
<li>Инициализировать своим апи-ключём</li>
<li>Указать путь к корню в настройках Connect-приложения в фейсбуке</li>
</ol>
<p>Теперь уже права можно спрашивать</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">FB.Connect.showPermissionDialog('publish_stream');</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019195840-ab8195d68b52f9ea30ea9fad29673f0a.png" width=481 height=388 class=img_sJtY></p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=затерянное-печенько-ослика>Затерянное печенько ослика<a href=#затерянное-печенько-ослика class=hash-link aria-label="Прямая ссылка на Затерянное печенько ослика" title="Прямая ссылка на Затерянное печенько ослика">​</a></h3>
<p>Нельзя обойти не упомянув об IE 6/7 и тут. Дело в том что по умолчанию iframe в этих браузерах теряет переменные сессии. Проще говоря - печеньки (cookies) не доходят до сервера, потому что iframe считается "неблагонадёжным" содержанием и он даже показывает глазик в своём статус-баре. Если <a href=http://stackoverflow.com/questions/389456/cookie-blocked-not-saved-in-iframe-in-internet-explorer target=_blank rel="noopener noreferrer">подробно</a> в этом разбираться то для этого есть обоснование в виде <a href=http://www.w3.org/TR/P3P/#guiding_principles target=_blank rel="noopener noreferrer">W3C platform for privacy preferences</a>. Для этого проще добавить заголовок</p>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">header('P3P: CP="IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT"');  //for IE6/7</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>В конце концов приложение успешно обновило профиль (куда удалось впихнуть и картинку через аттачмент)</p>
<p><img decoding=async loading=lazy src="/assets/images/Pasted image 20241019195852-d2a18e70a4ba629e7af8be2fb7adfa83.png" width=781 height=532 class=img_sJtY></p>
<h3 class="anchor anchorWithStickyNavbar_CPg9" id=редирект-хаоса>Редирект хаоса<a href=#редирект-хаоса class=hash-link aria-label="Прямая ссылка на Редирект хаоса" title="Прямая ссылка на Редирект хаоса">​</a></h3>
<p>Любой тестер свихнулся бы увидя странный мандельбаг с отсутсвием прав на постинг в wall. Вторая меньшая проблема проявлялась в хаотичном выпрыгивании приложения из iframe в большое окно. Как <a href=http://stackoverflow.com/questions/595059/facebook-app-iframe-worries-url-problem target=_blank rel="noopener noreferrer">оказалось</a>, фейсбук в разных браузерах странным образом интерпретирует переход по ссылкам и внутренним редиректам. Для этого специально нашёлся метод facebook->require_frame до логина, который привязал в обязательном порядке страницу с фреймом фейсбука. Впрочем внутри между переходами страниц всё-равно засел login.php</p>
<p>По теме:</p>
<ul>
<li>Более <a href=http://blog.cmsdevelopment.com/0000414/ target=_blank rel="noopener noreferrer">тягучее введение</a> от Димы Шейко</li>
<li>Некоторые заметки от <a href=http://cr-it.livejournal.com/6764.html target=_blank rel="noopener noreferrer">cr_it</a></li>
</ul></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/Из Regio.ee в Google maps">Из Regio.ee в Google maps</a></h2><div class="container__LhH margin-vert--md"><time datetime=2009-05-14T10:00:00.000Z>14 мая 2009 г.</time> · <!-- -->2 мин. чтения</div></header><div class=markdown><p>Regio.ee - ведущая компания картографических и геодезических работ в Эстонии. У них очень неплохой сервис карт типа google maps отличающийся большей точностью. Хоть и работает на flash. Для моего проекта <a href=http://terrideal.com/ target=_blank rel="noopener noreferrer">terrideal.com</a> возникла задача переноса координат которые используются в regio на координаты google maps.</p>
<p>Как оказалось Regio использует коническую проекцию <a href=http://en.wikipedia.org/wiki/Lambert_conformal_conic_projection target=_blank rel="noopener noreferrer">Lambert-EST</a> введённую в советское время для хорошей точности на местности. Google же использует мировую геодезическую систему <a href=http://en.wikipedia.org/wiki/World_Geodetic_System target=_blank rel="noopener noreferrer">WGS84</a>. Существует <a href=http://kaardid.regio.ee/coords/index.php target=_blank rel="noopener noreferrer">конвертатор</a> на самом сайте regio, но понятное дело хотелось собственный вариант. Сначала я методом тыка пришёл к приблизительной формуле:</p>
<p><code>wgs_x= 57.0014 + (est_x-6317802.5) / 111368; wgs_y= 24.0314 + (est_y-500000) / 59097.825;</code></p>
<p>Но точность оставала желать лучшего. И вот наткнулся на <a href=http://www2.regio.ee/alex/API2/test/gmapSyncedWithFT.html target=_blank rel="noopener noreferrer">идеальный вариант</a> написанный Саней Смирновым из Regio. Пришлось порыться в коде и найти нужную функцию с переносом в php. Там же можно найти и обратное направление и конвертирование в систему Меркатора.</p>
<div class="language-php codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-php codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">/**</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * Converts Estonian L-EST coordinates to World Geodetic System</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> *</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * @param float $X</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * @param float $Y</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> * @return array</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> */</span><br></span><span class=token-line style=color:#393A34><span class="token plain">function Est2Wgs($X, $Y) {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $_PI= 3.14159265358979323846;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $_n = 0.85417585805;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $_x0= 6375000;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $_y0= 500000;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $_a = 6378137;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $_F = 1.7988478514;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $_e    = 0.0818191910428158;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $_p0= 4020205.479;</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    function sqr($a) { </span><br></span><span class=token-line style=color:#393A34><span class="token plain">        return $a*$a; </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    //$theta, $p, $t, $u;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $Lo = 24 * pi() / 180;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $ux = $X - $_y0;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $uy = $Y - $_x0;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $sx = $ux;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $ux = $uy;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $uy = $sx;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $theta = atan($uy / ($_p0 - $ux));</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $tmpL = $theta / $_n + $Lo;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $p = sqr($_p0 - $ux);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $p += sqr($uy);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $p = sqrt($p);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $t = pow(($p / ($_a * $_F)), 1 / $_n);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $u = pi() / 2 - 2 * atan($t);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $tmpB = $u + </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    (sqr($_e)/2 + 5 * sqr($_e) * sqr($_e)/24 + pow($_e,6)/12 + 13 * pow($_e, 8)/360) * sin(2 * $u) + </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    (7 * pow($_e,4) /48  + 29 * pow($_e, 6)/240 + 811 * pow($_e, 8)/11520) * sin(4 * $u) + </span><br></span><span class=token-line style=color:#393A34><span class="token plain">    (7 * pow($_e, 6)/120 + 81 * pow($_e, 8)/1120) * sin( 6 * $u);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $X=rad2deg($tmpL);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    $Y=rad2deg($tmpB);</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    return array($X, $Y);</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/DB/postgres/Экспорт данных используя Create View и Aggregate-функции">Экспорт данных используя Create View и Aggregate-функции</a></h2><div class="container__LhH margin-vert--md"><time datetime=2008-02-15T10:00:00.000Z>15 февраля 2008 г.</time> · <!-- -->2 мин. чтения</div></header><div class=markdown><p>Встала задача экспортирования данных из таблицы <em>Firma</em> в качестве строки. Если бы дело было в одноразовом копировании то проблемы особой и не-было бы - всегда есть клиентские программы, которые экспортируют хоть в Excel, хоть в текстовый файл какие угодно колонки. Но мне необходимо было это сделать при помощи SQL, потому что прямого доступа к live-базе данных у меня нет, а размер таблицы мне неизвестен.</p>
<p>Вход - таблица Firma</p>
<table><thead><tr><th>ID<th>name<tbody><tr><td>1<td>Google<tr><td>2<td>Microsoft<tr><td>Выход - строка<td></table>
<div class="codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-text codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token plain">1=>Google;2=>Microsoft</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><a href=http://www.postgresql.org/docs/8.0/interactive/sql-createaggregate.html target=_blank rel="noopener noreferrer">Агрегирующие функции</a> занимаются именно такой задачей - на входе у них массив данных, а на выходе - одно значение. Типичным примером являются функции COUNT, MAX, SUM. Postgre пошла по пути универсальности и позволяет пользователю самому создавать такие функции. Создаём CONCAT функцию:</p>
<div class="language-sql codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-sql codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>CREATE</span><span class="token plain"> AGGREGATE concat </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">  </span><br></span><span class=token-line style=color:#393A34><span class="token plain">BASETYPE </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>text</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain">  </span><br></span><span class=token-line style=color:#393A34><span class="token plain">SFUNC </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> textcat</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain">  </span><br></span><span class=token-line style=color:#393A34><span class="token plain">STYPE </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>text</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain">  </span><br></span><span class=token-line style=color:#393A34><span class="token plain">INITCOND </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>''</span><span class="token plain">  </span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Теперь можно сразу получить строку с данными, но мне нужна сортировка по названию фирмы, но никакие вложенные запросы и ORDER BY этому не помогают:</p>
<p><code>SELECT CONCAT(name||';') FROM Firma;</code></p>
<p>Поэтому приходится изучить ещё одну новую для себя функциональность и создать Представление (<a href=http://www.postgresql.org/docs/8.0/interactive/sql-createview.html target=_blank rel="noopener noreferrer">View</a>). View это виртуальная таблица, данные которой формируются на лету. Она может использоваться и в качестве ограничения прав на изменение родительской таблицы. Представления можно кэшировать - тн. <a href=http://en.wikipedia.org/wiki/Materialized_view target=_blank rel="noopener noreferrer">материализация</a>. Но сейчас оно поможет реализовать обычную сортировку:</p>
<p><code>CREATE VIEW FirmaSorted AS SELECT * FROM Firma ORDER BY name;</code></p>
<p>Остаётся сделать выборку, в которую я добавлю ещё одно поле, уберу последний символ-разделитель и сделаю UPDATE полученного значения в другую таблицу:</p>
<div class="language-sql codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_HaV9><pre tabindex=0 class="prism-code language-sql codeBlock_ZL1J thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_qXKr><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>UPDATE</span><span class="token plain"> tblLists </span><span class="token keyword" style=color:#00009f>SET</span><span class="token plain"> strValue</span><span class="token operator" style=color:#393A34>=</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">  </span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token keyword" style=color:#00009f>SELECT</span><span class="token plain"> TRIM</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>';'</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>FROM</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token keyword" style=color:#00009f>SELECT</span><span class="token plain"> CONCAT</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">id</span><span class="token operator" style=color:#393A34>||</span><span class="token string" style=color:#e3116c>'=>'</span><span class="token operator" style=color:#393A34>||</span><span class="token plain">name</span><span class="token operator" style=color:#393A34>||</span><span class="token string" style=color:#e3116c>';'</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>FROM</span><span class="token plain"> FirmaSorted</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain">  </span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token keyword" style=color:#00009f>WHERE</span><span class="token plain"> strName</span><span class="token operator" style=color:#393A34>=</span><span class="token string" style=color:#e3116c>'companies'</span><span class="token punctuation" style=color:#393A34>;</span><br></span></code></pre><div class=buttonGroup_Stij><button type=button aria-label="Скопировать в буфер обмена" title=Скопировать class=clean-btn><span class=copyButtonIcons_kDb_ aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_avy6><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_La4Y><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<pre tabindex=0 class="codeBlockStandalone_xlHV thin-scrollbar codeBlockContainer__iiz theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><code class=codeBlockLines_qXKr></code></pre></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/db>db</a></ul></div></footer></article><article class=margin-bottom--xl><header><h2 class=title_Y5lg><a href="/blog/tech/backend/DB/postgres/Введение в Postgre">Введение в Postgre</a></h2><div class="container__LhH margin-vert--md"><time datetime=2007-04-16T10:00:00.000Z>16 апреля 2007 г.</time> · <!-- -->2 мин. чтения</div></header><div class=markdown><p><a href=http://en.wikipedia.org/wiki/Postgre target=_blank rel="noopener noreferrer">PostgreSQL</a> - крутая СУБД, потому что..</p>
<ol>
<li>
<p>Она не принадлежит какой-либо компании, как например Oracle или mysql и распространяется по BSD-лицензии</p>
</li>
<li>
<p>Имеет поддержку продвинутых фишек - PL/pgSQL, триггеров. Теоретически это очень полезно при создании очень масштабной системы.</p>
</li>
<li>
<p>Транзакции по принципам ACID придают скорости - несколько запросов в одной транзакции выполняются как одна атомарная операция. А мультиверсионность помогает избежать блокировки таблиц.</p>
</li>
<li>
<p>Объектность. Таблица выступает фактически в виде класса, а ряды - в виде объектов, так же как классы могут наследоваться, так и таблицы могут наследоваться.</p>
</li>
<li>
<p>Система привилегий операций с таблицами, схожа с системой по принципу с Oracle.</p>
</li>
<li>
<p>Репликации, т.е. использование нескольких серверов даёт масштабируемость.</p>
</li>
</ol>
<p>Переход на PostgreSQL как правило связан с обработкой больших объемов данных - когда число рядов переваливает миллион, то mysql начинает испытывать трудности, а <a href=http://en.wikipedia.org/wiki/Join_(SQL) target=_blank rel="noopener noreferrer">Natural Join</a> нескольких таких таблиц может привести вообще к падению сервера. Да и <a href=http://tweakers.net/reviews/657/6 target=_blank rel="noopener noreferrer">тесты на параллельность</a> поддерживают Postgre. Энтузиастам может быть интересна же не столь масштабируемость, сколько объектность, позволяющая большую свободу, или если хотите - сложность, по сравнению с mysql.</p>
<p>При переходе из mysql, следует отметить различия, которые естественно следует предусмотреть:</p>
<ul>
<li>Различные <a href=http://www.postgresql.org/docs/7.4/interactive/datatype.html target=_blank rel="noopener noreferrer">типы данных</a>. Нет datetime, зато есть возможность создать тучу своих типов.</li>
<li>Отсутсвие <em>autoincrement</em>. Такая функция заменена наличием <strong>sequence</strong>, и в <a href="http://phpclub.ru/faq/wakka.php?wakka=PostgresMigrationMysqlAutoincrement" target=_blank rel="noopener noreferrer">упрощённом виде</a> может использоваться так:<br>
<code>CREATE TABLE mynewtable (   id SERIAL   }   </code></li>
<li>pgAdmin III очень удобная консольная программа, а в качестве замены <a href=http://www.phpmyadmin.net/ target=_blank rel="noopener noreferrer">phpMyAdmin</a> есть <a href=http://phppgadmin.sourceforge.net/ target=_blank rel="noopener noreferrer">phpPgAdmin</a></li>
<li>Аналогом DATE_FORMAT является <a href=http://www.postgresql.org/docs/current/interactive/functions-formatting.html target=_blank rel="noopener noreferrer">to_char</a></li>
<li>Заглавные буквы в названиях таблиц и полей <a href=http://archives.postgresql.org/pgsql-bugs/2006-11/msg00146.php target=_blank rel="noopener noreferrer">по умолчанию переводятся</a> в нижний регистр, это можно обойти используя двойные кавычки</li>
<li>Форматом для LIMIT конструкции стал также поддерживаемый с mysql 4<code>LIMIT # OFFSET #</code></li>
<li>Просмотр запущенных процессов реализуется аналогом<br>
<code>--show processlisе``SELECT * from pg_stat_activity ;</code></li>
</ul>
<p>Читайте также:</p>
<ul>
<li><a href=http://valera.ws/2007.09.04~postgresql-vs-mysql/ target=_blank rel="noopener noreferrer">Субъективная разница Postgre и MySQL<br>
</a></li>
<li><a href=http://valera.ws/2008.07.24~calc-found-rows-in-postgresql/ target=_blank rel="noopener noreferrer">Замена SQL_CALC_FOUND_ROWS</a> из MySQL в Postgre</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class=col><b>Теги:</b><ul class="tags_BNPU padding--none margin-left--sm"><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/backend>backend</a><li class=tag_wFKI><a class="tag_mxxo tagRegular_OVld" href=/blog/tags/db>db</a></ul></div></footer></article><nav class=pagination-nav aria-label="Навигация по ст�ранице списка блогов"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title>Короткие мысли</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://www.tiktok.com/@artkurapov target=_blank rel="noopener noreferrer" class=footer__link-item>TikTok<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://twitter.com/tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Twitter<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.threads.com/@tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Threads<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://t.me/+4kDpExZlraQ0NGZk target=_blank rel="noopener noreferrer" class=footer__link-item>Telegram<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://bsky.app/profile/tot-ra.bsky.social target=_blank rel="noopener noreferrer" class=footer__link-item>Bluesky<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://vk.com/artkurapov target=_blank rel="noopener noreferrer" class=footer__link-item>ВКонтакте<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://tot-ra.livejournal.com/ target=_blank rel="noopener noreferrer" class=footer__link-item>ЖЖ<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div><div class="col footer__col"><div class=footer__title>Business</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://www.linkedin.com/in/kurapov/ target=_blank rel="noopener noreferrer" class=footer__link-item>LinkedIn<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://github.com/tot-ra target=_blank rel="noopener noreferrer" class=footer__link-item>GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://medium.com/@tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Medium<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href="https://stackoverflow.com/users/158448/artjom-kurapov?tab=profile" target=_blank rel="noopener noreferrer" class=footer__link-item>Stack Overflow<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.slideshare.net/totra/presentations target=_blank rel="noopener noreferrer" class=footer__link-item>Slideshare<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://habr.com/ru/users/tot_ra/posts/ target=_blank rel="noopener noreferrer" class=footer__link-item>Habr<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div><div class="col footer__col"><div class=footer__title>Community</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://www.youtube.com/user/artkurapov/ target=_blank rel="noopener noreferrer" class=footer__link-item>Long videos on Youtube<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.twitch.tv/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Streams on Twitch<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.instagram.com/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Природа в Instagram<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.facebook.com/artkurapov target=_blank rel="noopener noreferrer" class=footer__link-item>Facebook<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.reddit.com/user/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Reddit<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div><div class="col footer__col"><div class=footer__title>Multimedia</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://suno.com/@tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Music on Suno<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://goodreads.com/tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Books on Goodreads<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://steamcommunity.com/id/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Games on Steam<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://open.spotify.com/user/1176479585 target=_blank rel="noopener noreferrer" class=footer__link-item>Music on Spotify<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://soundcloud.com/tot_ra target=_blank rel="noopener noreferrer" class=footer__link-item>Music on Soundcloud<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.thingiverse.com/tot_ra/designs target=_blank rel="noopener noreferrer" class=footer__link-item>3D models on Thingiverse<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://www.pinterest.com/tot_ra/ target=_blank rel="noopener noreferrer" class=footer__link-item>Pinterest<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_gbbH><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright © 2025</div></div></div></footer></div>