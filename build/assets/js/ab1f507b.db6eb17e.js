"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[84831],{18873:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>a,toc:()=>h});var i=n(74848),t=n(28453);const r={},o="Why",a={permalink:"/blog/Dream of scalable & enriched graphql-subscriptions",editUrl:"https://github.com/tot-ra/kurapov.ee/tree/main/blog/Dream of scalable & enriched graphql-subscriptions.md",source:"@site/blog/Dream of scalable & enriched graphql-subscriptions.md",title:"Dream of scalable & enriched graphql-subscriptions",description:"https://miro.medium.com/max/1400/1Rvb94EOQA-BzsmYJ4TklGg.jpeg",date:"2024-10-22T20:50:16.860Z",tags:[],readingTime:11.16,hasTruncateMarker:!1,authors:[],frontMatter:{},unlisted:!1,prevItem:{title:"Homework sandboxes",permalink:"/blog/Homework sandboxes"},nextItem:{title:"Journey to a Federated GraphQL",permalink:"/blog/Journey to a Federated GraphQL"}},l={authorsImageUrls:[]},h=[{value:"<strong>Risks</strong>",id:"risks",level:2},{value:"<strong>gophers</strong>",id:"gophers",level:2},{value:"<strong>Gqlgen</strong>",id:"gqlgen",level:2},{value:"<strong>Final architecture</strong>",id:"final-architecture",level:2},{value:"<strong>Subscription schema types</strong>",id:"subscription-schema-types",level:2},{value:"<strong>Live queries</strong>",id:"live-queries",level:2},{value:"<strong>In defence of GraphQL</strong>",id:"in-defence-of-graphql",level:2}];function c(e){const s={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",img:"img",li:"li",p:"p",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/1400/1*Rvb94EOQA-BzsmYJ4TklGg.jpeg",alt:"https://miro.medium.com/max/1400/1*Rvb94EOQA-BzsmYJ4TklGg.jpeg"})}),"\n",(0,i.jsx)(s.p,{children:"Stylized photo of Jagala juga (Estonia), original photo by Aleksandr Abrosimov, Wikimedia Commons"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.a,{href:"https://medium.com/pipedrive-engineering/journey-to-federated-graphql-2a6f2eecc6a4",children:"Last time"}),", I wrote about 5-year long journey of having GraphQL in Pipedrive. Now, let me tell you about a 10-year long journey of delivering websocket events to frontend.. and maybe help you out with it too."]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/1400/1*xffiu2fshUMbBFm-JlSAGw.gif",alt:"https://miro.medium.com/max/1400/1*xffiu2fshUMbBFm-JlSAGw.gif"})}),"\n",(0,i.jsxs)(s.p,{children:["The\xa0",(0,i.jsx)(s.strong,{children:"product need"}),"\xa0of asynchronous events comes up any time user needs to be notified about something by the server."]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"you\u2019ve got an instant message"}),"\n",(0,i.jsx)(s.li,{children:"uploaded image has finished resizing"}),"\n",(0,i.jsx)(s.li,{children:"your colleague has changed an avatar"}),"\n",(0,i.jsx)(s.li,{children:"your bulk change of 10k deals has progressed to 99%"}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["So, async events\xa0",(0,i.jsx)(s.strong,{children:"enrich UX with details & interactivity"})]}),"\n",(0,i.jsxs)(s.p,{children:["But most importantly, they solve a problem of having\xa0",(0,i.jsx)(s.strong,{children:"inconsistent data"}),"\xa0displayed or stored on the browser side. Without such updates, other user won\u2019t see\xa0",(0,i.jsx)(s.em,{children:"Pipedrive deals renames"}),"; another browser tab won\u2019t receive\xa0",(0,i.jsx)(s.em,{children:"activities deleted"}),". Even in the same browser tab, your views may not talk well with each other, lacking single storage and be out-of sync."]}),"\n",(0,i.jsx)(s.h1,{id:"historical-dive",children:(0,i.jsx)(s.strong,{children:"Historical dive"})}),"\n",(0,i.jsxs)(s.p,{children:["Luckily, Pipedrive has \u201csolved\u201d this issue 10 years ago. In 2012\xa0",(0,i.jsx)(s.a,{href:"https://www.linkedin.com/in/andris-reinman/",children:"Andris"}),",\xa0",(0,i.jsx)(s.a,{href:"https://www.linkedin.com/in/martinkapp/",children:"Kapp"}),"\xa0&\xa0",(0,i.jsx)(s.a,{href:"https://www.linkedin.com/in/martintajur/",children:"Tajur"}),"\xa0have developed a\xa0",(0,i.jsx)(s.strong,{children:"socketqueue"}),"\xa0service, which to this day transports API events to the front-end leveraging\xa0",(0,i.jsx)(s.a,{href:"https://www.npmjs.com/package/sockjs",children:"sockjs"}),"\xa0library."]}),"\n",(0,i.jsxs)(s.p,{children:["Tajur\u2019s talk in 2016 was one of the reasons I\u2019ve re-created similar setup, got puzzled how I should manage user connections with\xa0",(0,i.jsx)(s.a,{href:"https://socket.io/",children:"socket.io"}),"\xa0& scale it beyond one server and ultimately joined Pipedrive to find out. I was fascinated by event streaming and the possibilities it brings."]}),"\n",(0,i.jsxs)(s.p,{children:["As you can see, his talk is more about\xa0",(0,i.jsx)(s.a,{href:"https://www.rabbitmq.com/",children:"RabbitMQ"}),"\xa0\u2014 a message broker that stands between php monolith and socketqueue."]}),"\n",(0,i.jsx)(s.h1,{id:"pros-and-cons",children:(0,i.jsx)(s.strong,{children:"Pros and cons"})}),"\n",(0,i.jsx)(s.p,{children:"In-memory queues have allowed Pipedrive to withstand bursts of events, triggered by external integrations or in-house things like deal import from xls file or a bulk edit."}),"\n",(0,i.jsxs)(s.p,{children:["Api event that is pushed to the RabbitMQ and to the frontend is\xa0",(0,i.jsx)(s.strong,{children:"denormalized"}),", having different entities. That\u2019s good, because you have a\xa0",(0,i.jsx)(s.strong,{children:"consistent snapshot"}),"\xa0of multiple things at the same time and you recipients\xa0",(0,i.jsx)(s.strong,{children:"don\u2019t need to re-query"}),"\xa0anything\u2026"]}),"\n",(0,i.jsxs)(s.p,{children:["But it is also hugely\xa0",(0,i.jsx)(s.strong,{children:"inefficient"}),", as all browser tabs receive all possible changes, wether they want it or not, sometimes having reached 80GB per day of traffic for a single customer.. while web app on his laptop CPU is doing all of the heavy filtering."]}),"\n",(0,i.jsx)(s.p,{children:"So we can\u2019t keep infinitely bloating event schema, making it even heavier."}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/1400/1*SEK3NXeBwKWHvw4fgcbVBg.png",alt:"https://miro.medium.com/max/1400/1*SEK3NXeBwKWHvw4fgcbVBg.png"})}),"\n",(0,i.jsx)(s.p,{children:"Cell logic as number in a web-socket URL"}),"\n",(0,i.jsxs)(s.p,{children:["Second problem is a\xa0",(0,i.jsx)(s.strong,{children:"noisy neighbour"}),". Scalability, as I mentioned, is solved with \u201ccell logic\u201d (in a good scenario \u2014 aka tenant isolation) which means sharding socketqueue application servers by company ID. This also means that we must have\xa0",(0,i.jsx)(s.strong,{children:"fixed amount of containers"}),"\xa0and fixed amount of queues to ensure predictable routing."]}),"\n",(0,i.jsxs)(s.p,{children:["So problem arises whenever you have one company generating thousands of events \u2014 they are not distributed among all servers, instead they\xa0",(0,i.jsx)(s.strong,{children:"spike CPU"}),"\xa0of a single node to the point of health check failure. There isn\u2019t any room to vertically grow single-core CPU, only to double amount of servers which means\xa0",(0,i.jsx)(s.strong,{children:"wasted infrastructure resources"}),"."]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/1400/1*2pcMt6Bjn_pgBLO9CLjjOA.png",alt:"https://miro.medium.com/max/1400/1*2pcMt6Bjn_pgBLO9CLjjOA.png"})}),"\n",(0,i.jsx)(s.p,{children:"noisy neighbour CPU spike of particular pod"}),"\n",(0,i.jsxs)(s.p,{children:["Third issue is\xa0",(0,i.jsx)(s.strong,{children:"visibility & tracing"}),". Same as with REST API, without proper documentation (wether it is swagger or type definitions), it is very hard to understand what can be inside of the event schema and most important, who uses what in case you want to do a breaking change. Which leads to a vicious cycle of nobody removing anything from the event & bloating it even more."]}),"\n",(0,i.jsxs)(s.p,{children:["Finally, if web-socket connection is down because user went into a tunnel or just closed his laptop \u2014 he may loose events. Could that cause a loss of\xa0",(0,i.jsx)(s.em,{children:"a deal"}),"\xa0and profits for the user?"]}),"\n",(0,i.jsx)(s.p,{children:"Over the years we\u2019ve optimized the hell out of socketqueue, so its"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"multi-threaded as it listens queues and WS connection handling"}),"\n",(0,i.jsx)(s.li,{children:"compresses traffic"}),"\n",(0,i.jsx)(s.li,{children:"checks permissions & visibility"}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"but what if we could do better..? \ud83e\udd14"}),"\n",(0,i.jsx)(s.h1,{id:"how",children:(0,i.jsx)(s.strong,{children:"How"})}),"\n",(0,i.jsxs)(s.p,{children:["Idea behind\xa0",(0,i.jsx)(s.a,{href:"https://spec.graphql.org/June2018/#sec-Subscription-Operation-Definitions",children:"graphql subscriptions"}),"\xa0is pretty simple \u2014 you declare only what you want to receive, given some filtering arguments. And it will be server\u2019s job to intelligently filter events."]}),"\n",(0,i.jsxs)(s.p,{children:["I can\u2019t do a better job of explaining basic setup than\xa0",(0,i.jsx)(s.a,{href:"https://twitter.com/benawad",children:"Ben"}),"\xa0here \ud83d\ude01. So what he shows here is a single server instance where pubsub is just in-memory event routing directly from mutation. But in our case there are no mutations \u2014 real changes are generated by the php legacy far-far away."]}),"\n",(0,i.jsx)(s.h1,{id:"mission-scope",children:(0,i.jsx)(s.strong,{children:"Mission scope"})}),"\n",(0,i.jsx)(s.p,{children:"So what I wanted to achieve was"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"demo graphql subscriptions in production, having explicit schema"}),"\n",(0,i.jsx)(s.li,{children:"test horizontal pod scaling"}),"\n",(0,i.jsx)(s.li,{children:"increase reliability by using kafka instead of rabbitMq"}),"\n",(0,i.jsx)(s.li,{children:"use small, normalized, domain events to keep things simple"}),"\n",(0,i.jsx)(s.li,{children:"keep event delivery latency below 2 sec [to not be slower than socketqueue we\u2019re trying to replace]"}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"risks",children:(0,i.jsx)(s.strong,{children:"Risks"})}),"\n",(0,i.jsx)(s.p,{children:"What I didn\u2019t know.."}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"how do we authenticate?"}),"\n",(0,i.jsxs)(s.li,{children:["what protocol should we use? SSE? WS? whats this\xa0",(0,i.jsx)(s.a,{href:"https://github.com/dunglas/mercure",children:"mercure"}),"\xa0thing.. and does some of it fallback to pooling?"]}),"\n",(0,i.jsx)(s.li,{children:"will WS/TCP connections be bound to same pod or not?"}),"\n",(0,i.jsx)(s.li,{children:"can we do multiple subscriptions at a time?"}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/3920/1*K-aB3FKXH0jXeG4HiLRdVw.png",alt:"https://miro.medium.com/max/3920/1*K-aB3FKXH0jXeG4HiLRdVw.png"})}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/4004/1*5q23Z56at20SsvRkOB_6Hw.png",alt:"https://miro.medium.com/max/4004/1*5q23Z56at20SsvRkOB_6Hw.png"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"what storage / transfer medium do we use? DB? redis streams? kafka? redis pubsub? KTable?"}),"\n",(0,i.jsx)(s.li,{children:"can we rewind events in time in case user got disconnected? would we need to store cursor ID per entity? also, how does live query work?"}),"\n",(0,i.jsx)(s.li,{children:"how do we filter events by company, user, session, entity? is there a standard for subscription filter fields?"}),"\n",(0,i.jsxs)(s.li,{children:["can we re-use federated graphql schema? can we enrich events? what should be QoS / retry logic if gateway is down? Lee Byron went into it at depth\xa0",(0,i.jsx)(s.a,{href:"https://youtu.be/rapO30fpREg?t=6675",children:"in his talk over 5 years ago"}),"."]}),"\n",(0,i.jsx)(s.li,{children:"how many items can we subscribe to?"}),"\n",(0,i.jsx)(s.li,{children:"how do we unsubscribe? or disconnect users when they log out?"}),"\n"]}),"\n",(0,i.jsx)(s.h1,{id:"proof-of-concept",children:(0,i.jsx)(s.strong,{children:"Proof of concept"})}),"\n",(0,i.jsxs)(s.p,{children:["Before the mission, I made a simple node service that connected to kafka and proxied events without any filtering. This was already promising. But for a mission I wanted to try out\xa0",(0,i.jsx)(s.a,{href:"https://go.dev/",children:(0,i.jsx)(s.em,{children:(0,i.jsx)(s.strong,{children:"go"})})}),"\xa0to have all CPUs to be involved to maximize that efficiency, while this PoC was a fallback (that proved itself very useful)"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/2256/1*8i540taseWXr_TAV2ysBZw.png",alt:"https://miro.medium.com/max/2256/1*8i540taseWXr_TAV2ysBZw.png"})}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/4952/1*z39G_eYPNR7Zuu_Hl1dK7g.png",alt:"https://miro.medium.com/max/4952/1*z39G_eYPNR7Zuu_Hl1dK7g.png"})}),"\n",(0,i.jsx)(s.h1,{id:"liftoff",children:(0,i.jsx)(s.strong,{children:"Liftoff"})}),"\n",(0,i.jsxs)(s.p,{children:["Four of us (",(0,i.jsx)(s.a,{href:"https://www.linkedin.com/in/kurapov/",children:"myself"}),",\xa0",(0,i.jsx)(s.a,{href:"https://www.linkedin.com/in/pavel-nikolajev-84184a64/",children:"Pavel"}),",\xa0",(0,i.jsx)(s.a,{href:"https://www.linkedin.com/in/kristjan-luik-89bb03122/",children:"Kristjan"}),"\xa0and\xa0",(0,i.jsx)(s.a,{href:"https://www.linkedin.com/in/abhishek-goswami-591541b1/",children:"Hiro"}),") have set off for entire summer to try and do just that.. explore the unknown \ud83d\udef8 and bring value back to the launchpad."]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/1400/1*QlBXCk8EjRtp5n_Fxr2xTw.png",alt:"https://miro.medium.com/max/1400/1*QlBXCk8EjRtp5n_Fxr2xTw.png"})}),"\n",(0,i.jsx)(s.h2,{id:"gophers",children:(0,i.jsx)(s.strong,{children:"gophers"})}),"\n",(0,i.jsxs)(s.p,{children:["We looked into\xa0",(0,i.jsx)(s.a,{href:"https://github.com/graph-gophers/graphql-go",children:"graph-gophers/graphql-go"}),"\xa0as first basis and within couple of days we\u2019ve re-created PoC of subscribing to kafka events"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["We\u2019ve hit the dilemma of GraphQL integer spec\xa0",(0,i.jsx)(s.a,{href:"https://github.com/graphql/graphql-js/issues/292#issuecomment-186702912",children:"not matching go\u2019s int32"}),"."]}),"\n",(0,i.jsx)(s.li,{children:"Got per-property filtering and per-argument filtering working"}),"\n",(0,i.jsx)(s.li,{children:"Hit need of SSL for WSS to work, otherwise CORS blocked requests"}),"\n",(0,i.jsxs)(s.li,{children:["Got\xa0",(0,i.jsx)(s.a,{href:"http://nginx.org/en/docs/http/websocket.html",children:"nginx to proxy web socket requests"}),"!"]}),"\n",(0,i.jsxs)(s.li,{children:["We found that there are two transport protocols, as websocket is a loose tranport so any library can implement whatever it wants.\xa0",(0,i.jsx)(s.a,{href:"https://github.com/graph-gophers/graphql-transport-ws",children:"Gophers implemented"}),"\xa0older version, that was compliant with apollo & graphiql but not with graphql-ws"]}),"\n",(0,i.jsxs)(s.li,{children:["Hit issue that apollo federation lib did not like\xa0",(0,i.jsx)(s.code,{children:"Subscription"}),"\xa0in\xa0",(0,i.jsx)(s.a,{href:"https://github.com/pipedrive/graphql-schema-registry",children:"schema registration"}),". We figured that we can clean only Subscription type from root to have other types checked for collisions"]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"Basic filtering was pretty simple, you just need to connect two streams (channels) \u2014 kafka and web sockets (that gophers need as schema resolvers) while having a goroutine in the middle transforming data"}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/3712/1*zXxbPFcX5Xqu7zGz8k3kSw.png",alt:"https://miro.medium.com/max/3712/1*zXxbPFcX5Xqu7zGz8k3kSw.png"})}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/3668/1*0dXQgXJcVTET0AswerSujA.png",alt:"https://miro.medium.com/max/3668/1*0dXQgXJcVTET0AswerSujA.png"})}),"\n",(0,i.jsxs)(s.p,{children:["We\u2019ve hit a major\xa0",(0,i.jsx)(s.a,{href:"https://github.com/graph-gophers/graphql-transport-ws/pull/9",children:"roadblock with gophers"}),"\xa0and JWT authentication, we\u2019re not that experienced in\xa0",(0,i.jsx)(s.em,{children:"go"}),"\xa0& don\u2019t have much time to start changing a major framework."]}),"\n",(0,i.jsx)(s.p,{children:"We also figured that enrichment is not a priority, and we need to bring code into production \ud83d\ude80 and test scaling. Thats the agile way."}),"\n",(0,i.jsx)(s.p,{children:"Second big blocker \u2014 entity visibility checks. Reading domain events from kafka means that we don\u2019t have extra information, like who can see a deal. We need to query some service about this. Doing it on every event of every company likely can lead to DoS \ud83e\udd26\u200d\u2642\ufe0f"}),"\n",(0,i.jsx)(s.h2,{id:"gqlgen",children:(0,i.jsx)(s.strong,{children:"Gqlgen"})}),"\n",(0,i.jsx)(s.p,{children:"We scratch gophers, switch to gqlgen. Channel exchange logic remains the same and we get JWT token authentication working. Difference is that now subscription events are autogenerated based on schema.graphql."}),"\n",(0,i.jsx)(s.p,{children:"Next, I find that exchange (in-memory pub-sub in go) is kinda flawed, we need at least 1 subscription for streaming to take place.. newer version is a bit better and allows to have channel per-company."}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/2532/1*_tIlshM1g5F8tYgIN4qAfQ.png",alt:"https://miro.medium.com/max/2532/1*_tIlshM1g5F8tYgIN4qAfQ.png"})}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/2176/1*w6B9z69_upq05WXXb2Vt5Q.png",alt:"https://miro.medium.com/max/2176/1*w6B9z69_upq05WXXb2Vt5Q.png"})}),"\n",(0,i.jsx)(s.p,{children:"We also start brainstorming how schema should look like to have it scalable across different entitites, have filters, have multiple entity actions and multiple ids supported."}),"\n",(0,i.jsxs)(s.p,{children:["1 month in. We have UI working with hacked but performant permission check. We take vacations to cool off \ud83c\udf34 And only now I see this \ud83e\udd2f presentation by\xa0",(0,i.jsx)(s.a,{href:"https://twitter.com/mandiwise",children:"Mandi Wise"}),"\xa0from Apollo, even though I\u2019ve gone through most of youtube videos by that time.."]}),"\n",(0,i.jsx)(s.h2,{id:"final-architecture",children:(0,i.jsx)(s.strong,{children:"Final architecture"})}),"\n",(0,i.jsxs)(s.p,{children:["So we come back and scratch gqlgen again, it was painful but well.. agile. We split service in\xa0",(0,i.jsx)(s.strong,{children:"two"}),", adding redis pub-sub with replication and sentinel in between"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/1400/1*JDm6Oo8YfE1-r7lzttAyNQ.png",alt:"https://miro.medium.com/max/1400/1*JDm6Oo8YfE1-r7lzttAyNQ.png"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"graphql-subscription-workers remains in go, but becomes way simpler \u2014 it is be able to scale well to consume all kafka partitions. Workers filter out events by doing 10x parallel permissions checks and transform event schema if needed"}),"\n",(0,i.jsxs)(s.li,{children:["graphql-subscriptions deals with connections & scales horizontally as much as needed. It leverages great\xa0",(0,i.jsx)(s.a,{href:"https://github.com/enisdenjo/graphql-ws",children:"graphql-ws"}),"\xa0library that has all sorts of hooks, so kudos to\xa0",(0,i.jsx)(s.a,{href:"https://github.com/enisdenjo",children:"Denis Badurina"})]}),"\n",(0,i.jsx)(s.li,{children:"redis pub-sub serves as exchange broker doing most of the filtering & sharding by company, user and entity ids."}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["For example, worker pushes to message channel: ",(0,i.jsx)(s.code,{children:"<companyId>.deal.<dealId>"}),". This is very similar to rabbitMQ routing as it also provides regex wildcard matching by the subscribers. This allows us to theoretically subscribe to ",(0,i.jsx)(s.code,{children:"<companyId>.*"})," and handle all events if such need arises."]}),"\n",(0,i.jsx)(s.h2,{id:"subscription-schema-types",children:(0,i.jsx)(s.strong,{children:"Subscription schema types"})}),"\n",(0,i.jsx)(s.p,{children:"So as you can see from the diagram, we followed Mandi\u2019s advice and wrote event enrichment by querying gateway. This did require polling of federated schema and hard-coded resolvers of which query specific entity must make, but it gives immence flexibility to the frontend"}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/2376/1*zBOSyHn9wocWYbXR7r80gA.gif",alt:"https://miro.medium.com/max/2376/1*zBOSyHn9wocWYbXR7r80gA.gif"})}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/3504/1*dauu7v8ZBwU667SdCCBBnA.png",alt:"https://miro.medium.com/max/3504/1*dauu7v8ZBwU667SdCCBBnA.png"})}),"\n",(0,i.jsx)(s.p,{children:"Schema choices we had to make:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["we do not merge original event with enriched one, although we could. This is because we don\u2019t have guarantees that graphql-service responds in timely manner. Kafka \u201craw\u201d event data is much more reliable. We also have minor differences in schema when referencing is used (raw deal.stageId vs enriched ",(0,i.jsx)(s.a,{href:"http://deal.stage.id",children:"deal.stage.id"}),")"]}),"\n",(0,i.jsx)(s.li,{children:"we added \u201cdelta\u201d as JSON, mostly because frontend really wanted to use that in case frontend storage wanted to update only specific keys. This requires specific shape of kafka event though"}),"\n",(0,i.jsx)(s.li,{children:"we have a generic event type (dealEvent) along side with action-specific events (dealAdded), because generic events take into account correct order of events for the same entity ( added -> changed -> deleted ) which is not guaranteed chronologically if you subscribe to separate types"}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"live-queries",children:(0,i.jsx)(s.strong,{children:"Live queries"})}),"\n",(0,i.jsx)(s.p,{children:"This a cool concept that elegantly fixes a problem which I was really fixated on \u2014 connection loss."}),"\n",(0,i.jsxs)(s.p,{children:["From to\xa0",(0,i.jsx)(s.a,{href:"https://the-guild.dev/blog/subscriptions-and-live-queries-real-time-with-graphql",children:"Laurin\u2019s article"}),"\xa0by The Guild, we\u2019ve got same\xa0",(0,i.jsx)(s.strong,{children:"fetchOrSubscribe"}),"\xa0function which first does enrichment request and then subscribes to kafka events using async iterator magic. The difference however is in schema \u2014 we use \u201cliveQuery\u201d as an argument, not as a root property."]}),"\n",(0,i.jsxs)(s.p,{children:["This thing alone meets 99% of consistency requirements in web apps, without the need to rewind events (using\xa0",(0,i.jsx)(s.a,{href:"https://redis.io/docs/data-types/streams/",children:"redis streams"}),"?). So \u201ccursor-based query revalidation and diffing\u201d that\xa0",(0,i.jsx)(s.a,{href:"https://twitter.com/benjamn/status/1579891243798401026",children:"Ben Newman suggested at last Graphql Summit"}),"\xa0seems like a very rare use case where you want to rewind events as a niche product feature (in gaming?)"]}),"\n",(0,i.jsx)(s.h1,{id:"performance--security-testing",children:(0,i.jsx)(s.strong,{children:"Performance & security testing"})}),"\n",(0,i.jsx)(s.p,{children:"Finally, by the mission end we tested how well our solution scales in production, gradually rolling it out to real customers."}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{src:"https://miro.medium.com/max/1400/1*mHE_vMsNTPr25y7IkePG2Q.png",alt:"https://miro.medium.com/max/1400/1*mHE_vMsNTPr25y7IkePG2Q.png"})}),"\n",(0,i.jsx)(s.p,{children:"Performance testing in production"}),"\n",(0,i.jsxs)(s.p,{children:["This did reveal interesting things - if you subscribe to\xa0",(0,i.jsx)(s.em,{children:"deals"}),"\xa0by IDs\u2026 and if you do this in\xa0",(0,i.jsx)(s.em,{children:"pipeline view"}),"\xa0where user can scroll very fast, you can have waves of subscriptions. So better to avoid blocking permission checks onSubscribe and have some throttling logic on frontend."]}),"\n",(0,i.jsxs)(s.p,{children:["We have had also observed random pods suddenly loosing all of their connections, that has lead us to revise memory limits &\xa0",(0,i.jsx)(s.a,{href:"https://github.com/nodejs/node/issues/35573",children:"max_old_space_size bug"}),"."]}),"\n",(0,i.jsxs)(s.p,{children:["We have implemented various security limitations on amount of connections, subscriptions, timeouts, taking into account logouts, permission changes etc. Not only because of external risks, but also because we did find that Redis needs to do a lot of CPU to match\xa0",(0,i.jsx)(s.strong,{children:"pub"}),"lishers to\xa0",(0,i.jsx)(s.strong,{children:"sub"}),"scribers."]}),"\n",(0,i.jsx)(s.h1,{id:"future-steps",children:(0,i.jsx)(s.strong,{children:"Future steps"})}),"\n",(0,i.jsx)(s.p,{children:"Theoretically, we could shard Redis instances by entity types if we would face performance problems."}),"\n",(0,i.jsxs)(s.p,{children:["We could force socketqueue deprecation by\xa0",(0,i.jsx)(s.em,{children:"temporarily"}),"\xa0adding api events as a universal subscription, proxying all data to the frontend without any filtering. Sacrifice efficiency for the sake of having single transport layer."]}),"\n",(0,i.jsx)(s.p,{children:"We have had service operational for over a year now and so far got ~10 entities supported, tied to different kafka topics"}),"\n",(0,i.jsx)(s.h2,{id:"in-defence-of-graphql",children:(0,i.jsx)(s.strong,{children:"In defence of GraphQL"})}),"\n",(0,i.jsx)(s.p,{children:"Adoption of GraphQL and subscriptions in particular is seen as slow, although it is voluntary."}),"\n",(0,i.jsxs)(s.p,{children:["With\xa0",(0,i.jsx)(s.a,{href:"https://youtu.be/UZWe5Usun7I?t=4130",children:"codegen"}),"\xa0that can wrap REST API, it can be seen as complex, without \u2014 as too demanding of service refactoring, alongside a REST API \u2014 as redundant, with\xa0",(0,i.jsx)(s.a,{href:"https://www.apollographql.com/docs/federation/",children:"federation"}),"\xa0\u2014 as having too many layers, with\xa0",(0,i.jsx)(s.a,{href:"https://github.com/graphql/dataloader",children:"dataloader"}),"\xa0but without observability \u2014 as doing\xa0",(0,i.jsx)(s.a,{href:"https://twitter.com/Popeska/status/1592177670212943873",children:"too many poorly batched RPC calls"}),"."]}),"\n",(0,i.jsxs)(s.p,{children:["Return on investment is not seen, if\xa0",(0,i.jsx)(s.em,{children:"value"}),"\xa0is not measured."]}),"\n",(0,i.jsxs)(s.p,{children:["GraphQL has taken onto itself a big responsibility of making web more transparent, predictable, reusable and more efficient. I urge developers \ud83c\udf1e to have professional patience \u2014 educate your colleagues, deliver\xa0",(0,i.jsx)(s.strong,{children:"hard metrics"}),"\xa0to managers, proving GraphQL superiority."]}),"\n",(0,i.jsx)(s.p,{children:"My dream is that there will come a day when devs will replace schema-less WS events & REST APIs with GraphQL and subscriptions for anyone to consume. Clients are our future, this is the way"})]})}function d(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},28453:(e,s,n)=>{n.d(s,{R:()=>o,x:()=>a});var i=n(96540);const t={},r=i.createContext(t);function o(e){const s=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),i.createElement(r.Provider,{value:s},e.children)}}}]);